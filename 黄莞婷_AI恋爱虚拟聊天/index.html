<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÅãÁà±ÈìÉ - Âä®Êº´È£éÊ†ºËÅäÂ§©Â∫îÁî®</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --sakura-pink: #ffb7c5;
            --sakura-pink-dark: #ff9aad;
            --pastel-purple: #d6c2e9;
            --pastel-blue: #b5d8eb;
            --pastel-green: #c7e9c0;
            --pastel-yellow: #f9e9b0;
            --pastel-magenta: #f4b8e4;
            --pastel-cyan: #b3e8e5;
        }
        
        @font-face {
            font-family: 'AnimeFont';
            src: url('https://fonts.cdnfonts.com/s/15360/AnimeAce.woff') format('woff');
        }
        
        body {
            font-family: 'AnimeFont', 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #e6f3ff 0%, #f0f0ff 30%, #fff0f7 70%, #f0fff7 100%);
            color: #555;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
            /* Performance optimizations */
            contain: layout style;
            transform: translateZ(0); /* Create a stacking context */
        }
        
        .anime-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-image: url('https://images.unsplash.com/photo-1490750967868-88aa4486c946?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');
            background-size: cover;
            opacity: 0.1;
            filter: blur(2px);
        }
        
        .floating-petal {
            position: absolute;
            background-image: url('https://www.freepnglogos.com/uploads/petal-png/petal-png-15.png');
            background-size: contain;
            background-repeat: no-repeat;
            pointer-events: none;
            animation: float 20s linear infinite;
            opacity: 0.5;
            z-index: -1;
            filter: drop-shadow(0 0 5px rgba(255, 182, 193, 0.3));
            will-change: transform, opacity;
            transform: translateZ(0); /* Force hardware acceleration */
            backface-visibility: hidden; /* Optimize rendering */
        }
        
        @keyframes float {
            0% {
                transform: translateY(0) rotate(0deg) translateZ(0);
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg) translateZ(0);
                opacity: 0;
            }
        }
        
        .glass-card {
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.25);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .main-title {
            background: linear-gradient(to right, var(--sakura-pink), var(--pastel-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            text-shadow: 0px 4px 8px rgba(0,0,0,0.1);
            font-size: 3.5rem;
            letter-spacing: 1px;
        }
        
        .main-title-luxury {
            background: linear-gradient(45deg, 
                #ff69b4 0%, 
                #ff1493 25%, 
                #ffb6c1 50%, 
                #ff69b4 75%, 
                #ff1493 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 300;
            font-size: 4.5rem;
            letter-spacing: 4px;
            text-shadow: 
                0 0 20px rgba(255, 105, 180, 0.6),
                0 0 40px rgba(255, 20, 147, 0.4),
                0 0 60px rgba(255, 182, 193, 0.3),
                0 0 80px rgba(255, 105, 180, 0.2);
            position: relative;
            animation: titleGlow 3s ease-in-out infinite;
            margin-bottom: 2rem;
        }
        
        .main-title-luxury::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            background: linear-gradient(45deg, 
                rgba(255, 107, 157, 0.1) 0%, 
                rgba(196, 69, 105, 0.1) 25%, 
                rgba(248, 181, 211, 0.1) 50%, 
                rgba(255, 159, 243, 0.1) 75%, 
                rgba(255, 107, 157, 0.1) 100%);
            border-radius: 20px;
            z-index: -1;
            filter: blur(20px);
        }
        
        @keyframes titleGlow {
            0%, 100% {
                text-shadow: 
                    0 0 20px rgba(255, 105, 180, 0.6),
                    0 0 40px rgba(255, 20, 147, 0.4),
                    0 0 60px rgba(255, 182, 193, 0.3),
                    0 0 80px rgba(255, 105, 180, 0.2);
            }
            50% {
                text-shadow: 
                    0 0 30px rgba(255, 105, 180, 0.8),
                    0 0 50px rgba(255, 20, 147, 0.6),
                    0 0 70px rgba(255, 182, 193, 0.4),
                    0 0 90px rgba(255, 105, 180, 0.3),
                    0 0 110px rgba(255, 20, 147, 0.2);
            }
        }
        
        .btn-anime {
            background: linear-gradient(135deg, #ff69b4 0%, #ff1493 50%, #ffb6c1 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 300;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 105, 180, 0.4);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            min-width: 200px;
        }
        
        .btn-anime:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 105, 180, 0.5);
        }
        
        .btn-anime:active {
            transform: translateY(1px);
        }
        
        .btn-anime::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: 0.3s;
        }
        
        .btn-anime:hover::before {
            left: 100%;
        }
        
        .btn-anime::after {
            content: "";
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff69b4, #ff1493, #ffb6c1, #ff69b4);
            border-radius: 27px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
            filter: blur(8px);
        }
        
        .btn-anime:hover::after {
            opacity: 0.6;
        }
        
        .flower-icon {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        /* Home Page Character Gallery Styles */
        .character-gallery-home {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            margin: 2rem 0;
            flex-wrap: nowrap;
            padding: 0 20px;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
            position: relative;
        }
        
        .character-gallery-home::-webkit-scrollbar {
            display: none;
        }
        
        /* Ê∑ªÂä†ÊªëÂä®ÊèêÁ§∫ */
        .character-gallery-home::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(90deg, rgba(255, 107, 157, 0.8), transparent);
            border-radius: 50%;
            opacity: 0.6;
            animation: slideHint 2s ease-in-out infinite;
            z-index: 1;
            pointer-events: none;
        }
        
        .character-gallery-home::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 30px;
            background: linear-gradient(-90deg, rgba(255, 107, 157, 0.8), transparent);
            border-radius: 50%;
            opacity: 0.6;
            animation: slideHint 2s ease-in-out infinite reverse;
            z-index: 1;
            pointer-events: none;
        }
        
        @keyframes slideHint {
            0%, 100% {
                opacity: 0.3;
                transform: translateY(-50%) scale(0.8);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-50%) scale(1.1);
            }
        }
        
        .character-panel-home {
            width: 140px;
            height: 360px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        
        @media (max-width: 1200px) {
            .character-gallery-home {
                gap: 15px;
            }
            
            .character-panel-home {
                width: 130px;
                height: 330px;
            }
            
            .character-silhouette-home {
                width: 130px;
                height: 290px;
            }
            
            .main-title-luxury {
                font-size: 4rem;
            }
        }
        
        @media (max-width: 768px) {
            .character-gallery-home {
                gap: 12px;
                margin: 1.5rem 0;
            }
            
            .character-panel-home {
                width: 120px;
                height: 300px;
            }
            
            .character-silhouette-home {
                width: 120px;
                height: 260px;
            }
            
            .character-name-below {
                font-size: 18px;
            }
            
            .main-title-luxury {
                font-size: 3.5rem;
            }
            
            .btn-anime {
                padding: 12px 25px;
                font-size: 16px;
                min-width: 180px;
            }
        }
        
        @media (max-width: 480px) {
            .character-gallery-home {
                gap: 10px;
            }
            
            .character-panel-home {
                width: 110px;
                height: 280px;
            }
            
            .character-silhouette-home {
                width: 110px;
                height: 240px;
            }
            
            .character-name-below {
                font-size: 16px;
            }
            
            .main-title-luxury {
                font-size: 3rem;
            }
            
            .btn-anime {
                padding: 10px 20px;
                font-size: 14px;
                min-width: 160px;
            }
            
            .message-icon-top-left {
                top: 15px;
                left: 15px;
            }
            
            .message-icon-btn {
                width: 45px;
                height: 45px;
                font-size: 16px;
            }
        }
        
        .character-panel-home:hover .character-silhouette-home {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 12px 30px rgba(150, 100, 255, 0.4);
            border-color: rgba(150, 100, 255, 0.8);
        }
        
        .character-panel-home:hover .character-name-below {
            opacity: 1;
            transform: translateY(0);
            color: #9ca3af;
            text-shadow: 
                0 2px 8px rgba(156, 163, 175, 0.5),
                0 0 12px rgba(156, 163, 175, 0.4),
                0 0 16px rgba(156, 163, 175, 0.3);
        }
        
        .character-panel-home {
            animation: fadeInUp 0.6s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .character-silhouette-home {
            width: 140px;
            height: 320px;
            background-size: cover;
            background-position: center top;
            background-repeat: no-repeat;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            overflow: hidden;
            background-color: transparent;
            transition: all 0.4s ease;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .character-bg-lorenzo {
            background-image: url('./È°æÊôØÊ∑±.png');
        }
        
        .character-bg-dylan {
            background-image: url('./ÁôΩÊüØ.png');
        }
        
        .character-bg-nate {
            background-image: url('./ËÆ∏Ë®Ä.png');
        }
        
        .character-bg-asher {
            background-image: url('./Â§èÂÖâÊ¥õ.png');
        }
        
        .character-bg-shenzhihua {
            background-image: url('./Ê≤àÁü•Áîª.png');
        }
        
        .character-bg-yangyingge {
            background-image: url('./Êù®Ëã±Ê†º.png');
        }
        
        .character-bg-anyu {
            background-image: url('./ÂÆâÂÆá.png');
        }
        
        .character-bg-xieshuqi {
            background-image: url('./Ë∞¢‰π¶Á•∫.png');
        }
        
        .character-bg-luzeyan {
            background-image: url('./ÈôÜÂàôË°ç.png');
        }
        
        .character-bg-suyan {
            background-image: url('./ËãèÁ†ö.png');
        }
        
        .character-bg-wenyanzhou {
            background-image: url('./Ê∏©Á†öËàü.png');
        }
        
        .character-bg-fuye {
            background-image: url('./ÂÇÖÈáé.png');
        }
        
        .glow-effect-home {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            opacity: 0;
            pointer-events: none;
        }
        
        @keyframes glowPulse {
            0%, 100% {
                opacity: 0.5;
            }
            50% {
                opacity: 0.8;
            }
        }
        

        
        .character-name-below {
            font-size: 20px;
            font-weight: 300;
            font-family: 'Noto Sans SC', 'Microsoft YaHei', 'PingFang SC', sans-serif;
            color: #d1d5db;
            text-align: center;
            margin-top: 8px;
            text-shadow: 
                0 1px 2px rgba(209, 213, 219, 0.4),
                0 2px 4px rgba(255, 255, 255, 0.8),
                0 0 8px rgba(209, 213, 219, 0.3);
            letter-spacing: 1px;
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }
        
        .character-name-below::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, 
                rgba(255, 255, 0, 0.1) 0%, 
                rgba(255, 215, 0, 0.1) 50%, 
                rgba(255, 255, 0, 0.1) 100%);
            z-index: -1;
            border-radius: 4px;
            filter: blur(1px);
        }
        
        .below-characters-section {
            margin-top: 0.5rem;
            text-align: center;
        }
        
        .below-characters-section p {
            font-size: 1.3rem;
            color: #a052a0;
            margin-bottom: 1.5rem;
            font-weight: 300;
            text-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Message Icon in Top Left */
        .message-icon-top-left {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        .message-icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 105, 180, 0.9), rgba(255, 20, 147, 0.9));
            border: 2px solid rgba(255, 255, 255, 0.8);
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 105, 180, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }
        
        .message-icon-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.5);
            border-color: rgba(255, 255, 255, 1);
        }
        
        .message-icon-btn::after {
            content: "";
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #ff69b4, #ff1493, #ffb6c1, #ff69b4);
            border-radius: 50%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
            filter: blur(10px);
        }
        
        .message-icon-btn:hover::after {
            opacity: 0.7;
        }
        
        /* Home page background effects */
        #homepage::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 182, 193, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 182, 193, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(255, 182, 193, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        #homepage::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='1'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
            z-index: -1;
        }
        
        .character-card {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .character-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .character-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            object-fit: cover;
            transition: all 0.3s ease;
        }
        
        .character-card:hover .character-avatar {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .character-name {
            font-weight: 600;
            margin-top: 10px;
            font-size: 1.2rem;
        }
        
        .character-type {
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.7);
            padding: 3px 10px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 5px;
        }
        
                 .message-preview {
             background: rgba(255, 255, 255, 0.8);
             padding: 10px 15px;
             border-radius: 12px;
             font-size: 0.9rem;
             margin-top: 10px;
             max-width: 200px;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             display: -webkit-box;
             -webkit-line-clamp: 2;
             line-clamp: 2;
             -webkit-box-orient: vertical;
         }
        
        .unread-badge {
            background: linear-gradient(135deg, var(--sakura-pink), var(--sakura-pink-dark));
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            margin-top: 5px;
        }
        
        .nav-buttons {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }
        
        .nav-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .nav-button img {
            width: 30px;
            height: 30px;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.1));
        }
        
                 /* Chat List Page Styles */
         #chat-list-page {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533a71 75%, #8b5a8c 100%);
             opacity: 0;
             pointer-events: none;
             transition: all 0.5s ease;
             z-index: 100;
             overflow: hidden;
         }
         
         #chat-list-page.active {
             opacity: 1;
             pointer-events: all;
         }
         
         .chat-list-bg {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #533a71 75%, #8b5a8c 100%);
             opacity: 1;
         }
         
         .chat-list-overlay {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: 
                 radial-gradient(ellipse at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                 radial-gradient(ellipse at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                 radial-gradient(ellipse at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
         }
         
         .stars {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-image: 
                 radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                 radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                 radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                 radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                 radial-gradient(2px 2px at 160px 30px, #fff, transparent);
             background-repeat: repeat;
             background-size: 200px 100px;
             animation: sparkle 6s linear infinite;
         }
         
         @keyframes sparkle {
             0% { opacity: 0.7; }
             50% { opacity: 1; }
             100% { opacity: 0.7; }
         }
        
        .chat-list-content {
            position: relative;
            width: 100%;
            max-width: 900px;
            padding: 30px;
            z-index: 10;
        }
        
        .chat-list-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
                 .chat-list-title {
             font-size: 4rem;
             color: white;
             text-shadow: 0 4px 20px rgba(255,255,255,0.5);
             margin-bottom: 20px;
             letter-spacing: 3px;
             font-weight: 300;
             background: linear-gradient(45deg, #ffffff, #e0e6ff, #ffeef8);
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
             position: relative;
         }
         
         .chat-list-title::after {
             content: "";
             position: absolute;
             bottom: -10px;
             left: 50%;
             transform: translateX(-50%);
             width: 100px;
             height: 2px;
             background: linear-gradient(90deg, transparent, #ffffff, transparent);
         }
         
         .chat-list-subtitle {
             font-size: 1.2rem;
             color: rgba(255, 255, 255, 0.8);
             text-shadow: 0 2px 5px rgba(0,0,0,0.3);
             margin-bottom: 50px;
         }
        
                 .character-gallery {
             display: flex;
             justify-content: center;
             align-items: flex-end;
             gap: 30px;
             width: 100%;
             max-width: 1400px;
             margin: 0 auto;
             perspective: 1000px;
             padding: 0 20px;
             box-sizing: border-box;
             flex-wrap: nowrap;
             overflow-x: auto;
         }
         
         .character-silhouette {
             position: relative;
             width: 200px;
             height: 300px;
             cursor: pointer;
             transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
             transform-style: preserve-3d;
         }
         
         .character-silhouette:hover {
             transform: translateY(-20px) scale(1.05);
         }
         
         .silhouette-frame {
             width: 100%;
             height: 100%;
             background: rgba(255, 255, 255, 0.1);
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
             border: 2px solid rgba(255, 255, 255, 0.3);
             border-radius: 15px;
             overflow: hidden;
             position: relative;
             backdrop-filter: blur(10px);
             box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
         }
         
         .silhouette-bg {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(135deg, 
                 rgba(120, 119, 198, 0.2) 0%, 
                 rgba(255, 119, 198, 0.1) 50%, 
                 rgba(120, 219, 255, 0.2) 100%);
             opacity: 0.4;
         }
         

         
         .character-bg-lorenzo {
             background-image: url('./È°æÊôØÊ∑±.png');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
         }
         
         .character-bg-dylan {
             background-image: url('./ÁôΩÊüØ.png');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
         }
         
         .character-bg-nate {
             background-image: url('./ËÆ∏Ë®Ä.png');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
         }
         
         .character-bg-asher {
             background-image: url('./Â§èÂÖâÊ¥õ.png');
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
         }
         
         .character-info-overlay {
             position: absolute;
             bottom: 0;
             left: 0;
             right: 0;
             background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
             padding: 20px 15px 15px;
             color: white;
             transform: translateY(100%);
             transition: transform 0.3s ease;
         }
         
         .character-silhouette:hover .character-info-overlay {
             transform: translateY(0);
         }
         
         .character-name-silhouette {
             font-size: 1.2rem;
             font-weight: 600;
             margin-bottom: 5px;
             text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
         }
         
         .character-type-silhouette {
             font-size: 0.9rem;
             opacity: 0.9;
             font-style: italic;
         }
         
         .glow-effect {
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
             animation: rotate 20s linear infinite;
             pointer-events: none;
         }
         
         @keyframes rotate {
             from { transform: rotate(0deg); }
             to { transform: rotate(360deg); }
         }
         
         @media (max-width: 768px) {
             .character-gallery {
                 flex-direction: column;
                 gap: 30px;
                 align-items: center;
                 justify-content: center;
             }
             
             .character-silhouette {
                 width: 150px;
                 height: 220px;
             }
             
             .chat-list-title {
                 font-size: 2.5rem;
                 letter-spacing: 2px;
             }
             
             .chat-list-subtitle {
                 font-size: 1rem;
             }
             
             #sms-chat-page {
                 width: 95%;
                 height: 95%;
                 max-width: none;
                 max-height: none;
             }
             
             #homepage {
                 padding: 10px !important;
             }
             
             .main-title {
                 font-size: 2.5rem !important;
             }
         }
         
         @media (max-width: 480px) {
             .character-gallery {
                 gap: 20px;
             }
             
             .character-silhouette {
                 width: 120px;
                 height: 180px;
             }
             
             .chat-list-title {
                 font-size: 2rem;
                 letter-spacing: 1px;
             }
             
             .chat-window-container {
                 width: 95%;
                 height: 85%;
                 max-width: 350px;
                 max-height: 500px;
             }
             
             .sms-bubble {
                 max-width: 75%;
                 font-size: 12px;
                 padding: 8px 12px;
             }
             
             .message-avatar {
                 width: 24px;
                 height: 24px;
             }
         }
         
         
        
        .close-chat-list {
            position: absolute;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.3);
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s ease;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        
        .close-chat-list:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(180deg) scale(1.1);
        }
        
        .close-chat-list i {
            color: white;
            font-size: 28px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        /* Flower Decorations */
        .flower-decoration {
            position: absolute;
            z-index: 5;
            filter: drop-shadow(0 0 10px rgba(255, 183, 197, 0.5));
        }
        
        .flower-1 {
            top: 10%;
            left: 5%;
            width: 100px;
            height: 100px;
            animation: float 20s linear infinite;
        }
        
        .flower-2 {
            bottom: 15%;
            right: 5%;
            width: 120px;
            height: 120px;
            animation: float 25s linear infinite reverse;
        }
        
        .flower-3 {
            top: 30%;
            right: 10%;
            width: 80px;
            height: 80px;
            animation: float 18s linear infinite;
        }
        
        .flower-4 {
            bottom: 25%;
            left: 10%;
            width: 90px;
            height: 90px;
            animation: float 22s linear infinite reverse;
        }
        
        .anime-bubble {
            position: relative;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 80%;
        }
        
        .anime-bubble::after {
            content: "";
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }
        
        .bubble-left {
            background: white;
            align-self: flex-start;
        }
        
        .bubble-left::after {
            border-width: 10px 15px 10px 0;
            border-color: transparent white transparent transparent;
            left: -15px;
            top: 15px;
        }
        
        .bubble-right {
            background: linear-gradient(to right, var(--pastel-blue), var(--pastel-cyan));
            color: white;
            align-self: flex-end;
        }
        
        .bubble-right::after {
            border-width: 10px 0 10px 15px;
            border-color: transparent transparent transparent var(--pastel-cyan);
            right: -15px;
            top: 15px;
        }
        
        .anime-text {
            font-size: 1.1rem;
            line-height: 1.5;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px 2px white;
            animation: sparkle 2s infinite;
            will-change: transform, opacity;
            transform: translateZ(0); /* Force hardware acceleration */
            backface-visibility: hidden; /* Optimize rendering */
        }
        
        @keyframes sparkle {
            0% { opacity: 0; transform: scale(0) translateZ(0); }
            50% { opacity: 1; transform: scale(1) translateZ(0); }
            100% { opacity: 0; transform: scale(0) translateZ(0); }
        }
        
        .heart {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--sakura-pink);
            transform: rotate(-45deg) translateZ(0);
            animation: floatHeart 8s linear infinite;
            z-index: -1;
            will-change: transform, opacity;
            backface-visibility: hidden; /* Optimize rendering */
        }
        
        .heart::before, .heart::after {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--sakura-pink);
            border-radius: 50%;
        }
        
        .heart::before {
            top: -10px;
            left: 0;
        }
        
        .heart::after {
            top: 0;
            left: 10px;
        }
        
                 @keyframes floatHeart {
             0% { transform: translateY(0) rotate(-45deg) translateZ(0); opacity: 0; }
             10% { opacity: 0.8; }
             90% { opacity: 0.8; }
             100% { transform: translateY(-100vh) rotate(-45deg) translateZ(0); opacity: 0; }
         }
         
         /* SMS Chat Page Styles - Updated to match the image design */
         #sms-chat-page {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(135deg, 
                 rgba(248, 245, 255, 0.3) 0%, 
                 rgba(239, 230, 255, 0.2) 30%, 
                 rgba(230, 220, 250, 0.15) 70%,
                 rgba(245, 240, 255, 0.2) 100%);
             border-radius: 0;
             box-shadow: none;
             border: none;
             z-index: 1000;
             display: flex;
             align-items: center;
             justify-content: center;
             overflow: hidden;
             backdrop-filter: blur(5px);
         }
         
         /* Background overlay when chat is open - Dreamy Style */
         #sms-chat-page::before {
             content: '';
             position: fixed;
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             background: linear-gradient(45deg, 
                 rgba(180, 150, 255, 0.05) 0%, 
                 rgba(200, 180, 255, 0.03) 50%, 
                 rgba(220, 200, 255, 0.02) 100%);
             backdrop-filter: blur(3px);
             z-index: -1;
         }
         
         /* Floating dreamy particles */
         #sms-chat-page::after {
             content: '‚ú® üí´ ‚≠ê üå∏ üíï ‚ú® üí´ ‚≠ê üå∏ üíï';
             position: absolute;
             top: -50px;
             left: -50px;
             right: -50px;
             bottom: -50px;
             font-size: 16px;
             opacity: 0.2;
             animation: floatingParticles 20s linear infinite;
             pointer-events: none;
             z-index: -1;
             letter-spacing: 80px;
             line-height: 80px;
         }
         
         @keyframes floatingParticles {
             0% { transform: translateY(0px) rotate(0deg); }
             100% { transform: translateY(-20px) rotate(360deg); }
         }
         
         /* Chat Window Container - Centered and iPad-like size */
         .chat-window-container {
             width: 90%;
             max-width: 800px;
             height: 80%;
             max-height: 600px;
             background: rgba(255, 255, 255, 0.15);
             border-radius: 25px;
             backdrop-filter: blur(20px);
             border: 1px solid rgba(255, 255, 255, 0.3);
             box-shadow: 
                 0 8px 32px rgba(31, 38, 135, 0.1),
                 0 4px 16px rgba(0, 0, 0, 0.05);
             display: flex;
             flex-direction: column;
             overflow: hidden;
             position: relative;
         }
         

         

         
         .sms-chat-header {
             position: relative;
             z-index: 10;
             background: linear-gradient(135deg, 
                 rgba(200, 180, 255, 0.4) 0%, 
                 rgba(180, 160, 240, 0.3) 50%, 
                 rgba(160, 140, 220, 0.25) 100%);
             padding: 12px 16px;
             display: flex;
             align-items: center;
             justify-content: space-between;
             border-radius: 25px 25px 0 0;
             backdrop-filter: blur(15px);
             border-bottom: 1px solid rgba(255, 255, 255, 0.2);
             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
         }
         
         .sms-chat-header::before {
             content: 'üíú';
             position: absolute;
             top: 10px;
             right: 15px;
             font-size: 16px;
             opacity: 0.6;
             animation: pulse 2s ease-in-out infinite;
         }
         
         @keyframes pulse {
             0%, 100% { opacity: 0.6; transform: scale(1); }
             50% { opacity: 1; transform: scale(1.1); }
         }
         
         .back-to-list {
             background: rgba(255, 255, 255, 0.2);
             border: none;
             color: rgba(255, 255, 255, 0.8);
             font-size: 16px;
             cursor: pointer;
             padding: 6px;
             border-radius: 50%;
             transition: all 0.3s ease;
             width: 30px;
             height: 30px;
             display: flex;
             align-items: center;
             justify-content: center;
             backdrop-filter: blur(10px);
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
         }
         
         .back-to-list:hover {
             background: rgba(255, 255, 255, 0.4);
             transform: scale(1.05);
             box-shadow: 0 6px 20px rgba(180, 150, 255, 0.15);
         }
         
         .sms-chat-info {
             display: flex;
             align-items: center;
             flex: 1;
             justify-content: center;
             flex-direction: column;
         }
         
         .sms-char-info h3 {
             color: rgba(255, 255, 255, 0.9);
             margin: 0;
             font-size: 14px;
             font-weight: 600;
             text-align: center;
             text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
             letter-spacing: 0.5px;
         }
         
         .sms-char-info p {
             color: rgba(255, 255, 255, 0.7);
             margin: 0;
             font-size: 10px;
             text-align: center;
             margin-top: 2px;
             text-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
             font-style: italic;
         }
         
         .header-avatar {
             background: rgba(255, 255, 255, 0.2);
             border: none;
             color: rgba(255, 255, 255, 0.8);
             font-size: 14px;
             cursor: pointer;
             padding: 6px;
             border-radius: 50%;
             width: 28px;
             height: 28px;
             display: flex;
             align-items: center;
             justify-content: center;
             position: relative;
         }
         
         .header-avatar::after {
             content: 'üíú';
             position: absolute;
             top: -2px;
             right: -2px;
             font-size: 12px;
         }
         
         .sms-messages {
             flex: 1;
             overflow-y: auto;
             padding: 15px;
             position: relative;
             z-index: 10;
             background: rgba(255, 255, 255, 0.05);
             backdrop-filter: blur(10px);
         }
         
         .sms-message {
             margin-bottom: 15px;
             display: flex;
             align-items: flex-end;
         }
         
         .sms-message.user {
             justify-content: flex-end;
         }
         
         .sms-message.ai {
             justify-content: flex-start;
         }
         
         .message-avatar {
             width: 28px;
             height: 28px;
             border-radius: 50%;
             object-fit: cover;
             margin: 0 6px;
             border: 1px solid rgba(255, 255, 255, 0.3);
         }
         
         .sms-bubble {
             max-width: 70%;
             padding: 10px 14px;
             border-radius: 16px;
             font-size: 13px;
             line-height: 1.4;
             word-wrap: break-word;
             position: relative;
         }
         
         .sms-bubble.user {
             background: linear-gradient(135deg, 
                 rgba(180, 160, 255, 0.6) 0%, 
                 rgba(160, 140, 230, 0.5) 100%);
             color: rgba(255, 255, 255, 0.9);
             border-bottom-right-radius: 6px;
             margin-left: auto;
             margin-right: 10px;
             border: 1px solid rgba(200, 180, 255, 0.3);
             box-shadow: 0 4px 15px rgba(180, 160, 255, 0.1);
             backdrop-filter: blur(10px);
         }
         
         .sms-bubble.ai {
             background: rgba(255, 255, 255, 0.7);
             color: rgba(80, 60, 120, 0.8);
             border-bottom-left-radius: 6px;
             border: 1px solid rgba(220, 200, 255, 0.3);
             backdrop-filter: blur(15px);
             margin-left: 10px;
             margin-right: auto;
             box-shadow: 0 4px 15px rgba(200, 180, 255, 0.08);
         }
         
         /* Character-specific AI bubble colors */
         .sms-bubble.ai.lorenzo {
             background: linear-gradient(135deg, 
                 rgba(88, 78, 140, 0.15) 0%, 
                 rgba(110, 98, 165, 0.12) 100%);
             color: rgba(88, 78, 140, 0.9);
             border: 1px solid rgba(110, 98, 165, 0.3);
             box-shadow: 0 4px 15px rgba(88, 78, 140, 0.1);
         }
         
         .sms-bubble.ai.dylan {
             background: linear-gradient(135deg, 
                 rgba(70, 130, 180, 0.15) 0%, 
                 rgba(95, 158, 160, 0.12) 100%);
             color: rgba(70, 130, 180, 0.9);
             border: 1px solid rgba(95, 158, 160, 0.3);
             box-shadow: 0 4px 15px rgba(70, 130, 180, 0.1);
         }
         
         .sms-bubble.ai.nate {
             background: linear-gradient(135deg, 
                 rgba(72, 152, 120, 0.15) 0%, 
                 rgba(85, 170, 138, 0.12) 100%);
             color: rgba(72, 152, 120, 0.9);
             border: 1px solid rgba(85, 170, 138, 0.3);
             box-shadow: 0 4px 15px rgba(72, 152, 120, 0.1);
         }
         
         .sms-bubble.ai.asher {
             background: linear-gradient(135deg, 
                 rgba(218, 165, 32, 0.15) 0%, 
                 rgba(240, 180, 70, 0.12) 100%);
             color: rgba(218, 165, 32, 0.9);
             border: 1px solid rgba(240, 180, 70, 0.3);
             box-shadow: 0 4px 15px rgba(218, 165, 32, 0.1);
         }
         
         .sms-bubble.ai.shenzhihua {
             background: linear-gradient(135deg, 
                 rgba(108, 122, 137, 0.15) 0%, 
                 rgba(133, 146, 158, 0.12) 100%);
             color: rgba(108, 122, 137, 0.9);
             border: 1px solid rgba(133, 146, 158, 0.3);
             box-shadow: 0 4px 15px rgba(108, 122, 137, 0.1);
         }
         
         .sms-bubble.ai.yangyingge {
             background: linear-gradient(135deg, 
                 rgba(165, 42, 42, 0.15) 0%, 
                 rgba(205, 92, 92, 0.12) 100%);
             color: rgba(165, 42, 42, 0.9);
             border: 1px solid rgba(205, 92, 92, 0.3);
             box-shadow: 0 4px 15px rgba(165, 42, 42, 0.1);
         }
         
         .sms-bubble.ai.anyu {
             background: linear-gradient(135deg, 
                 rgba(255, 140, 0, 0.15) 0%, 
                 rgba(255, 165, 79, 0.12) 100%);
             color: rgba(255, 140, 0, 0.9);
             border: 1px solid rgba(255, 165, 79, 0.3);
             box-shadow: 0 4px 15px rgba(255, 140, 0, 0.1);
         }
         
         .sms-bubble.ai.xieshuqi {
             background: linear-gradient(135deg, 
                 rgba(147, 112, 219, 0.15) 0%, 
                 rgba(176, 196, 222, 0.12) 100%);
             color: rgba(147, 112, 219, 0.9);
             border: 1px solid rgba(176, 196, 222, 0.3);
             box-shadow: 0 4px 15px rgba(147, 112, 219, 0.1);
         }
         
         .sms-bubble.ai.luzeyan {
             background: linear-gradient(135deg, 
                 rgba(160, 82, 45, 0.15) 0%, 
                 rgba(210, 180, 140, 0.12) 100%);
             color: rgba(160, 82, 45, 0.9);
             border: 1px solid rgba(210, 180, 140, 0.3);
             box-shadow: 0 4px 15px rgba(160, 82, 45, 0.1);
         }
         
         .sms-bubble.ai.suyan {
             background: linear-gradient(135deg, 
                 rgba(25, 25, 112, 0.15) 0%, 
                 rgba(72, 61, 139, 0.12) 100%);
             color: rgba(25, 25, 112, 0.9);
             border: 1px solid rgba(72, 61, 139, 0.3);
             box-shadow: 0 4px 15px rgba(25, 25, 112, 0.1);
         }
         
         .sms-bubble.ai.wenyanzhou {
             background: linear-gradient(135deg, 
                 rgba(255, 218, 185, 0.15) 0%, 
                 rgba(245, 222, 179, 0.12) 100%);
             color: rgba(205, 133, 63, 0.9);
             border: 1px solid rgba(245, 222, 179, 0.3);
             box-shadow: 0 4px 15px rgba(205, 133, 63, 0.1);
         }
         
         .sms-bubble.ai.fuye {
             background: linear-gradient(135deg, 
                 rgba(47, 79, 79, 0.15) 0%, 
                 rgba(85, 107, 47, 0.12) 100%);
             color: rgba(47, 79, 79, 0.9);
             border: 1px solid rgba(85, 107, 47, 0.3);
             box-shadow: 0 4px 15px rgba(47, 79, 79, 0.1);
         }
         
         .sms-bubble.user::before {
             content: 'üí≠';
             position: absolute;
             top: -15px;
             right: -5px;
             font-size: 12px;
             opacity: 0.4;
         }
         
         .sms-bubble.ai::before {
             content: '‚ú®';
             position: absolute;
             top: -15px;
             left: -5px;
             font-size: 12px;
             opacity: 0.4;
         }
         
         .sms-timestamp {
             font-size: 11px;
             color: rgba(0, 0, 0, 0.3);
             text-align: center;
             margin: 8px 0;
             font-weight: 500;
         }
         
         .typing-indicator {
             display: flex;
             align-items: center;
             padding: 10px 16px;
             color: rgba(102, 102, 102, 0.7);
             background: rgba(255, 255, 255, 0.5);
             margin: 8px 15px;
             border-radius: 16px;
             backdrop-filter: blur(10px);
         }
         
         .typing-dots {
             display: flex;
             margin-right: 10px;
         }
         
         .typing-dots span {
             width: 6px;
             height: 6px;
             border-radius: 50%;
             background: #999;
             margin: 0 2px;
             animation: typingPulse 1.4s infinite;
         }
         
         .typing-dots span:nth-child(2) {
             animation-delay: 0.2s;
         }
         
         .typing-dots span:nth-child(3) {
             animation-delay: 0.4s;
         }
         
         @keyframes typingPulse {
             0%, 60%, 100% {
                 opacity: 0.3;
                 transform: scale(1);
             }
             30% {
                 opacity: 1;
                 transform: scale(1.2);
             }
         }
         
         .sms-input-area {
             background: linear-gradient(135deg, 
                 rgba(250, 245, 255, 0.4) 0%, 
                 rgba(240, 235, 255, 0.3) 100%);
             backdrop-filter: blur(15px);
             padding: 12px 16px;
             display: flex;
             align-items: center;
             gap: 10px;
             border-top: 1px solid rgba(200, 180, 255, 0.15);
             border-radius: 0 0 25px 25px;
             box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2);
         }
         
         .voice-btn, .emoji-btn, .add-btn {
             background: rgba(200, 180, 255, 0.15);
             border: 1px solid rgba(200, 180, 255, 0.2);
             color: rgba(120, 100, 180, 0.6);
             font-size: 16px;
             cursor: pointer;
             padding: 6px;
             border-radius: 50%;
             transition: all 0.3s ease;
             width: 32px;
             height: 32px;
             display: flex;
             align-items: center;
             justify-content: center;
             backdrop-filter: blur(10px);
         }
         
         .voice-btn:hover, .emoji-btn:hover, .add-btn:hover {
             background: rgba(200, 180, 255, 0.25);
             color: rgba(120, 100, 180, 0.8);
             transform: scale(1.05);
             box-shadow: 0 4px 12px rgba(180, 150, 255, 0.1);
         }
         
         .sms-input {
             flex: 1;
             background: rgba(255, 255, 255, 0.6);
             border: 2px solid rgba(200, 180, 255, 0.2);
             border-radius: 20px;
             padding: 10px 16px;
             font-size: 14px;
             outline: none;
             color: rgba(80, 60, 120, 0.8);
             backdrop-filter: blur(15px);
             box-shadow: inset 0 2px 8px rgba(200, 180, 255, 0.05);
             transition: all 0.3s ease;
         }
         
         .sms-input:focus {
             border-color: rgba(180, 160, 255, 0.4);
             background: rgba(255, 255, 255, 0.7);
             box-shadow: 
                 inset 0 2px 8px rgba(200, 180, 255, 0.08),
                 0 0 0 3px rgba(200, 180, 255, 0.05);
         }
         
         .sms-input::placeholder {
             color: rgba(150, 130, 200, 0.4);
             font-style: italic;
         }
         
         /* Page Display Control */
         #homepage {
             display: flex;
         }
         
         #homepage.hidden {
             display: none !important;
         }
         
         #chat-list-page {
             display: none;
         }
         
         #chat-list-page.active {
             display: block;
             opacity: 1;
             pointer-events: all;
         }
         
         #sms-chat-page {
             display: none;
         }
         
         #sms-chat-page.active {
             display: flex;
         }
         
         #sms-chat-page.hidden {
             display: none;
         }
         
         /* Authentication Pages Display Control */
         #login-page,
         #register-page,
         #profile-page,
         #admin-page {
             display: flex;
             align-items: center;
             justify-content: center;
             min-height: 100vh;
             padding: 20px;
             box-sizing: border-box;
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             z-index: 1000;
         }
         
         /* Responsive adjustments for mobile */
         @media (max-width: 768px) {
             #login-page,
             #register-page,
             #profile-page,
             #admin-page {
                 padding: 15px;
             }
             
                         .auth-container {
                width: 95%;
                padding: 30px 20px;
                max-width: none;
            }
            
            #profile-page .auth-container,
            #settings-page .auth-container {
                width: 98%;
                padding: 25px 15px;
                max-width: none;
                max-height: 90vh;
            }
             
             .admin-container {
                 width: 98%;
                 padding: 20px 15px;
                 max-height: 90vh;
             }
         }
         
         #login-page.hidden,
         #register-page.hidden,
         #profile-page.hidden,
         #admin-page.hidden {
             display: none !important;
         }

         /* Authentication Styles */
                 .auth-container {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.95) 0%, 
                rgba(248, 245, 255, 0.9) 50%, 
                rgba(240, 235, 255, 0.85) 100%);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 
                0 25px 50px rgba(150, 100, 255, 0.15),
                0 15px 35px rgba(200, 150, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(200, 180, 255, 0.3);
            max-width: 450px;
            width: 90%;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        
        /* Profile and Settings pages need larger containers */
        #profile-page .auth-container,
        #settings-page .auth-container {
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        /* Ensure profile content is properly spaced */
        #profile-page .profile-info {
            margin-bottom: 25px;
        }
        
        #profile-page .auth-form {
            margin-bottom: 25px;
        }
        
        #profile-page .profile-actions {
            margin-top: 20px;
        }
        
        /* Custom scrollbar for profile and settings pages */
        #profile-page .auth-container::-webkit-scrollbar,
        #settings-page .auth-container::-webkit-scrollbar {
            width: 6px;
        }
        
        #profile-page .auth-container::-webkit-scrollbar-track,
        #settings-page .auth-container::-webkit-scrollbar-track {
            background: rgba(200, 180, 255, 0.1);
            border-radius: 3px;
        }
        
        #profile-page .auth-container::-webkit-scrollbar-thumb,
        #settings-page .auth-container::-webkit-scrollbar-thumb {
            background: rgba(180, 160, 255, 0.5);
            border-radius: 3px;
        }
        
        #profile-page .auth-container::-webkit-scrollbar-thumb:hover,
        #settings-page .auth-container::-webkit-scrollbar-thumb:hover {
            background: rgba(180, 160, 255, 0.7);
        }

         .auth-container::before {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: radial-gradient(circle, 
                 rgba(255, 182, 193, 0.1) 0%, 
                 transparent 50%);
             animation: rotate 20s linear infinite;
             pointer-events: none;
         }

         .auth-header {
             text-align: center;
             margin-bottom: 30px;
             position: relative;
             z-index: 2;
         }

         .auth-title {
             font-size: 28px;
             font-weight: 700;
             color: rgba(120, 100, 180, 0.9);
             margin-bottom: 8px;
             text-shadow: 0 2px 8px rgba(150, 100, 255, 0.3);
         }

         .auth-subtitle {
             font-size: 16px;
             color: rgba(150, 130, 200, 0.8);
             font-style: italic;
         }

         .auth-form {
             position: relative;
             z-index: 2;
         }

         .form-group {
             position: relative;
             margin-bottom: 20px;
         }

         .form-icon {
             position: absolute;
             left: 15px;
             top: 50%;
             transform: translateY(-50%);
             color: rgba(150, 130, 200, 0.6);
             font-size: 16px;
             z-index: 3;
         }

         .auth-form input[type="text"],
         .auth-form input[type="email"],
         .auth-form input[type="password"],
         .auth-form input[type="number"],
         .auth-form select {
             width: 100%;
             padding: 15px 45px;
             border: 2px solid rgba(200, 180, 255, 0.3);
             border-radius: 20px;
             background: rgba(255, 255, 255, 0.8);
             font-size: 16px;
             color: rgba(80, 60, 120, 0.9);
             backdrop-filter: blur(10px);
             transition: all 0.3s ease;
         }

         .auth-form input:focus,
         .auth-form select:focus {
             outline: none;
             border-color: rgba(180, 160, 255, 0.6);
             background: rgba(255, 255, 255, 0.95);
             box-shadow: 
                 0 0 0 3px rgba(200, 180, 255, 0.2),
                 0 4px 20px rgba(180, 150, 255, 0.15);
         }

         .auth-form input::placeholder {
             color: rgba(150, 130, 200, 0.6);
             font-style: italic;
         }

         .form-options {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 25px;
         }

         .remember-me {
             display: flex;
             align-items: center;
             font-size: 14px;
             color: rgba(120, 100, 180, 0.8);
             cursor: pointer;
         }

         .remember-me input[type="checkbox"] {
             margin-right: 8px;
             width: auto;
         }

         .auth-btn {
             padding: 15px 30px;
             border: none;
             border-radius: 20px;
             font-size: 16px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s ease;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
             position: relative;
             overflow: hidden;
         }

         .auth-btn.primary {
             background: linear-gradient(135deg, 
                 rgba(180, 160, 255, 0.9) 0%, 
                 rgba(160, 140, 230, 0.8) 100%);
             color: white;
             box-shadow: 0 6px 20px rgba(180, 150, 255, 0.3);
             width: 100%;
             margin-bottom: 20px;
         }

         .auth-btn.primary:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 25px rgba(180, 150, 255, 0.4);
         }

         .auth-btn.secondary {
             background: rgba(255, 255, 255, 0.8);
             color: rgba(120, 100, 180, 0.9);
             border: 2px solid rgba(200, 180, 255, 0.4);
         }

         .auth-btn.secondary:hover {
             background: rgba(255, 255, 255, 0.95);
             transform: translateY(-1px);
         }

         .auth-btn.danger {
             background: linear-gradient(135deg, 
                 rgba(255, 150, 150, 0.8) 0%, 
                 rgba(255, 120, 120, 0.7) 100%);
             color: white;
         }

         .auth-btn.danger:hover {
             background: linear-gradient(135deg, 
                 rgba(255, 120, 120, 0.9) 0%, 
                 rgba(255, 100, 100, 0.8) 100%);
         }

         .auth-btn.admin {
             background: linear-gradient(135deg, 
                 rgba(255, 180, 120, 0.8) 0%, 
                 rgba(255, 160, 100, 0.7) 100%);
             color: white;
         }

         .auth-links {
             text-align: center;
             margin-top: 20px;
         }

         .auth-links a {
             color: rgba(150, 130, 200, 0.8);
             text-decoration: none;
             font-size: 14px;
             transition: color 0.3s ease;
         }

         .auth-links a:hover {
             color: rgba(120, 100, 180, 1);
         }

         .error-message {
             background: linear-gradient(135deg, 
                 rgba(255, 150, 150, 0.9) 0%, 
                 rgba(255, 180, 180, 0.8) 100%);
             color: white;
             padding: 12px 20px;
             border-radius: 15px;
             margin-top: 15px;
             text-align: center;
             font-size: 14px;
             backdrop-filter: blur(10px);
         }

         .success-message {
             background: linear-gradient(135deg, 
                 rgba(150, 255, 150, 0.9) 0%, 
                 rgba(180, 255, 180, 0.8) 100%);
             color: white;
             padding: 12px 20px;
             border-radius: 15px;
             margin-top: 15px;
             text-align: center;
             font-size: 14px;
             backdrop-filter: blur(10px);
         }

         /* Profile Page Styles */
         .profile-info {
             background: rgba(255, 255, 255, 0.6);
             padding: 25px;
             border-radius: 20px;
             margin-bottom: 30px;
             backdrop-filter: blur(15px);
         }

         .profile-item {
             display: flex;
             justify-content: space-between;
             margin-bottom: 15px;
             padding-bottom: 10px;
             border-bottom: 1px solid rgba(200, 180, 255, 0.2);
         }

         .profile-item:last-child {
             border-bottom: none;
             margin-bottom: 0;
         }

         .profile-item label {
             font-weight: 600;
             color: rgba(120, 100, 180, 0.9);
         }

         .profile-item span {
             color: rgba(80, 60, 120, 0.8);
         }

         .profile-actions {
             display: flex;
             flex-direction: column;
             gap: 15px;
             margin-top: 30px;
         }
         
         .settings-content {
             margin-top: 2rem;
         }
         
         .settings-section {
             background: rgba(255, 255, 255, 0.9);
             border-radius: 15px;
             padding: 25px;
             margin-bottom: 20px;
             border: 2px solid rgba(200, 180, 255, 0.3);
             backdrop-filter: blur(10px);
         }
         
         .settings-section h3 {
             color: rgba(120, 100, 180, 0.9);
             margin-bottom: 20px;
             font-size: 1.2rem;
             font-weight: 600;
             text-align: center;
         }
         
         .settings-item {
             margin-bottom: 20px;
         }
         
         .settings-item label {
             display: block;
             color: rgba(100, 80, 150, 0.8);
             margin-bottom: 8px;
             font-size: 1rem;
             font-weight: 500;
         }
         
         .settings-item input {
             width: 100%;
             padding: 12px 15px;
             border: 2px solid rgba(200, 180, 255, 0.3);
             border-radius: 10px;
             background: rgba(255, 255, 255, 0.8);
             color: rgba(80, 60, 120, 0.9);
             font-size: 0.95rem;
             transition: all 0.3s ease;
             box-sizing: border-box;
         }
         
         .settings-item input:focus {
             outline: none;
             border-color: rgba(180, 160, 255, 0.8);
             background: rgba(255, 255, 255, 0.95);
             box-shadow: 0 0 0 3px rgba(180, 160, 255, 0.2);
         }
         
         .settings-item input::placeholder {
             color: rgba(150, 130, 200, 0.6);
         }
         
         .music-controls {
             display: flex;
             align-items: center;
             gap: 10px;
         }
         
         .music-btn {
             padding: 8px 16px;
             border: 2px solid rgba(200, 180, 255, 0.3);
             border-radius: 8px;
             background: rgba(255, 255, 255, 0.8);
             color: rgba(100, 80, 150, 0.8);
             font-size: 0.85rem;
             cursor: pointer;
             transition: all 0.3s ease;
             min-width: auto;
             white-space: nowrap;
         }
         
         .music-btn:hover {
             background: rgba(255, 255, 255, 0.95);
             border-color: rgba(180, 160, 255, 0.6);
         }
         
         .music-btn.active {
             background: rgba(80, 200, 120, 0.8);
             border-color: rgba(80, 200, 120, 0.8);
             color: white;
         }
         
         .music-btn.inactive {
             background: rgba(200, 80, 80, 0.8);
             border-color: rgba(200, 80, 80, 0.8);
             color: white;
         }
         
         .music-btn i {
             margin-right: 4px;
         }
         
         /* Top Notification Styles */
         .top-notification {
             position: fixed;
             top: 20px;
             left: 50%;
             transform: translateX(-50%);
             background: linear-gradient(135deg, #4CAF50, #45a049);
             color: white;
             padding: 12px 24px;
             border-radius: 8px;
             box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
             z-index: 10000;
             font-size: 14px;
             font-weight: 500;
             opacity: 0;
             transform: translateX(-50%) translateY(-30px);
             transition: all 0.3s ease;
             max-width: 300px;
             text-align: center;
         }
         
         .top-notification.show {
             opacity: 1;
             transform: translateX(-50%) translateY(0);
         }
         
                 .top-notification.hidden {
            display: none;
        }
        
        /* Unlock Limit Modal Styles */
        .unlock-limit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 15000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .unlock-limit-modal.show {
            opacity: 1;
        }
        
        .unlock-limit-modal.hidden {
            display: none;
        }
        
        .unlock-limit-content {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%);
            border-radius: 20px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            overflow: hidden;
        }
        
        .unlock-limit-modal.show .unlock-limit-content {
            transform: scale(1);
        }
        
        .unlock-limit-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .unlock-limit-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .unlock-limit-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease;
        }
        
        .unlock-limit-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .unlock-limit-body {
            padding: 30px 20px;
            text-align: center;
            color: #333;
        }
        
        .unlock-limit-body p {
            margin: 10px 0;
            font-size: 1rem;
            line-height: 1.5;
        }
        
        .unlock-limit-icon {
            font-size: 3rem;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .unlock-limit-footer {
            padding: 20px;
            background: rgba(255, 255, 255, 0.3);
            text-align: center;
        }
        
        .unlock-limit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-weight: 500;
        }
        
        .unlock-limit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        /* Welcome Modal Styles */
         .welcome-modal {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.5);
             backdrop-filter: blur(5px);
             z-index: 20000;
             display: flex;
             justify-content: center;
             align-items: center;
             opacity: 0;
             transition: all 0.3s ease;
         }
         
         .welcome-modal.show {
             opacity: 1;
         }
         
         .welcome-modal.hidden {
             display: none;
         }
         
         .welcome-content {
             position: relative;
             transform: scale(0.8);
             transition: transform 0.3s ease;
         }
         
         .welcome-modal.show .welcome-content {
             transform: scale(1);
         }
         
         .welcome-sticky-note {
             background: linear-gradient(135deg, 
                 #FFB6C1 0%,    /* Ê∑°Á≤âËâ≤ */
                 #FFC0CB 25%,   /* Á≤âËâ≤ */
                 #FFE4E1 50%,   /* ÈõæÁé´Áë∞Ëâ≤ */
                 #FFCCCB 75%,   /* ÊµÖÁ≤âËâ≤ */
                 #FFB6C1 100%); /* ÂõûÂà∞Ê∑°Á≤âËâ≤ */
             padding: 40px 35px 35px 35px;
             border-radius: 20px;
             box-shadow: 
                 0 12px 35px rgba(255, 182, 193, 0.5),
                 0 6px 20px rgba(255, 192, 203, 0.4),
                 inset 0 1px 0 rgba(255, 255, 255, 0.8);
             max-width: 450px;
             min-width: 400px;
             text-align: center;
             position: relative;
             border: 2px solid rgba(255, 182, 193, 0.6);
             font-family: 'Microsoft YaHei', sans-serif;
         }
         
         .welcome-sticky-note::before {
             content: '';
             position: absolute;
             top: -8px;
             left: 50%;
             transform: translateX(-50%);
             width: 60px;
             height: 20px;
             background: linear-gradient(135deg, #FFD700, #FFA500);
             border-radius: 0 0 10px 10px;
             box-shadow: 0 2px 5px rgba(255, 215, 0, 0.3);
         }
         
         .welcome-close {
             position: absolute;
             top: -8px;
             right: -8px;
             width: 32px;
             height: 32px;
             border-radius: 50%;
             background: linear-gradient(135deg, #FF69B4, #FF1493);
             color: white;
             border: 2px solid white;
             font-size: 18px;
             font-weight: bold;
             cursor: pointer;
             display: flex;
             align-items: center;
             justify-content: center;
             transition: all 0.2s ease;
             box-shadow: 0 4px 12px rgba(255, 20, 147, 0.4);
             z-index: 1000;
         }
         
         .welcome-close:hover {
             transform: scale(1.15);
             background: linear-gradient(135deg, #FF1493, #DC143C);
             box-shadow: 0 6px 16px rgba(255, 20, 147, 0.6);
         }
         
         .welcome-title {
             color: #C71585;
             font-size: 26px;
             font-weight: 600;
             margin: 0 0 25px 0;
             text-shadow: 0 1px 2px rgba(199, 21, 133, 0.2);
         }
         
         .welcome-text {
             color: #8B008B;
             font-size: 16px;
             line-height: 1.8;
             margin-bottom: 25px;
         }
         
         .welcome-text p {
             margin: 10px 0;
             text-shadow: 0 1px 1px rgba(255, 255, 255, 0.8);
         }
         
         .welcome-footer {
             border-top: 1px dashed rgba(199, 21, 133, 0.3);
             padding-top: 18px;
         }
         
         .heart-text {
             color: #FF1493;
             font-size: 18px;
             font-weight: 600;
             text-shadow: 0 1px 2px rgba(255, 20, 147, 0.3);
             animation: heartbeat 2s ease-in-out infinite;
         }
         
         @keyframes heartbeat {
             0%, 100% { transform: scale(1); }
             50% { transform: scale(1.05); }
         }
         
         /* Mobile responsiveness */
         @media (max-width: 480px) {
             .welcome-sticky-note {
                 max-width: 90%;
                 min-width: auto;
                 padding: 30px 25px 25px 25px;
             }
             
             .welcome-title {
                 font-size: 22px;
             }
             
             .welcome-text {
                 font-size: 14px;
             }
             
             .heart-text {
                 font-size: 16px;
             }
             
             .welcome-close {
                 width: 28px;
                 height: 28px;
                 font-size: 16px;
             }
         }

         /* Admin Panel Styles */
         .admin-container {
             background: linear-gradient(135deg, 
                 rgba(255, 255, 255, 0.95) 0%, 
                 rgba(248, 245, 255, 0.9) 50%, 
                 rgba(240, 235, 255, 0.85) 100%);
             backdrop-filter: blur(20px);
             padding: 30px;
             border-radius: 25px;
             box-shadow: 
                 0 25px 50px rgba(150, 100, 255, 0.15),
                 0 15px 35px rgba(200, 150, 255, 0.1);
             border: 2px solid rgba(200, 180, 255, 0.3);
             max-width: 1000px;
             width: 95%;
             margin: 0 auto;
             max-height: 80vh;
             overflow-y: auto;
         }

         .admin-stats {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
             gap: 20px;
             margin-bottom: 30px;
         }

         .stat-card {
             background: rgba(255, 255, 255, 0.8);
             padding: 20px;
             border-radius: 15px;
             text-align: center;
             backdrop-filter: blur(10px);
             border: 1px solid rgba(200, 180, 255, 0.3);
         }

         .stat-number {
             font-size: 32px;
             font-weight: 700;
             color: rgba(120, 100, 180, 0.9);
             margin-bottom: 5px;
         }

         .stat-label {
             font-size: 14px;
             color: rgba(150, 130, 200, 0.8);
         }

         .admin-tabs {
             display: flex;
             margin-bottom: 30px;
             border-bottom: 2px solid rgba(200, 180, 255, 0.3);
         }

         .tab-btn {
             padding: 15px 25px;
             background: none;
             border: none;
             color: rgba(150, 130, 200, 0.8);
             cursor: pointer;
             transition: all 0.3s ease;
             border-bottom: 3px solid transparent;
         }

         .tab-btn.active {
             color: rgba(120, 100, 180, 1);
             border-bottom-color: rgba(180, 160, 255, 0.8);
         }

         .tab-content {
             display: none;
         }

         .tab-content.active {
             display: block;
         }

         .user-search {
             display: flex;
             gap: 15px;
             margin-bottom: 20px;
         }

         .user-search input {
             flex: 1;
             padding: 12px 20px;
             border: 2px solid rgba(200, 180, 255, 0.3);
             border-radius: 15px;
             background: rgba(255, 255, 255, 0.8);
         }

         .users-table,
         .ips-table {
             background: rgba(255, 255, 255, 0.8);
             border-radius: 15px;
             overflow: hidden;
             backdrop-filter: blur(10px);
         }

         .users-table table,
         .ips-table table {
             width: 100%;
             border-collapse: collapse;
         }

         .users-table th,
         .users-table td,
         .ips-table th,
         .ips-table td {
             padding: 12px 15px;
             text-align: left;
             border-bottom: 1px solid rgba(200, 180, 255, 0.2);
         }

         .users-table th,
         .ips-table th {
             background: rgba(200, 180, 255, 0.2);
             font-weight: 600;
             color: rgba(120, 100, 180, 0.9);
         }

         .users-table td,
         .ips-table td {
             color: rgba(80, 60, 120, 0.8);
         }

         .status-active {
             color: #22c55e;
             font-weight: 600;
         }

         .status-disabled {
             color: #ef4444;
             font-weight: 600;
         }

         .role-admin {
             color: #f59e0b;
             font-weight: 600;
         }

         .role-user {
             color: #6366f1;
             font-weight: 600;
         }

         .action-btn {
             padding: 6px 12px;
             margin: 0 3px;
             border: none;
             border-radius: 8px;
             cursor: pointer;
             font-size: 12px;
             transition: all 0.3s ease;
         }

         .action-btn.edit {
             background: rgba(59, 130, 246, 0.8);
             color: white;
         }

         .action-btn.delete {
             background: rgba(239, 68, 68, 0.8);
             color: white;
         }

         .action-btn.unblock {
             background: rgba(34, 197, 94, 0.8);
             color: white;
         }

         /* Modal Styles */
         .modal {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.5);
             backdrop-filter: blur(10px);
             z-index: 1000;
             display: flex;
             align-items: center;
             justify-content: center;
         }

         .modal-content {
             background: linear-gradient(135deg, 
                 rgba(255, 255, 255, 0.95) 0%, 
                 rgba(248, 245, 255, 0.9) 100%);
             padding: 30px;
             border-radius: 20px;
             max-width: 500px;
             width: 90%;
             backdrop-filter: blur(20px);
             border: 2px solid rgba(200, 180, 255, 0.3);
         }

         .modal-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 20px;
             padding-bottom: 15px;
             border-bottom: 1px solid rgba(200, 180, 255, 0.3);
         }

         .modal-header h3 {
             color: rgba(120, 100, 180, 0.9);
             margin: 0;
         }

         .modal-close {
             background: none;
             border: none;
             font-size: 24px;
             color: rgba(150, 130, 200, 0.8);
             cursor: pointer;
             transition: color 0.3s ease;
         }

         .modal-close:hover {
             color: rgba(120, 100, 180, 1);
         }

         .modal-footer {
             display: flex;
             gap: 15px;
             justify-content: flex-end;
             margin-top: 25px;
             padding-top: 15px;
             border-top: 1px solid rgba(200, 180, 255, 0.3);
         }

         /* Page Display Control */
         .hidden {
             display: none !important;
         }

         /* User Header */
         .user-header {
             position: fixed;
             top: 20px;
             right: 20px;
             z-index: 100;
             display: flex;
             align-items: center;
             gap: 15px;
             background: rgba(255, 255, 255, 0.9);
             padding: 10px 20px;
             border-radius: 20px;
             backdrop-filter: blur(15px);
             border: 1px solid rgba(200, 180, 255, 0.3);
         }

         .user-welcome {
             color: rgba(120, 100, 180, 0.9);
             font-weight: 600;
         }

         .user-actions {
             display: flex;
             gap: 10px;
         }

         .user-action-btn {
             padding: 8px 15px;
             background: rgba(180, 160, 255, 0.8);
             color: white;
             border: none;
             border-radius: 15px;
             cursor: pointer;
             font-size: 12px;
             transition: all 0.3s ease;
         }

         .user-action-btn:hover {
             background: rgba(180, 160, 255, 1);
             transform: translateY(-1px);
         }

         /* Responsive Design */
         @media (max-width: 768px) {
             .auth-container {
                 padding: 30px 20px;
                 margin: 20px;
             }
             
             .admin-container {
                 padding: 20px;
                 margin: 20px;
             }
             
             .admin-stats {
                 grid-template-columns: repeat(2, 1fr);
             }
             
                         .user-header {
                position: relative;
                top: auto;
                right: auto;
                margin: 20px;
                justify-content: center;
            }
        }
        
        /* Love Bell Styles - Updated to use image */
        .love-bell-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 200px;
            height: 200px;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .love-bell {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('./ÊÅãÁà±ÈìÉ.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: bellFloat 3s ease-in-out infinite;
        }
        
        .love-bell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwhLS0gQmVsbCBTaGFwZSAtLT4KPHBhdGggZD0iTTEwMCAyMEMxMzAgMjAgMTUwIDQwIDE1MCA3MEMwIDkwIDgwIDEwMCA4MCAxMjBDODAgMTMwIDkwIDE0MCAxMDAgMTQwQzExMCAxNDAgMTIwIDEzMCAxMjAgMTIwQzEyMCAxMDAgMjAwIDkwIDIwMCA3MEMwIDQwIDE3MCAyMCAxMDAgMjBaIiBmaWxsPSJ1cmwoI2JlbGxHcmFkaWVudCkiLz4KPCEtLSBIZWFydCBDbGFwcGVyIC0tPgo8cGF0aCBkPSJNODAgODBDODAgNzAgOTAgNjAgMTAwIDYwQzExMCA2MCAxMjAgNzAgMTIwIDgwQzEyMCA5MCAxMTAgMTAwIDEwMCAxMDBDOTAgMTAwIDgwIDkwIDgwIDgwWiIgZmlsbD0iI2ZmNjk5YiIvPgo8IS0tIEJ1dHRlcmZsaWVzIC0tPgo8cGF0aCBkPSJNMzAgMzBDMzAgMjAgNDAgMTAgNTAgMTBDNjAgMTAgNzAgMjAgNzAgMzBDNzAgNDAgNjAgNTAgNTAgNTBDNDAgNTAgMzAgNDAgMzAgMzBaIiBmaWxsPSJ1cmwoI2J1dHRlcmZseUdyYWRpZW50KSIvPgo8cGF0aCBkPSJNMTMwIDMwQzEzMCAyMCAxNDAgMTAgMTUwIDEwQzE2MCAxMCAxNzAgMjAgMTcwIDMwQzE3MCA0MCAxNjAgNTAgMTUwIDUwQzE0MCA1MCAxMzAgNDAgMTMwIDMwWiIgZmlsbD0idXJsKCNidXR0ZXJmbHlHcmFkaWVudCkiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iYmVsbEdyYWRpZW50IiB4MT0iMCIgeTE9IjAiIHgyPSIyMDAiIHkyPSIyMDAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2Q2YzJlOTtzdG9wLW9wYWNpdHk6MC42Ii8+CjxzdG9wIG9mZnNldD0iNTAlIiBzdHlsZT0ic3RvcC1jb2xvcjojYjVkOGViO3N0b3Atb3BhY2l0eTowLjgiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojYzdlOWMwO3N0b3Atb3BhY2l0eTowLjYiLz4KPC9saW5lYXJHcmFkaWVudD4KPGxpbmVhckdyYWRpZW50IGlkPSJidXR0ZXJmbHlHcmFkaWVudCIgeDE9IjAiIHkxPSIwIiB4Mj0iMTAwIiB5Mj0iMTAwIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmNGI4ZTQ7c3RvcC1vcGFjaXR5OjAuNiIvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmOWU5YjA7c3RvcC1vcGFjaXR5OjAuOCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 1;
        }
        
        /* Glowing effect */
        .love-bell::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse, rgba(255, 182, 193, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
            animation: bellGlow 2s ease-in-out infinite;
        }
        
        @keyframes bellFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(2deg); }
        }
        
        @keyframes bellGlow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }
        
        .love-bell-wrapper:hover .love-bell {
            transform: scale(1.1);
            filter: brightness(1.2);
        }
        
        .love-bell-wrapper.clicked .love-bell {
            animation: bellRing 0.8s ease-in-out;
        }
        
        @keyframes bellRing {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-5deg); }
            50% { transform: scale(1.1) rotate(5deg); }
            75% { transform: scale(1.15) rotate(-3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        /* Countdown Love Bell Styles - Updated to use image */
        .countdown-love-bell {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 20px;
        }
        
        .countdown-bell-structure {
            position: relative;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjwhLS0gQ291bnRkb3duIEJlbGwgLS0+CjxwYXRoIGQ9Ik03NSAyMEMxMTAgMjAgMTMwIDQwIDEzMCA3NUMxMzAgOTAgNjAgMTAwIDYwIDEyNUM2MCAxMzUgNzAgMTQ1IDc1IDE0NUM4MCAxNDUgOTAgMTM1IDkwIDEyNUM5MCAxMDAgMTgwIDkwIDE4MCA3NUMwIDQwIDE2MCAyMCA3NSAyMFoiIGZpbGw9InVybCgjY291bnRkb3duQmVsbEdyYWRpZW50KSIvPgo8IS0tIEhlYXJ0IENsYXBwZXIgLS0+CjxwYXRoIGQ9Ik02MCA2MEM2MCA1MCA3MCA0MCA3NSA0MEM4MCA0MCA5MCA1MCA5MCA2MEM5MCA3MCA4MCA4MCA3NSA4MEM3MCA4MCA2MCA3MCA2MCA2MFoiIGZpbGw9IiNmZjY5OWIiLz4KPCEtLSBCdXR0ZXJmbGllcyAtLT4KPHBhdGggZD0iTTIyIDIyQzIyIDEyIDMyIDIgNDIgMkM1MiAyIDYyIDEyIDYyIDIyQzYyIDMyIDUyIDQyIDQyIDQyQzMyIDQyIDIyIDMyIDIyIDIyWiIgZmlsbD0idXJsKCNjb3VudGRvd25CdXR0ZXJmbHlHcmFkaWVudCkiLz4KPHBhdGggZD0iTTk4IDIyQzk4IDEyIDEwOCAyIDExOCAyQzEyOCAyIDEzOCAxMiAxMzggMjJDMTM4IDMyIDEyOCA0MiAxMTggNDJDMTA4IDQyIDk4IDMyIDk4IDIyWiIgZmlsbD0idXJsKCNjb3VudGRvd25CdXR0ZXJmbHlHcmFkaWVudCkiLz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iY291bnRkb3duQmVsbEdyYWRpZW50IiB4MT0iMCIgeTE9IjAiIHgyPSIxNTAiIHkyPSIxNTAiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agb2Zmc2V0PSIwJSIgc3R5bGU9InN0b3AtY29sb3I6I2ZmYjdkNTtzdG9wLW9wYWNpdHk6MC42Ii8+CjxzdG9wIG9mZnNldD0iNTAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZmY5YWFkO3N0b3Atb3BhY2l0eTowLjgiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdHlsZT0ic3RvcC1jb2xvcjojZDRjMmU5O3N0b3Atb3BhY2l0eTowLjYiLz4KPC9saW5lYXJHcmFkaWVudD4KPGxpbmVhckdyYWRpZW50IGlkPSJjb3VudGRvd25CdXR0ZXJmbHlHcmFkaWVudCIgeDE9IjAiIHkxPSIwIiB4Mj0iMTAwIiB5Mj0iMTAwIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmNGI4ZTQ7c3RvcC1vcGFjaXR5OjAuNiIvPgo8c3RvcCBvZmZzZXQ9IjEwMCUiIHN0eWxlPSJzdG9wLWNvbG9yOiNmOWU5YjA7c3RvcC1vcGFjaXR5OjAuOCIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo=');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: countdownBellPulse 2s ease-in-out infinite;
        }
        
        @keyframes countdownBellPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        @keyframes bellGlowPulse {
            0%, 100% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 30px rgba(255, 182, 193, 0.8));
            }
            50% { 
                transform: scale(1.1); 
                filter: drop-shadow(0 0 50px rgba(255, 182, 193, 1));
            }
        }
        
        @keyframes popupFadeIn {
            0% { 
                opacity: 0; 
                transform: scale(0.8);
            }
            100% { 
                opacity: 1; 
                transform: scale(1);
            }
        }
        
        @keyframes popupFadeOut {
            0% { 
                opacity: 1; 
                transform: scale(1);
            }
            100% { 
                opacity: 0; 
                transform: scale(0.8);
            }
        }
        
        .countdown-heart-clapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 15;
        }
        
        .countdown-heart-gem {
            width: 30px;
            height: 30px;
            background: linear-gradient(135deg, 
                rgba(255, 20, 147, 0.9) 0%, 
                rgba(199, 21, 133, 0.8) 50%, 
                rgba(255, 105, 180, 0.9) 100%);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            box-shadow: 
                0 0 20px rgba(255, 20, 147, 0.8),
                inset 0 0 10px rgba(255, 255, 255, 0.3);
            animation: countdownHeartPulse 2s ease-in-out infinite;
        }
        
        .countdown-heart-suspension {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 10px;
            background: linear-gradient(to bottom, 
                rgba(200, 150, 255, 0.8), 
                rgba(150, 100, 255, 0.6));
            box-shadow: 0 0 5px rgba(200, 150, 255, 0.6);
        }
        
        .countdown-clapper-bead {
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, 
                rgba(255, 215, 0, 0.9), 
                rgba(255, 165, 0, 0.8));
            border-radius: 50%;
            box-shadow: 
                0 0 10px rgba(255, 215, 0, 0.8),
                inset 0 0 3px rgba(255, 255, 255, 0.3);
        }
        
        .countdown-internal-light {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse, 
                rgba(200, 150, 255, 0.3) 0%, 
                transparent 70%);
            border-radius: 50px;
            z-index: 1;
        }
        
        .countdown-sparkles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 8;
        }
        
        .countdown-sparkle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.8);
            animation: countdownSparkleFloat 3s ease-in-out infinite;
        }
        
        .countdown-sparkle.sparkle-1 {
            top: 20px;
            left: 30px;
            animation-delay: 0s;
        }
        
        .countdown-sparkle.sparkle-2 {
            top: 40px;
            right: 25px;
            animation-delay: -1s;
        }
        
        .countdown-sparkle.sparkle-3 {
            bottom: 30px;
            left: 20px;
            animation-delay: -2s;
        }
        
        .countdown-sparkle.sparkle-4 {
            bottom: 50px;
            right: 30px;
            animation-delay: -0.5s;
        }
        
        .countdown-sparkle.sparkle-5 {
            top: 60px;
            left: 50px;
            animation-delay: -1.5s;
        }
        
        .countdown-butterfly {
            position: absolute;
            top: 10px;
            z-index: 10;
            animation: countdownButterflyFloat 3s ease-in-out infinite;
        }
        
        .countdown-butterfly-left {
            left: -20px;
        }
        
        .countdown-butterfly-right {
            right: -20px;
        }
        
        .countdown-butterfly-body {
            position: absolute;
            width: 6px;
            height: 15px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.9), 
                rgba(255, 182, 193, 0.7));
            border-radius: 3px;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }
        
        .countdown-butterfly-wing-right {
            position: absolute;
            width: 25px;
            height: 18px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.6) 0%, 
                rgba(255, 182, 193, 0.8) 50%, 
                rgba(255, 160, 180, 0.6) 100%);
            border-radius: 50% 50% 0 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 182, 193, 0.7);
        }
        
        .countdown-butterfly-wing-left {
            position: absolute;
            width: 22px;
            height: 15px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.5) 0%, 
                rgba(255, 182, 193, 0.7) 50%, 
                rgba(255, 160, 180, 0.5) 100%);
            border-radius: 50% 50% 0 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) scaleX(-1);
            box-shadow: 0 0 10px rgba(255, 182, 193, 0.6);
        }
        
        .countdown-butterfly-antenna {
            position: absolute;
            width: 1px;
            height: 6px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.9), 
                transparent);
            left: 50%;
            top: -3px;
            transform: translateX(-50%) rotate(-15deg);
        }
        
        .countdown-bell-glow {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 60px;
            background: radial-gradient(ellipse, 
                rgba(255, 182, 193, 0.5) 0%, 
                transparent 70%);
            border-radius: 40px 40px 0 0;
            z-index: 1;
        }
        
        .countdown-butterfly-glow {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 25px;
            background: radial-gradient(ellipse, 
                rgba(255, 182, 193, 0.6) 0%, 
                transparent 70%);
            z-index: 8;
        }
        
        @keyframes countdownBellPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }
        
        @keyframes countdownButterflyFloat {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-5px); }
        }
        
        /* Message List Page Styles */
        #message-list-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .message-list-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #fff0f7 0%, #f0f0ff 50%, #f0fff7 100%);
            z-index: -2;
        }
        
        .message-list-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: -1;
        }
        
        .message-list-header {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(200, 180, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .back-to-home {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #666;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .back-to-home:hover {
            background: rgba(255, 182, 193, 0.2);
            color: #ff69b4;
        }
        
        .message-list-title {
            font-size: 1.8rem;
            color: #333;
            margin: 0 0 5px 0;
            background: linear-gradient(to right, var(--sakura-pink), var(--pastel-magenta));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .message-list-subtitle {
            font-size: 1rem;
            color: #666;
            margin: 0;
        }
        
        .message-list-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(200, 180, 255, 0.3);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .message-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 182, 193, 0.3);
        }
        
        .message-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .message-info {
            flex: 1;
        }
        
        .message-character-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        
        .message-last-time {
            font-size: 0.9rem;
            color: #666;
        }
        
        .message-preview {
            font-size: 0.95rem;
            color: #555;
            line-height: 1.4;
            margin-top: 8px;
        }
        
        .message-count {
            background: linear-gradient(135deg, var(--sakura-pink), var(--pastel-magenta));
            color: white;
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: auto;
        }
        
        /* Bell Hover Effects */
        .love-bell-wrapper:hover .love-bell {
            animation: bellRing 0.6s ease-in-out;
        }
        
        .love-bell-wrapper:hover .bell-arc {
            box-shadow: 
                0 0 50px rgba(200, 150, 255, 0.8),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }
        
        .love-bell-wrapper:hover .ethereal-butterfly {
            animation: butterflyFloat 2s ease-in-out infinite;
        }
        
        .love-bell-wrapper:hover .butterfly-glow {
            background: radial-gradient(ellipse, 
                rgba(200, 150, 255, 0.6) 0%, 
                transparent 70%);
        }
        
        @keyframes bellRing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-15deg); }
            75% { transform: rotate(15deg); }
        }
        
        /* Active Bell State */
        .love-bell-wrapper.clicked .bell-arc {
            background: linear-gradient(135deg, 
                rgba(255, 105, 180, 0.3) 0%, 
                rgba(255, 20, 147, 0.4) 50%, 
                rgba(199, 21, 133, 0.3) 100%);
            box-shadow: 
                0 0 80px rgba(255, 105, 180, 1),
                inset 0 0 50px rgba(255, 255, 255, 0.3);
        }
        
        .love-bell-wrapper.clicked .ethereal-butterfly {
            animation: butterflyRing 0.8s ease-in-out;
        }
        
        .love-bell-wrapper.clicked .butterfly-glow {
            background: radial-gradient(ellipse, 
                rgba(255, 105, 180, 0.6) 0%, 
                transparent 70%);
        }
        
        /* Mobile Responsive for Love Bell */
        @media (max-width: 768px) {
            .love-bell-wrapper {
                width: 150px;
                height: 150px;
            }
            
            .bell-body {
                width: 90px;
                height: 105px;
            }
            
            .bell-heart {
                font-size: 1.5rem;
            }
        }
    </style>
    </head>
    <body>
        <!-- Background Music -->
        <audio id="background-music" loop>
            <source src="./bluming.MP3" type="audio/mpeg">
            <source src="./bluming.mp3" type="audio/mpeg">
            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ„ÄÇ
        </audio>
    <!-- Background Elements -->
    <div class="anime-bg"></div>
    
    <!-- Top Notification Toast -->
    <div id="top-notification" class="top-notification hidden">
        <span id="notification-message"></span>
    </div>
    
    <!-- Unlock Limit Modal -->
    <div id="unlock-limit-modal" class="unlock-limit-modal hidden">
        <div class="unlock-limit-content" onclick="event.stopPropagation()">
            <div class="unlock-limit-header">
                <h3>üì± ÊØèÊó•Ëß£ÈîÅÈôêÂà∂</h3>
                <button class="unlock-limit-close" onclick="closeUnlockLimitModal()">√ó</button>
            </div>
            <div class="unlock-limit-body">
                <p>ÊÇ®‰ªäÂ§©Â∑≤ÁªèËß£ÈîÅ‰∫Ü4‰ΩçËßíËâ≤ÔºåÂ∑≤ËææÂà∞ÊØèÊó•‰∏äÈôêÔΩû</p>
                <p>ÊòéÂ§©0ÁÇπÂêéÂèØ‰ª•ÁªßÁª≠Ëß£ÈîÅÊñ∞ËßíËâ≤Âì¶ÔºÅ</p>
                <div class="unlock-limit-icon">üîí</div>
            </div>
            <div class="unlock-limit-footer">
                <button class="unlock-limit-btn" onclick="closeUnlockLimitModal()">Áü•ÈÅì‰∫Ü</button>
            </div>
        </div>
    </div>
    
    <!-- Welcome Modal -->
    <div id="welcome-modal" class="welcome-modal hidden" onclick="closeWelcomeModal()">
        <div class="welcome-content" onclick="event.stopPropagation()">
            <button class="welcome-close" onclick="closeWelcomeModal()">√ó</button>
            <div class="welcome-sticky-note">
                <h2 class="welcome-title">Ê¨¢ËøéÊù•Âà∞ÊÅãÁà±ÈìÉÔΩû</h2>
                <div class="welcome-text">
                    <p>ÊØèÂ§©ÈöèÊú∫Ëß£ÈîÅÂõõ‰ΩçÁ•ûÁßòpartner</p>
                    <p>Á¥ØËÆ°ÂØπËØù10Âè•Âç≥ÂèØËß¶ÂèëÊÅãÁà±ÈìÉüîî</p>
                    <p>ÂìçÈìÉÂç≥ÂèØÁªßÁª≠Êµ™Êº´‰πãÊóÖ ËÅä‰∏çÊù•Â∞±say bye~</p>
                    <p>‰∏ªÂä®ÊùÉÊéåÊè°Âú®‰Ω†ÊâãÈáåÔºÅ</p>
                </div>
                <div class="welcome-footer">
                    <span class="heart-text">ÂøÉÂä® Â∞±Áé∞Âú®üíì</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create Floating Petals - Optimized -->
    <script>
        // Reduced number of petals for better performance
        for (let i = 0; i < 8; i++) {
            const petal = document.createElement('div');
            petal.classList.add('floating-petal');
            petal.style.left = `${Math.random() * 100}%`;
            petal.style.animationDuration = `${15 + Math.random() * 20}s`;
            petal.style.animationDelay = `${Math.random() * 10}s`;
            petal.style.width = `${25 + Math.random() * 40}px`;
            petal.style.height = `${25 + Math.random() * 40}px`;
            petal.style.willChange = 'transform, opacity'; // Optimize for animations
            document.body.appendChild(petal);
        }
        
        // Reduced number of hearts for better performance
        for (let i = 0; i < 5; i++) {
            const heart = document.createElement('div');
            heart.classList.add('heart');
            heart.style.left = `${Math.random() * 100}%`;
            heart.style.animationDuration = `${20 + Math.random() * 20}s`;
            heart.style.animationDelay = `${Math.random() * 5}s`;
            heart.style.willChange = 'transform, opacity'; // Optimize for animations
            document.body.appendChild(heart);
        }
        
        // Reduced static sparkles - dynamic ones are handled separately
        for (let i = 0; i < 6; i++) {
            const sparkle = document.createElement('div');
            sparkle.classList.add('sparkle');
            sparkle.style.left = `${Math.random() * 100}%`;
            sparkle.style.top = `${Math.random() * 100}%`;
            sparkle.style.animationDelay = `${Math.random() * 2}s`;
            sparkle.style.willChange = 'transform, opacity'; // Optimize for animations
            document.body.appendChild(sparkle);
        }
    </script>
    
    <!-- User Header (shows when logged in) -->
    <div id="user-header" class="user-header hidden">
        <div class="user-welcome">
            ÊÅãÁà±ÈìÉÔºå<span id="current-username"></span>
        </div>
        <div class="user-actions">
                            <button id="profile-btn" class="user-action-btn">
                    <i class="fas fa-user"></i>
                </button>
                <button id="settings-btn" class="user-action-btn">
                    <i class="fas fa-cog"></i>
                </button>
            <button id="quick-logout-btn" class="user-action-btn">
                <i class="fas fa-sign-out-alt"></i> ÈÄÄÂá∫
            </button>
        </div>
    </div>

    <!-- Authentication Pages -->
    
    <!-- Login Page -->
    <div id="login-page">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="auth-title">üíñ ÊÅãÁà±ÈìÉ</h1>
                <p class="auth-subtitle">ÂñúÊ¨¢ÁöÑËØù ËØ∑ÂìçÈìÉÔΩû</p>
            </div>
            
            <form id="login-form" class="auth-form">
                <div class="form-group">
                    <i class="fas fa-user form-icon"></i>
                    <input type="text" id="login-username" placeholder="Áî®Êà∑Âêç" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="login-password" placeholder="ÂØÜÁ†Å" required>
                </div>
                
                <div class="form-options">
                    <label class="remember-me">
                        <input type="checkbox" id="remember-me">
                        <span>ËÆ∞‰ΩèÊàë</span>
                    </label>
                </div>
                
                <button type="submit" class="auth-btn primary">
                    <i class="fas fa-heart"></i> ÁôªÂΩï
                </button>
                
                <div class="auth-links">
                    <a href="#" id="show-register">ËøòÊ≤°ÊúâË¥¶Êà∑ÔºüÁ´ãÂç≥Ê≥®ÂÜå</a>
                </div>
            </form>
            
            <div id="login-error" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Register Page -->
    <div id="register-page" class="hidden">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="auth-title">üå∏ Âä†ÂÖ•ÊÅãÁà±ÈìÉ</h1>
                <p class="auth-subtitle">ÂàõÂª∫Ë¥¶Êà∑ÂºÄÂßã‰Ω†ÁöÑÊµ™Êº´‰πãÊóÖ</p>
            </div>
            
            <form id="register-form" class="auth-form">
                <div class="form-group">
                    <i class="fas fa-user form-icon"></i>
                    <input type="text" id="reg-username" placeholder="Áî®Êà∑ÂêçÔºà3-20Â≠óÁ¨¶Ôºâ" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-envelope form-icon"></i>
                    <input type="email" id="reg-email" placeholder="ÈÇÆÁÆ±Âú∞ÂùÄ" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="reg-password" placeholder="ÂØÜÁ†ÅÔºàËá≥Â∞ë6‰ΩçÔºâ" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="reg-password-confirm" placeholder="Á°ÆËÆ§ÂØÜÁ†Å" required>
                </div>
                
                <button type="submit" class="auth-btn primary">
                    <i class="fas fa-user-plus"></i> Ê≥®ÂÜå
                </button>
                
                <div class="auth-links">
                    <a href="#" id="show-login">Â∑≤ÊúâË¥¶Êà∑ÔºüÁ´ãÂç≥ÁôªÂΩï</a>
                </div>
            </form>
            
            <div id="register-error" class="error-message hidden"></div>
        </div>
    </div>

    <!-- User Profile Page -->
    <div id="profile-page" class="hidden">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="auth-title">üë§ ‰∏™‰∫∫‰ø°ÊÅØ</h1>
                <p class="auth-subtitle">ÁÆ°ÁêÜ‰Ω†ÁöÑË¥¶Êà∑‰ø°ÊÅØ</p>
            </div>
            
            <div class="profile-info">
                <div class="profile-item">
                    <label>Áî®Êà∑ÂêçÔºö</label>
                    <span id="profile-username"></span>
                </div>
                
                <div class="profile-item">
                    <label>ÈÇÆÁÆ±Ôºö</label>
                    <span id="profile-email"></span>
                </div>
                
                <div class="profile-item">
                    <label>ËßíËâ≤Ôºö</label>
                    <span id="profile-role"></span>
                </div>
                
                <div class="profile-item">
                    <label>Ê≥®ÂÜåÊó∂Èó¥Ôºö</label>
                    <span id="profile-created"></span>
                </div>
            </div>
            
            <form id="change-password-form" class="auth-form">
                <h3>‰øÆÊîπÂØÜÁ†Å</h3>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="current-password" placeholder="ÂΩìÂâçÂØÜÁ†Å" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="new-password" placeholder="Êñ∞ÂØÜÁ†Å" required>
                </div>
                
                <div class="form-group">
                    <i class="fas fa-lock form-icon"></i>
                    <input type="password" id="new-password-confirm" placeholder="Á°ÆËÆ§Êñ∞ÂØÜÁ†Å" required>
                </div>
                
                <button type="submit" class="auth-btn primary">
                    <i class="fas fa-key"></i> ‰øÆÊîπÂØÜÁ†Å
                </button>
            </form>
            
            <div class="profile-actions">
                <button id="back-to-chat" class="auth-btn secondary">
                    <i class="fas fa-comments"></i> ËøîÂõûËÅäÂ§©
                </button>
                
                <button id="admin-panel-btn" class="auth-btn admin hidden">
                    <i class="fas fa-cog"></i> ÁÆ°ÁêÜÂëòÈù¢Êùø
                </button>
                
                <button id="logout-btn" class="auth-btn danger">
                    <i class="fas fa-sign-out-alt"></i> ÈÄÄÂá∫ÁôªÂΩï
                </button>
            </div>
            
            <div id="profile-error" class="error-message hidden"></div>
        </div>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="hidden">
        <div class="auth-container">
            <div class="auth-header">
                <h1 class="auth-title">‚öôÔ∏è Á≥ªÁªüËÆæÁΩÆ</h1>
                <p class="auth-subtitle">ÈÖçÁΩÆAPIÂíåÁ≥ªÁªüÂèÇÊï∞</p>
            </div>
            
            <div class="settings-content">
                <div class="settings-section">
                    <h3>API ËÆæÁΩÆ</h3>
                    
                    <div class="settings-item">
                        <label for="api-url">APIÂú∞ÂùÄÔºö</label>
                        <input type="text" id="api-url" placeholder="ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ" value="https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions">
                    </div>
                    
                    <div class="settings-item">
                        <label for="api-key">APIÂØÜÈí•Ôºö</label>
                        <input type="password" id="api-key" placeholder="ËØ∑ËæìÂÖ•APIÂØÜÈí•">
                    </div>
                    
                    <div class="settings-item">
                        <label for="api-model">Ê®°ÂûãÔºö</label>
                        <input type="text" id="api-model" placeholder="ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞" value="qwen-plus">
                    </div>
                    
                    <button id="save-api-settings" class="auth-btn primary">
                        <i class="fas fa-save"></i> ‰øùÂ≠òËÆæÁΩÆ
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3>Èü≥‰πêËÆæÁΩÆ</h3>
                    
                    <div class="settings-item">
                        <label>ËÉåÊôØÈü≥‰πêÔºö</label>
                        <div class="music-controls">
                            <button id="play-music" class="music-btn play-btn">
                                <i class="fas fa-play"></i> ÂºÄÂêØ
                            </button>
                            <button id="pause-music" class="music-btn pause-btn">
                                <i class="fas fa-pause"></i> ÂÖ≥Èó≠
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-actions">
                <button id="back-to-profile" class="auth-btn secondary">
                    <i class="fas fa-arrow-left"></i> ËøîÂõû
                </button>
            </div>
            
            <div id="settings-error" class="error-message hidden"></div>
            <div id="settings-success" class="success-message hidden"></div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-page" class="hidden">
        <div class="admin-container">
            <div class="admin-header">
                <h1 class="auth-title">‚öôÔ∏è ÁÆ°ÁêÜÂëòÈù¢Êùø</h1>
                <p class="auth-subtitle">Áî®Êà∑ÁÆ°ÁêÜÂíåÁ≥ªÁªüËÆæÁΩÆ</p>
            </div>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">0</div>
                    <div class="stat-label">ÊÄªÁî®Êà∑Êï∞</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="active-users">0</div>
                    <div class="stat-label">Ê¥ªË∑ÉÁî®Êà∑</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="blocked-ips">0</div>
                    <div class="stat-label">Ë¢´Â∞ÅIP</div>
                </div>
            </div>
            
            <div class="admin-tabs">
                <button class="tab-btn active" data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ</button>
                <button class="tab-btn" data-tab="ips">IPÁÆ°ÁêÜ</button>
                <button class="tab-btn" data-tab="settings">Á≥ªÁªüËÆæÁΩÆ</button>
            </div>
            
            <div id="users-tab" class="tab-content active">
                <div class="user-search">
                    <input type="text" id="user-search" placeholder="ÊêúÁ¥¢Áî®Êà∑...">
                    <button id="search-users-btn" class="auth-btn secondary">ÊêúÁ¥¢</button>
                </div>
                
                <div class="users-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Áî®Êà∑Âêç</th>
                                <th>ÈÇÆÁÆ±</th>
                                <th>ËßíËâ≤</th>
                                <th>Áä∂ÊÄÅ</th>
                                <th>Ê≥®ÂÜåÊó∂Èó¥</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="ips-tab" class="tab-content">
                <div class="ip-actions">
                    <button id="clear-blocked-ips" class="auth-btn danger">Ê∏ÖÁ©∫Ë¢´Â∞ÅIP</button>
                </div>
                
                <div class="ips-table">
                    <table>
                        <thead>
                            <tr>
                                <th>IPÂú∞ÂùÄ</th>
                                <th>Â§±Ë¥•Ê¨°Êï∞</th>
                                <th>Â∞ÅÁ¶ÅÊó∂Èó¥</th>
                                <th>Ëß£Â∞ÅÊó∂Èó¥</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="blocked-ips-list">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="settings-tab" class="tab-content">
                <div class="settings-form">
                    <h3>Á≥ªÁªüËÆæÁΩÆ</h3>
                    
                    <div class="form-group">
                        <label>ÊúÄÂ§ßÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞Ôºö</label>
                        <input type="number" id="max-login-attempts" value="5" min="3" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label>IPÂ∞ÅÁ¶ÅÊó∂ÈïøÔºàÂ∞èÊó∂ÔºâÔºö</label>
                        <input type="number" id="ip-ban-duration" value="24" min="1" max="168">
                    </div>
                    
                    <button id="save-settings" class="auth-btn primary">‰øùÂ≠òËÆæÁΩÆ</button>
                </div>
            </div>
            
            <div class="admin-actions">
                <button id="back-to-profile" class="auth-btn secondary">
                    <i class="fas fa-user"></i> ËøîÂõû‰∏™‰∫∫‰∏≠ÂøÉ
                </button>
            </div>
            
            <div id="admin-error" class="error-message hidden"></div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-edit-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÁºñËæëÁî®Êà∑</h3>
                <button class="modal-close">&times;</button>
            </div>
            
            <form id="user-edit-form" class="modal-body">
                <input type="hidden" id="edit-user-id">
                
                <div class="form-group">
                    <label>Áî®Êà∑ÂêçÔºö</label>
                    <input type="text" id="edit-username" required>
                </div>
                
                <div class="form-group">
                    <label>ÈÇÆÁÆ±Ôºö</label>
                    <input type="email" id="edit-email" required>
                </div>
                
                <div class="form-group">
                    <label>ËßíËâ≤Ôºö</label>
                    <select id="edit-role">
                        <option value="user">ÊôÆÈÄöÁî®Êà∑</option>
                        <option value="admin">ÁÆ°ÁêÜÂëò</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Áä∂ÊÄÅÔºö</label>
                    <select id="edit-status">
                        <option value="active">Ê≠£Â∏∏</option>
                        <option value="disabled">Á¶ÅÁî®</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ÈáçÁΩÆÂØÜÁ†ÅÔºö</label>
                    <input type="password" id="edit-new-password" placeholder="ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπ">
                </div>
            </form>
            
            <div class="modal-footer">
                <button id="save-user-changes" class="auth-btn primary">‰øùÂ≠ò‰øÆÊîπ</button>
                <button id="cancel-user-edit" class="auth-btn secondary">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- Home Page -->
    <div id="homepage" class="container mx-auto px-4 py-8 h-screen flex flex-col items-center justify-center relative">
        <!-- Message Icon in Top Left -->
        <div class="message-icon-top-left">
            <button id="message-box-btn-top" class="message-icon-btn">
                <i class="fas fa-envelope"></i>
            </button>
        </div>
        
        <!-- Main Title -->
        <h1 class="main-title-luxury text-center">ÊÅãÁà±ÈìÉ</h1>
        
        <!-- Character Gallery - Horizontal Scrollable -->
        <div class="character-gallery-home">
            <!-- È°æÊôØÊ∑± -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-lorenzo">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">È°æÊôØÊ∑±</div>
            </div>
            
            <!-- ÁôΩÊüØ -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-dylan">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ÁôΩÊüØ</div>
            </div>
            
            <!-- ËÆ∏Ë®Ä -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-nate">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ËÆ∏Ë®Ä</div>
            </div>
            
            <!-- Â§èÂÖâÊ¥õ -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-asher">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">Â§èÂÖâÊ¥õ</div>
            </div>
            
            <!-- Ê≤àÁü•Áîª -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-shenzhihua">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">Ê≤àÁü•Áîª</div>
            </div>
            
            <!-- Êù®Ëã±Ê†º -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-yangyingge">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">Êù®Ëã±Ê†º</div>
            </div>
            
            <!-- ÂÆâÂÆá -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-anyu">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ÂÆâÂÆá</div>
            </div>
            
            <!-- Ë∞¢‰π¶Á•∫ -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-xieshuqi">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">Ë∞¢‰π¶Á•∫</div>
            </div>
            
            <!-- ÈôÜÂàôË°ç -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-luzeyan">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ÈôÜÂàôË°ç</div>
            </div>
            
            <!-- ËãèÁ†ö -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-suyan">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ËãèÁ†ö</div>
            </div>
            
            <!-- Ê∏©Á†öËàü -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-wenyanzhou">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">Ê∏©Á†öËàü</div>
            </div>
            
            <!-- ÂÇÖÈáé -->
            <div class="character-panel-home">
                <div class="character-silhouette-home character-bg-fuye">
                    <div class="glow-effect-home"></div>
                </div>
                <div class="character-name-below">ÂÇÖÈáé</div>
            </div>
        </div>
        
        <!-- Subtitle and Button Below Characters -->
        <div class="below-characters-section">
            <p>ÂñúÊ¨¢ÁöÑËØù ËØ∑ÂìçÈìÉÔΩû</p>
            
            <!-- Chat Button -->
            <button id="open-chat-btn" class="btn-anime">
                <i class="fas fa-heart"></i>
                ÂøÉÂä®Â∞±Âú®Áé∞Âú®
            </button>
        </div>
    </div>
    
         <!-- Chat List Page - Hidden in new game rules -->
     <div id="chat-list-page" class="hidden">
         <div class="chat-list-bg"></div>
         <div class="chat-list-overlay"></div>
         <div class="stars"></div>
        
        <!-- Close Button -->
        <button class="close-chat-list">
            <i class="fas fa-times"></i>
        </button>
        
                 <div class="chat-list-content">
             <div class="chat-list-header">
                 <h2 class="chat-list-title">ÂñúÊ¨¢ÁöÑËØù ËØ∑ÂìçÈìÉ</h2>
                 <p class="chat-list-subtitle">ÈÄâÊã©ÊéåÊè°Âú®‰Ω†Êâã‰∏≠ÔΩû</p>
             </div>
             
             <div class="character-gallery">
                 <!-- Lorenzo - Dominant CEO -->
                 <div class="character-silhouette">
                     <div class="silhouette-frame character-bg-lorenzo">
                         <div class="glow-effect"></div>
                         <div class="silhouette-bg"></div>

                         <div class="character-info-overlay">
                             <div class="character-name-silhouette">È°æÊôØÊ∑±</div>
                             <div class="character-type-silhouette">Dominant CEO</div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Dylan - Cool Police Officer -->
                 <div class="character-silhouette">
                     <div class="silhouette-frame character-bg-dylan">
                         <div class="glow-effect"></div>
                         <div class="silhouette-bg"></div>

                         <div class="character-info-overlay">
                             <div class="character-name-silhouette">ÁôΩÊüØ</div>
                             <div class="character-type-silhouette">Cool Police Officer</div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Nate - Gentle Doctor -->
                 <div class="character-silhouette">
                     <div class="silhouette-frame character-bg-nate">
                         <div class="glow-effect"></div>
                         <div class="silhouette-bg"></div>

                         <div class="character-info-overlay">
                             <div class="character-name-silhouette">ËÆ∏Ë®Ä</div>
                             <div class="character-type-silhouette">Gentle Doctor</div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Asher - Sunny Puppy Boy -->
                 <div class="character-silhouette">
                     <div class="silhouette-frame character-bg-asher">
                         <div class="glow-effect"></div>
                         <div class="silhouette-bg"></div>

                         <div class="character-info-overlay">
                             <div class="character-name-silhouette">Â§èÂÖâÊ¥õ</div>
                             <div class="character-type-silhouette">Sunny Puppy Boy</div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
    </div>
    
    <!-- Message List Page -->
    <div id="message-list-page" class="hidden">
        <div class="message-list-bg"></div>
        <div class="message-list-overlay"></div>
        
        <!-- Message List Header -->
        <div class="message-list-header">
            <button class="back-to-home" onclick="backToHomeFromMessageList()">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="message-list-title">üíå ÊàëÁöÑ‰ø°ÁÆ±</h2>
            <p class="message-list-subtitle">‰øùÁïôÁöÑÂØπËØùËÆ∞ÂΩï</p>
        </div>
        
        <!-- Message List Content -->
        <div class="message-list-content">
            <div id="message-list-items">
                <!-- Messages will be dynamically added here -->
            </div>
        </div>
    </div>
    
    <!-- SMS Chat Page -->
    <div id="sms-chat-page" class="hidden">
        <!-- Centered Chat Window Container -->
        <div class="chat-window-container">
            <!-- Chat Header -->
            <div class="sms-chat-header">
                <button class="back-to-list" onclick="backToHomeFromChat()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="sms-chat-info">
                    <div class="sms-char-info">
                        <h3 id="sms-char-name">ËÆ∏Ë®Ä</h3>
                        <p id="sms-char-status">ÂàöÂàöËøòÂú®Âíå‰Ω†ËÅäÂ§©,ÊÉ≥ÁªßÁª≠...</p>
                    </div>
                </div>
                <button class="header-avatar">
                    <i class="fas fa-user"></i>
                </button>
            </div>
            
            <!-- Chat Messages -->
            <div id="sms-messages" class="sms-messages">
                <div class="sms-timestamp">16:38</div>
                <div class="sms-message ai">
                    <img src="./ËÆ∏Ë®ÄÂ§¥ÂÉè.png" alt="" class="message-avatar">
                    <div class="sms-bubble ai nate">Â∞èÂÆùË¥ùÁªà‰∫éËàçÂæóÊâæÊàë‰∫Ü,ÊÉ≥‰Ω†ÊÉ≥ËÆ©ÊàëÂøÉÈÉΩËΩØÊàê‰∏ÄÁâá‰∫ÜÂë¢~</div>
                </div>
            </div>
            
            <!-- Typing Indicator -->
            <div id="typing-indicator" class="typing-indicator hidden">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <span class="typing-text">Ê≠£Âú®ËæìÂÖ•...</span>
            </div>
            
            <!-- Input Area -->
            <div class="sms-input-area">
                <button class="voice-btn">
                    <i class="fas fa-microphone"></i>
                </button>
                <input type="text" id="sms-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò..." class="sms-input" onkeypress="if(event.key==='Enter') sendSMSMessage()">
                <button class="emoji-btn">
                    <i class="fas fa-smile"></i>
                </button>
                <button class="add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    </div>
    
    <script>
                // This will be moved to the main initialization function
         
         // This will be moved to the main initialization function
        
                 // Authentication System
        
        // Utility Functions
        function generateRandomSalt() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }
        
        function hashPassword(password, salt) {
            // Simple hash function - in production, use stronger hashing
            let hash = 0;
            const str = password + salt;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return Math.abs(hash).toString(36);
        }
        
        function getClientIP() {
            // In real scenario, this would be handled server-side
            return 'user_ip_' + Math.random().toString(36).substring(2, 9);
        }
        
        // Storage Management
        class AuthStorage {
            static getUsers() {
                const users = localStorage.getItem('chatbot_users');
                return users ? JSON.parse(users) : {};
            }
            
            static saveUsers(users) {
                localStorage.setItem('chatbot_users', JSON.stringify(users));
            }
            
            static getCurrentUser() {
                const user = localStorage.getItem('chatbot_current_user');
                return user ? JSON.parse(user) : null;
            }
            
            static setCurrentUser(user) {
                if (user) {
                    localStorage.setItem('chatbot_current_user', JSON.stringify(user));
                } else {
                    localStorage.removeItem('chatbot_current_user');
                }
            }
            
            static getRememberMe() {
                return localStorage.getItem('chatbot_remember_me') === 'true';
            }
            
            static setRememberMe(remember) {
                localStorage.setItem('chatbot_remember_me', remember ? 'true' : 'false');
            }
            
            static getFailedAttempts() {
                const attempts = localStorage.getItem('chatbot_failed_attempts');
                return attempts ? JSON.parse(attempts) : {};
            }
            
            static saveFailedAttempts(attempts) {
                localStorage.setItem('chatbot_failed_attempts', JSON.stringify(attempts));
            }
            
            static getBlockedIPs() {
                const blocked = localStorage.getItem('chatbot_blocked_ips');
                return blocked ? JSON.parse(blocked) : {};
            }
            
            static saveBlockedIPs(blocked) {
                localStorage.setItem('chatbot_blocked_ips', JSON.stringify(blocked));
            }
            
            static getSettings() {
                const settings = localStorage.getItem('chatbot_settings');
                return settings ? JSON.parse(settings) : {
                    maxLoginAttempts: 5,
                    ipBanDuration: 24
                };
            }
            
            static saveSettings(settings) {
                localStorage.setItem('chatbot_settings', JSON.stringify(settings));
            }
        }
        
        // Authentication Manager
        class AuthManager {
            constructor() {
                this.currentUser = AuthStorage.getCurrentUser();
                this.initializeDefaultAdmin();
                this.checkAuthStatus();
            }
            
            initializeDefaultAdmin() {
                const users = AuthStorage.getUsers();
                if (Object.keys(users).length === 0) {
                    // Create default admin account
                    const adminSalt = generateRandomSalt();
                    const adminPassword = hashPassword('admin123', adminSalt);
                    
                    users['admin'] = {
                        id: 'admin',
                        username: 'admin',
                        email: 'admin@chatbot.com',
                        password: adminPassword,
                        salt: adminSalt,
                        role: 'admin',
                        status: 'active',
                        createdAt: new Date().toISOString(),
                        lastLogin: null
                    };
                    
                    AuthStorage.saveUsers(users);
                    console.log('Default admin account created: admin / admin123');
                }
            }
            
            checkAuthStatus() {
                if (this.currentUser && !AuthStorage.getRememberMe()) {
                    // Check if session should expire (for non-remembered sessions)
                    const loginTime = new Date(this.currentUser.lastLogin || 0);
                    const now = new Date();
                    const diffHours = (now - loginTime) / (1000 * 60 * 60);
                    
                    if (diffHours > 24) {
                        this.logout();
                        return false;
                    }
                }
                
                return !!this.currentUser;
            }
            
            isIPBlocked(ip = getClientIP()) {
                const blockedIPs = AuthStorage.getBlockedIPs();
                const blocked = blockedIPs[ip];
                
                if (!blocked) return false;
                
                const now = new Date();
                const blockTime = new Date(blocked.blockedAt);
                const settings = AuthStorage.getSettings();
                const diffHours = (now - blockTime) / (1000 * 60 * 60);
                
                if (diffHours >= settings.ipBanDuration) {
                    // Remove expired block
                    delete blockedIPs[ip];
                    AuthStorage.saveBlockedIPs(blockedIPs);
                    return false;
                }
                
                return true;
            }
            
            recordFailedAttempt(ip = getClientIP()) {
                const attempts = AuthStorage.getFailedAttempts();
                const settings = AuthStorage.getSettings();
                
                if (!attempts[ip]) {
                    attempts[ip] = { count: 0, firstAttempt: new Date().toISOString() };
                }
                
                attempts[ip].count++;
                attempts[ip].lastAttempt = new Date().toISOString();
                
                if (attempts[ip].count >= settings.maxLoginAttempts) {
                    // Block IP
                    const blockedIPs = AuthStorage.getBlockedIPs();
                    blockedIPs[ip] = {
                        blockedAt: new Date().toISOString(),
                        attempts: attempts[ip].count,
                        unblockAt: new Date(Date.now() + settings.ipBanDuration * 60 * 60 * 1000).toISOString()
                    };
                    AuthStorage.saveBlockedIPs(blockedIPs);
                    
                    // Reset attempts for this IP
                    delete attempts[ip];
                    
                    throw new Error(`IPÂú∞ÂùÄÂ∑≤Ë¢´Â∞ÅÁ¶Å${settings.ipBanDuration}Â∞èÊó∂ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ`);
                }
                
                AuthStorage.saveFailedAttempts(attempts);
                return settings.maxLoginAttempts - attempts[ip].count;
            }
            
            clearFailedAttempts(ip = getClientIP()) {
                const attempts = AuthStorage.getFailedAttempts();
                delete attempts[ip];
                AuthStorage.saveFailedAttempts(attempts);
            }
            
            register(username, email, password) {
                const users = AuthStorage.getUsers();
                
                // Validation
                if (username.length < 3 || username.length > 20) {
                    throw new Error('Áî®Êà∑ÂêçÈïøÂ∫¶ÂøÖÈ°ª‰∏∫3-20‰∏™Â≠óÁ¨¶');
                }
                
                if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(username)) {
                    throw new Error('Áî®Êà∑ÂêçÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏ãÂàíÁ∫øÂíå‰∏≠Êñá');
                }
                
                if (password.length < 6) {
                    throw new Error('ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç');
                }
                
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄ');
                }
                
                if (users[username]) {
                    throw new Error('Áî®Êà∑ÂêçÂ∑≤Â≠òÂú®');
                }
                
                // Check if email exists
                for (const user of Object.values(users)) {
                    if (user.email === email) {
                        throw new Error('ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜå');
                    }
                }
                
                // Create user
                const salt = generateRandomSalt();
                const hashedPassword = hashPassword(password, salt);
                
                users[username] = {
                    id: username,
                    username: username,
                    email: email,
                    password: hashedPassword,
                    salt: salt,
                    role: 'user',
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    lastLogin: null
                };
                
                AuthStorage.saveUsers(users);
                return users[username];
            }
            
            login(username, password, rememberMe = false) {
                const ip = getClientIP();
                
                if (this.isIPBlocked(ip)) {
                    const blockedIPs = AuthStorage.getBlockedIPs();
                    const blocked = blockedIPs[ip];
                    const unblockTime = new Date(blocked.unblockAt).toLocaleString('zh-CN');
                    throw new Error(`ÊÇ®ÁöÑIPÂ∑≤Ë¢´Â∞ÅÁ¶ÅÔºåËß£Â∞ÅÊó∂Èó¥Ôºö${unblockTime}`);
                }
                
                const users = AuthStorage.getUsers();
                const user = users[username];
                
                if (!user) {
                    this.recordFailedAttempt(ip);
                    throw new Error('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
                }
                
                if (user.status === 'disabled') {
                    throw new Error('Ë¥¶Êà∑Â∑≤Ë¢´Á¶ÅÁî®ÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò');
                }
                
                const hashedPassword = hashPassword(password, user.salt);
                if (hashedPassword !== user.password) {
                    this.recordFailedAttempt(ip);
                    throw new Error('Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ');
                }
                
                // Login successful
                this.clearFailedAttempts(ip);
                
                user.lastLogin = new Date().toISOString();
                users[username] = user;
                AuthStorage.saveUsers(users);
                
                this.currentUser = user;
                AuthStorage.setCurrentUser(user);
                AuthStorage.setRememberMe(rememberMe);
                
                return user;
            }
            
            logout() {
                this.currentUser = null;
                AuthStorage.setCurrentUser(null);
                AuthStorage.setRememberMe(false);
            }
            
            changePassword(currentPassword, newPassword) {
                if (!this.currentUser) {
                    throw new Error('Êú™ÁôªÂΩï');
                }
                
                if (newPassword.length < 6) {
                    throw new Error('Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç');
                }
                
                const users = AuthStorage.getUsers();
                const user = users[this.currentUser.username];
                
                const hashedCurrentPassword = hashPassword(currentPassword, user.salt);
                if (hashedCurrentPassword !== user.password) {
                    throw new Error('ÂΩìÂâçÂØÜÁ†ÅÈîôËØØ');
                }
                
                const newSalt = generateRandomSalt();
                const hashedNewPassword = hashPassword(newPassword, newSalt);
                
                user.password = hashedNewPassword;
                user.salt = newSalt;
                users[this.currentUser.username] = user;
                
                AuthStorage.saveUsers(users);
                this.currentUser = user;
                AuthStorage.setCurrentUser(user);
                
                return true;
            }
            
            getAllUsers() {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                return AuthStorage.getUsers();
            }
            
            updateUser(userId, updates) {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                
                const users = AuthStorage.getUsers();
                const user = users[userId];
                
                if (!user) {
                    throw new Error('Áî®Êà∑‰∏çÂ≠òÂú®');
                }
                
                // Update allowed fields
                if (updates.email !== undefined) {
                    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(updates.email)) {
                        throw new Error('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈÇÆÁÆ±Âú∞ÂùÄ');
                    }
                    user.email = updates.email;
                }
                
                if (updates.role !== undefined) {
                    user.role = updates.role;
                }
                
                if (updates.status !== undefined) {
                    user.status = updates.status;
                }
                
                if (updates.password) {
                    if (updates.password.length < 6) {
                        throw new Error('ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë‰∏∫6‰Ωç');
                    }
                    const newSalt = generateRandomSalt();
                    user.password = hashPassword(updates.password, newSalt);
                    user.salt = newSalt;
                }
                
                users[userId] = user;
                AuthStorage.saveUsers(users);
                
                return user;
            }
            
            deleteUser(userId) {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                
                if (userId === 'admin') {
                    throw new Error('‰∏çËÉΩÂà†Èô§ÁÆ°ÁêÜÂëòË¥¶Êà∑');
                }
                
                const users = AuthStorage.getUsers();
                delete users[userId];
                AuthStorage.saveUsers(users);
                
                return true;
            }
            
            getBlockedIPsList() {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                return AuthStorage.getBlockedIPs();
            }
            
            unblockIP(ip) {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                
                const blockedIPs = AuthStorage.getBlockedIPs();
                delete blockedIPs[ip];
                AuthStorage.saveBlockedIPs(blockedIPs);
                
                return true;
            }
            
            clearAllBlockedIPs() {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                
                AuthStorage.saveBlockedIPs({});
                return true;
            }
            
            updateSettings(settings) {
                if (!this.currentUser || this.currentUser.role !== 'admin') {
                    throw new Error('ÊùÉÈôê‰∏çË∂≥');
                }
                
                AuthStorage.saveSettings(settings);
                return true;
            }
            
            isLoggedIn() {
                return this.checkAuthStatus();
            }
            
            isAdmin() {
                return this.currentUser && this.currentUser.role === 'admin';
            }
            
            getCurrentUser() {
                return this.currentUser;
            }
        }

        // Global variables
        let authManager = null;
        let pageManager = null;

        // Page Management
        class PageManager {
            constructor() {
                this.currentPage = 'login';
                this.initializePages();
            }
            
            initializePages() {
                console.log('Initializing pages...');
                
                // First hide all pages to prevent flashing
                const pages = ['login-page', 'register-page', 'profile-page', 'settings-page', 'admin-page', 'homepage', 'chat-list-page', 'sms-chat-page', 'message-list-page'];
                pages.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                    }
                });
                
                // Check if user is logged in
                if (authManager.isLoggedIn()) {
                    console.log('User is logged in, showing homepage');
                    this.showPage('homepage');
                    this.showUserHeader();
                } else {
                    console.log('User is not logged in, showing login page');
                    this.showPage('login-page');
                }
                
                this.bindEvents();
                this.initBackgroundMusic();
            }
            
            showPage(pageId) {
                console.log('Showing page:', pageId);
                
                // Hide all pages
                const pages = ['login-page', 'register-page', 'profile-page', 'settings-page', 'admin-page', 'homepage', 'chat-list-page', 'sms-chat-page', 'message-list-page'];
                pages.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.classList.remove('active');
                        element.style.display = 'none';
                        console.log('Hidden page:', id);
                    }
                });
                
                // Show target page
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    targetPage.style.display = '';
                    
                    // Special handling for chat pages
                    if (pageId === 'chat-list-page') {
                        targetPage.classList.add('active');
                        targetPage.style.display = 'flex';
                    } else if (pageId === 'sms-chat-page') {
                        targetPage.classList.add('active');
                        targetPage.style.display = 'flex';
                    } else if (pageId === 'message-list-page') {
                        targetPage.classList.add('active');
                        targetPage.style.display = 'flex';
                    } else if (pageId === 'homepage') {
                        targetPage.style.display = 'flex';
                    } else {
                        targetPage.style.display = 'flex';
                    }
                    
                    this.currentPage = pageId;
                    console.log('Showed page:', pageId, 'Element exists:', !!targetPage);
                } else {
                    console.error('Target page not found:', pageId);
                }
                
                // Update user header visibility
                if (authManager.isLoggedIn() && !['login-page', 'register-page'].includes(pageId)) {
                    this.showUserHeader();
                } else {
                    this.hideUserHeader();
                }
            }
            
            showUserHeader() {
                const userHeader = document.getElementById('user-header');
                const currentUsername = document.getElementById('current-username');
                
                if (userHeader && currentUsername && authManager.currentUser) {
                    currentUsername.textContent = authManager.currentUser.username;
                    userHeader.classList.remove('hidden');
                }
            }
            
            hideUserHeader() {
                const userHeader = document.getElementById('user-header');
                if (userHeader) {
                    userHeader.classList.add('hidden');
                }
            }
            
            bindEvents() {
                // Login/Register form toggles
                document.getElementById('show-register')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showPage('register-page');
                });
                
                document.getElementById('show-login')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showPage('login-page');
                });
                
                // User header actions
                        document.getElementById('profile-btn')?.addEventListener('click', () => {
            this.showProfilePage();
        });
        
        document.getElementById('settings-btn')?.addEventListener('click', () => {
            this.showSettingsPage();
        });
                
                document.getElementById('quick-logout-btn')?.addEventListener('click', () => {
                    this.performLogout();
                });
                
                // Profile page actions
                document.getElementById('back-to-chat')?.addEventListener('click', () => {
                    this.showPage('homepage');
                });
                
                document.getElementById('admin-panel-btn')?.addEventListener('click', () => {
                    this.showAdminPage();
                });
                
                document.getElementById('logout-btn')?.addEventListener('click', () => {
                    this.performLogout();
                });
                
                // Admin page actions
                        document.getElementById('back-to-profile')?.addEventListener('click', () => {
            this.showProfilePage();
        });
        
        // Settings page actions
        document.getElementById('save-api-settings')?.addEventListener('click', () => {
            this.saveApiSettings();
        });
        
        document.getElementById('play-music')?.addEventListener('click', () => {
            this.playBackgroundMusic();
        });
        
        document.getElementById('pause-music')?.addEventListener('click', () => {
            this.pauseBackgroundMusic();
        });
                
                // Form submissions
                document.getElementById('login-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                document.getElementById('register-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegister();
                });
                
                document.getElementById('change-password-form')?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleChangePassword();
                });
                
                // Admin panel tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const targetTab = e.target.dataset.tab;
                        this.switchAdminTab(targetTab);
                    });
                });
                
                // Admin actions
                document.getElementById('clear-blocked-ips')?.addEventListener('click', () => {
                    this.clearAllBlockedIPs();
                });
                
                document.getElementById('search-users-btn')?.addEventListener('click', () => {
                    this.searchUsers();
                });
                
                document.getElementById('save-settings')?.addEventListener('click', () => {
                    this.saveSystemSettings();
                });
                
                // Modal actions
                document.querySelector('.modal-close')?.addEventListener('click', () => {
                    this.closeModal();
                });
                
                document.getElementById('cancel-user-edit')?.addEventListener('click', () => {
                    this.closeModal();
                });
                
                document.getElementById('save-user-changes')?.addEventListener('click', () => {
                    this.saveUserChanges();
                });
            }
            
            async handleLogin() {
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                const rememberMe = document.getElementById('remember-me').checked;
                const errorDiv = document.getElementById('login-error');
                
                try {
                    errorDiv.classList.add('hidden');
                    
                    const user = authManager.login(username, password, rememberMe);
                    
                                    // Show success and redirect
                this.showPage('homepage');
                this.showUserHeader();
                
                // Reload game state for the new user
                loadGameState();
                updateGameUI();
                
                // Show welcome modal after a short delay
                setTimeout(() => {
                    showWelcomeModal();
                }, 500);
                
                // Clear form
                document.getElementById('login-form').reset();
                    
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            async handleRegister() {
                const username = document.getElementById('reg-username').value.trim();
                const email = document.getElementById('reg-email').value.trim();
                const password = document.getElementById('reg-password').value;
                const confirmPassword = document.getElementById('reg-password-confirm').value;
                const errorDiv = document.getElementById('register-error');
                
                try {
                    errorDiv.classList.add('hidden');
                    
                    if (password !== confirmPassword) {
                        throw new Error('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                    }
                    
                    const user = authManager.register(username, email, password);
                    
                                    // Auto login after registration
                authManager.login(username, password, false);
                
                // Show success and redirect
                this.showPage('homepage');
                this.showUserHeader();
                
                // Reload game state for the new user
                loadGameState();
                updateGameUI();
                
                // Clear form
                document.getElementById('register-form').reset();
                    
                } catch (error) {
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            async handleChangePassword() {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('new-password-confirm').value;
                const errorDiv = document.getElementById('profile-error');
                
                try {
                    errorDiv.classList.add('hidden');
                    
                    if (newPassword !== confirmPassword) {
                        throw new Error('‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                    }
                    
                    authManager.changePassword(currentPassword, newPassword);
                    
                    // Show success message
                    errorDiv.className = 'success-message';
                    errorDiv.textContent = 'ÂØÜÁ†Å‰øÆÊîπÊàêÂäüÔºÅ';
                    errorDiv.classList.remove('hidden');
                    
                    // Clear form
                    document.getElementById('change-password-form').reset();
                    
                    setTimeout(() => {
                        errorDiv.classList.add('hidden');
                        errorDiv.className = 'error-message';
                    }, 3000);
                    
                } catch (error) {
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            showProfilePage() {
                if (!authManager.isLoggedIn()) {
                    this.showPage('login-page');
                    return;
                }
                
                const user = authManager.getCurrentUser();
                
                // Update profile information
                document.getElementById('profile-username').textContent = user.username;
                document.getElementById('profile-email').textContent = user.email;
                document.getElementById('profile-role').textContent = user.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : 'ÊôÆÈÄöÁî®Êà∑';
                document.getElementById('profile-created').textContent = new Date(user.createdAt).toLocaleString('zh-CN');
                
                // Show/hide admin panel button
                const adminBtn = document.getElementById('admin-panel-btn');
                if (adminBtn) {
                    if (authManager.isAdmin()) {
                        adminBtn.classList.remove('hidden');
                    } else {
                        adminBtn.classList.add('hidden');
                    }
                }
                
                this.showPage('profile-page');
            }
            
            saveApiSettings() {
                const apiUrl = document.getElementById('api-url').value.trim();
                const apiKey = document.getElementById('api-key').value.trim();
                const apiModel = document.getElementById('api-model').value.trim();
                
                if (!apiUrl) {
                    this.showError('settings-error', 'ËØ∑ËæìÂÖ•APIÂú∞ÂùÄ');
                    return;
                }
                
                if (!apiKey) {
                    this.showError('settings-error', 'ËØ∑ËæìÂÖ•APIÂØÜÈí•');
                    return;
                }
                
                if (!apiModel) {
                    this.showError('settings-error', 'ËØ∑ËæìÂÖ•Ê®°ÂûãÂêçÁß∞');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('apiUrl', apiUrl);
                localStorage.setItem('apiKey', apiKey);
                localStorage.setItem('apiModel', apiModel);
                
                // Show top notification
                this.showTopNotification('Êõ¥ÊîπÊàêÂäü', 2000);
            }
            
            showTopNotification(message, duration = 2000) {
                const notification = document.getElementById('top-notification');
                const messageElement = document.getElementById('notification-message');
                
                if (notification && messageElement) {
                    messageElement.textContent = message;
                    notification.classList.remove('hidden');
                    
                    // Ëß¶ÂèëÂä®Áîª
                    setTimeout(() => {
                        notification.classList.add('show');
                    }, 10);
                    
                    // Ëá™Âä®ÈöêËóè
                    setTimeout(() => {
                        notification.classList.remove('show');
                        setTimeout(() => {
                            notification.classList.add('hidden');
                        }, 300); // Á≠âÂæÖÂä®ÁîªÂÆåÊàê
                    }, duration);
                }
            }
            
            showWelcomeModal() {
                const modal = document.getElementById('welcome-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.add('show');
                    }, 10);
                }
            }
            
            closeWelcomeModal() {
                const modal = document.getElementById('welcome-modal');
                if (modal) {
                    modal.classList.remove('show');
                    setTimeout(() => {
                        modal.classList.add('hidden');
                    }, 300);
                }
            }
            
            showSettingsPage() {
                if (!authManager.isLoggedIn()) {
                    this.showPage('login-page');
                    return;
                }
                
                this.showPage('settings-page');
                
                // Load saved API settings after page is shown
                setTimeout(() => {
                    const savedApiUrl = localStorage.getItem('apiUrl') || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
                    const savedApiKey = localStorage.getItem('apiKey') || 'sk-891da8badd4745a5810c35b11b2c0dd3';
                    const savedApiModel = localStorage.getItem('apiModel') || 'qwen-plus';
                    
                    const apiUrlInput = document.getElementById('api-url');
                    const apiKeyInput = document.getElementById('api-key');
                    const apiModelInput = document.getElementById('api-model');
                    
                    if (apiUrlInput) apiUrlInput.value = savedApiUrl;
                    if (apiKeyInput) apiKeyInput.value = savedApiKey;
                    if (apiModelInput) apiModelInput.value = savedApiModel;
                    
                    // Update music control UI
                    this.updateMusicControlUI();
                }, 100);
            }
            
            playBackgroundMusic() {
                const music = document.getElementById('background-music');
                music.play().then(() => {
                    localStorage.setItem('musicEnabled', 'true');
                    this.updateMusicControlUI();
                }).catch(error => {
                    console.error('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:', error);
                    alert('Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆÊàñÈü≥È¢ëÊñá‰ª∂');
                });
            }
            
            pauseBackgroundMusic() {
                const music = document.getElementById('background-music');
                music.pause();
                localStorage.setItem('musicEnabled', 'false');
                this.updateMusicControlUI();
            }
            
            updateMusicControlUI() {
                const music = document.getElementById('background-music');
                const playBtn = document.getElementById('play-music');
                const pauseBtn = document.getElementById('pause-music');
                
                if (music && playBtn && pauseBtn) {
                    if (!music.paused) {
                        // Èü≥‰πêÊ≠£Âú®Êí≠Êîæ
                        playBtn.classList.remove('active');
                        playBtn.classList.add('inactive');
                        pauseBtn.classList.remove('inactive');
                        pauseBtn.classList.add('active');
                    } else {
                        // Èü≥‰πêÂ∑≤ÊöÇÂÅú
                        playBtn.classList.remove('inactive');
                        playBtn.classList.add('active');
                        pauseBtn.classList.remove('active');
                        pauseBtn.classList.add('inactive');
                    }
                }
            }
            
            initBackgroundMusic() {
                const music = document.getElementById('background-music');
                const musicEnabled = localStorage.getItem('musicEnabled');
                
                // ÈªòËÆ§ÂêØÁî®Èü≥‰πêÔºåÈô§ÈùûÁî®Êà∑ÊòéÁ°ÆÂÖ≥Èó≠
                if (musicEnabled === null || musicEnabled === 'true') {
                    // Áî±‰∫éÊµèËßàÂô®ÁöÑËá™Âä®Êí≠ÊîæÊîøÁ≠ñÔºåÈúÄË¶ÅÁî®Êà∑‰∫§‰∫íÂêéÊâçËÉΩÊí≠Êîæ
                    document.addEventListener('click', () => {
                        if (music.paused && (musicEnabled === null || musicEnabled === 'true')) {
                            music.play().catch(error => {
                                console.log('Èü≥È¢ëËá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåÈúÄË¶ÅÁî®Êà∑ÊâãÂä®ÂêØÂä®');
                            });
                        }
                    }, { once: true });
                }
            }
            
            showAdminPage() {
                if (!authManager.isAdmin()) {
                    this.showProfilePage();
                    return;
                }
                
                this.updateAdminStats();
                this.loadUsersTable();
                this.loadBlockedIPsTable();
                this.showPage('admin-page');
            }
            
            updateAdminStats() {
                const users = authManager.getAllUsers();
                const blockedIPs = authManager.getBlockedIPsList();
                
                const totalUsers = Object.keys(users).length;
                const activeUsers = Object.values(users).filter(u => u.status === 'active').length;
                const blockedIPsCount = Object.keys(blockedIPs).length;
                
                document.getElementById('total-users').textContent = totalUsers;
                document.getElementById('active-users').textContent = activeUsers;
                document.getElementById('blocked-ips').textContent = blockedIPsCount;
            }
            
            loadUsersTable() {
                const users = authManager.getAllUsers();
                const tbody = document.getElementById('users-list');
                
                tbody.innerHTML = '';
                
                Object.values(users).forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td><span class="role-${user.role}">${user.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : 'ÊôÆÈÄöÁî®Êà∑'}</span></td>
                        <td><span class="status-${user.status}">${user.status === 'active' ? 'Ê≠£Â∏∏' : 'Á¶ÅÁî®'}</span></td>
                        <td>${new Date(user.createdAt).toLocaleDateString('zh-CN')}</td>
                        <td>
                            <button class="action-btn edit" onclick="pageManager.editUser('${user.id}')">ÁºñËæë</button>
                            ${user.id !== 'admin' ? `<button class="action-btn delete" onclick="pageManager.deleteUser('${user.id}')">Âà†Èô§</button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            loadBlockedIPsTable() {
                const blockedIPs = authManager.getBlockedIPsList();
                const tbody = document.getElementById('blocked-ips-list');
                
                tbody.innerHTML = '';
                
                Object.entries(blockedIPs).forEach(([ip, data]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${ip}</td>
                        <td>${data.attempts}</td>
                        <td>${new Date(data.blockedAt).toLocaleString('zh-CN')}</td>
                        <td>${new Date(data.unblockAt).toLocaleString('zh-CN')}</td>
                        <td>
                            <button class="action-btn unblock" onclick="pageManager.unblockIP('${ip}')">Ëß£Â∞Å</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            editUser(userId) {
                // Implementation for user editing modal
                console.log('Edit user:', userId);
                // Show modal and populate with user data
            }
            
            deleteUser(userId) {
                if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§Áî®Êà∑ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                    try {
                        authManager.deleteUser(userId);
                        this.loadUsersTable();
                        this.updateAdminStats();
                    } catch (error) {
                        alert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message);
                    }
                }
            }
            
            unblockIP(ip) {
                if (confirm('Á°ÆÂÆöË¶ÅËß£Â∞ÅÊ≠§IPÂêóÔºü')) {
                    try {
                        authManager.unblockIP(ip);
                        this.loadBlockedIPsTable();
                        this.updateAdminStats();
                    } catch (error) {
                        alert('Ëß£Â∞ÅÂ§±Ë¥•Ôºö' + error.message);
                    }
                }
            }
            
            performLogout() {
                if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
                    authManager.logout();
                    
                    // Reset game state to default
                    resetToDefaultState();
                    
                    this.showPage('login-page');
                    this.hideUserHeader();
                }
            }
            
            switchAdminTab(tabName) {
                // Remove active class from all tabs and contents
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Add active class to selected tab and content
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
                
                // Load data for the selected tab
                if (tabName === 'users') {
                    this.loadUsersTable();
                } else if (tabName === 'ips') {
                    this.loadBlockedIPsTable();
                } else if (tabName === 'settings') {
                    this.loadSystemSettings();
                }
            }
            
            loadSystemSettings() {
                const settings = AuthStorage.getSettings();
                document.getElementById('max-login-attempts').value = settings.maxLoginAttempts;
                document.getElementById('ip-ban-duration').value = settings.ipBanDuration;
            }
            
            saveSystemSettings() {
                try {
                    const settings = {
                        maxLoginAttempts: parseInt(document.getElementById('max-login-attempts').value),
                        ipBanDuration: parseInt(document.getElementById('ip-ban-duration').value)
                    };
                    
                    if (settings.maxLoginAttempts < 3 || settings.maxLoginAttempts > 10) {
                        throw new Error('ÊúÄÂ§ßÁôªÂΩïÂ§±Ë¥•Ê¨°Êï∞ÂøÖÈ°ªÂú®3-10‰πãÈó¥');
                    }
                    
                    if (settings.ipBanDuration < 1 || settings.ipBanDuration > 168) {
                        throw new Error('IPÂ∞ÅÁ¶ÅÊó∂ÈïøÂøÖÈ°ªÂú®1-168Â∞èÊó∂‰πãÈó¥');
                    }
                    
                    authManager.updateSettings(settings);
                    
                    const errorDiv = document.getElementById('admin-error');
                    errorDiv.className = 'success-message';
                    errorDiv.textContent = 'ËÆæÁΩÆ‰øùÂ≠òÊàêÂäüÔºÅ';
                    errorDiv.classList.remove('hidden');
                    
                    setTimeout(() => {
                        errorDiv.classList.add('hidden');
                        errorDiv.className = 'error-message';
                    }, 3000);
                    
                } catch (error) {
                    const errorDiv = document.getElementById('admin-error');
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
            
            searchUsers() {
                const searchTerm = document.getElementById('user-search').value.trim().toLowerCase();
                const users = authManager.getAllUsers();
                const tbody = document.getElementById('users-list');
                
                tbody.innerHTML = '';
                
                Object.values(users).forEach(user => {
                    if (searchTerm === '' || 
                        user.username.toLowerCase().includes(searchTerm) ||
                        user.email.toLowerCase().includes(searchTerm)) {
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.username}</td>
                            <td>${user.email}</td>
                            <td><span class="role-${user.role}">${user.role === 'admin' ? 'ÁÆ°ÁêÜÂëò' : 'ÊôÆÈÄöÁî®Êà∑'}</span></td>
                            <td><span class="status-${user.status}">${user.status === 'active' ? 'Ê≠£Â∏∏' : 'Á¶ÅÁî®'}</span></td>
                            <td>${new Date(user.createdAt).toLocaleDateString('zh-CN')}</td>
                            <td>
                                <button class="action-btn edit" onclick="pageManager.editUser('${user.id}')">ÁºñËæë</button>
                                ${user.id !== 'admin' ? `<button class="action-btn delete" onclick="pageManager.deleteUser('${user.id}')">Âà†Èô§</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            }
            
            clearAllBlockedIPs() {
                if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâË¢´Â∞ÅIPÂêóÔºü')) {
                    try {
                        authManager.clearAllBlockedIPs();
                        this.loadBlockedIPsTable();
                        this.updateAdminStats();
                        
                        const errorDiv = document.getElementById('admin-error');
                        errorDiv.className = 'success-message';
                        errorDiv.textContent = 'Â∑≤Ê∏ÖÁ©∫ÊâÄÊúâË¢´Â∞ÅIPÔºÅ';
                        errorDiv.classList.remove('hidden');
                        
                        setTimeout(() => {
                            errorDiv.classList.add('hidden');
                            errorDiv.className = 'error-message';
                        }, 3000);
                        
                    } catch (error) {
                        const errorDiv = document.getElementById('admin-error');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = error.message;
                        errorDiv.classList.remove('hidden');
                    }
                }
            }
            
            editUser(userId) {
                const users = authManager.getAllUsers();
                const user = users[userId];
                
                if (!user) {
                    alert('Áî®Êà∑‰∏çÂ≠òÂú®');
                    return;
                }
                
                // Populate modal with user data
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-username').value = user.username;
                document.getElementById('edit-email').value = user.email;
                document.getElementById('edit-role').value = user.role;
                document.getElementById('edit-status').value = user.status;
                document.getElementById('edit-new-password').value = '';
                
                // Show modal
                document.getElementById('user-edit-modal').classList.remove('hidden');
            }
            
            closeModal() {
                document.getElementById('user-edit-modal').classList.add('hidden');
            }
            
            saveUserChanges() {
                try {
                    const userId = document.getElementById('edit-user-id').value;
                    const updates = {
                        email: document.getElementById('edit-email').value.trim(),
                        role: document.getElementById('edit-role').value,
                        status: document.getElementById('edit-status').value
                    };
                    
                    const newPassword = document.getElementById('edit-new-password').value;
                    if (newPassword) {
                        updates.password = newPassword;
                    }
                    
                    authManager.updateUser(userId, updates);
                    
                    // Close modal and refresh table
                    this.closeModal();
                    this.loadUsersTable();
                    this.updateAdminStats();
                    
                    const errorDiv = document.getElementById('admin-error');
                    errorDiv.className = 'success-message';
                    errorDiv.textContent = 'Áî®Êà∑‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ';
                    errorDiv.classList.remove('hidden');
                    
                    setTimeout(() => {
                        errorDiv.classList.add('hidden');
                        errorDiv.className = 'error-message';
                    }, 3000);
                    
                } catch (error) {
                    const errorDiv = document.getElementById('admin-error');
                    errorDiv.className = 'error-message';
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                }
            }
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Starting initialization...');
            
            try {
                // Initialize Authentication
                authManager = new AuthManager();
                console.log('AuthManager initialized:', authManager.isLoggedIn());
                
                // Initialize Page Manager
                pageManager = new PageManager();
                console.log('PageManager initialized, current page:', pageManager.currentPage);
            } catch (error) {
                console.error('Initialization error:', error);
            }
            
            // Load game state on initialization
            loadGameState();
            
            // For testing purposes - create a test user if none exists
            if (!authManager.isLoggedIn()) {
                console.log('Creating test user for debugging...');
                authManager.register('test', 'test123');
                authManager.login('test', 'test123');
            }
            
            // For testing purposes - add all 12 characters as unlocked
            if (Object.keys(gameState.unlockedCharacters).length === 0) {
                console.log('Adding all 12 characters as unlocked...');
                gameState.unlockedCharacters = {
                    'lorenzo': true,
                    'dylan': true,
                    'nate': true,
                    'asher': true,
                    'shenzhihua': true,
                    'yangyingge': true,
                    'anyu': true,
                    'xieshuqi': true,
                    'luzeyan': true,
                    'suyan': true,
                    'wenyanzhou': true,
                    'fuye': true
                };
                gameState.dailyRemaining = 12;
                gameState.maxMessages = 10;
                gameState.currentMessageCount = 0;
                gameState.loveBellTriggered = false;
                saveGameState();
            }
            
                         // Add test function to window for debugging
             window.testLoveBell = function() {
                 console.log('Testing love bell trigger...');
                 gameState.currentMessageCount = 10;
                 gameState.loveBellTriggered = false;
                 updateMessageCounter();
             };
             
             // Add test function to simulate user message
             window.testUserMessage = function() {
                 console.log('Testing user message...');
                 addUserMessage('ÊµãËØïÊ∂àÊÅØ');
             };
             
             // Add test function to force show countdown
             window.testShowCountdown = function() {
                 console.log('Testing show countdown...');
                 const countdownElement = document.getElementById('love-bell-countdown');
                 if (countdownElement) {
                     countdownElement.classList.remove('hidden');
                     countdownElement.style.display = 'block';
                     console.log('Countdown element shown manually');
                 } else {
                     console.error('Countdown element not found');
                 }
             };
             
             // Add test function to simulate 10 messages quickly
             window.test10Messages = function() {
                 console.log('Testing 10 messages...');
                 for (let i = 1; i <= 10; i++) {
                     setTimeout(() => {
                         addUserMessage(`ÊµãËØïÊ∂àÊÅØ ${i}`);
                     }, i * 100);
                 }
             };
             
             // Add test function to check current state
             window.checkState = function() {
                 console.log('Current game state:', gameState);
                 console.log('Current character:', currentCharacter);
                 console.log('Current conversation history length:', currentConversationHistory.length);
                 console.log('User messages count:', currentConversationHistory.filter(msg => msg.role === 'user').length);
             };
             
                         // Add test function to manually trigger chat
            window.testChat = function() {
                console.log('Testing chat function...');
                if (authManager.isLoggedIn()) {
                    startRandomChat();
                } else {
                    console.log('User not logged in');
                }
            };
            
            // Add debug function to check page elements
            window.debugElements = function() {
                console.log('Checking page elements...');
                console.log('open-chat-btn:', document.getElementById('open-chat-btn'));
                console.log('sms-chat-page:', document.getElementById('sms-chat-page'));
                console.log('sms-messages:', document.getElementById('sms-messages'));
                console.log('sms-char-name:', document.getElementById('sms-char-name'));
                console.log('sms-char-status:', document.getElementById('sms-char-status'));
                console.log('daily-remaining:', document.getElementById('daily-remaining'));
                console.log('unlock-status:', document.getElementById('unlock-status'));
                console.log('current-messages:', document.getElementById('current-messages'));
            };
            
            // Bind open chat button click
            const openChatBtn = document.getElementById('open-chat-btn');
            console.log('Open chat button found:', !!openChatBtn); // Debug log
            
            if (openChatBtn) {
                openChatBtn.addEventListener('click', function() {
                    console.log('Open chat button clicked!'); // Debug log
                    
                    // Check if user is logged in
                    if (!authManager.isLoggedIn()) {
                        console.log('User not logged in, showing login prompt'); // Debug log
                        // Show login modal or redirect to login
                        if (confirm('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜç‰ΩøÁî®ËÅäÂ§©ÂäüËÉΩ„ÄÇÊòØÂê¶Áé∞Âú®ÁôªÂΩïÔºü')) {
                            pageManager.showPage('login-page');
                        }
                        return;
                    }
                    
                    console.log('User is logged in, starting random chat'); // Debug log
                    console.log('Game state:', gameState); // Debug log
                    console.log('Character data keys:', Object.keys(characterData)); // Debug log
                    
                    // Start random chat matching
                    startRandomChat();
                    
                    // Add clicked animation effect
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = '';
                    }, 200);
                });
            } else {
                console.error('Open chat button not found!'); // Debug log
            }
            

            
            // Bind message box button (top left)
            document.getElementById('message-box-btn-top')?.addEventListener('click', function() {
                openMessageList();
                
                // Add animation effect
                this.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    this.style.transform = '';
                }, 200);
            });
            
            // Note: Character selection page events are no longer needed
            // as the new game uses random matching
            
            // Initialize homepage character click events for "ÂøÉÂä®Â∞±Áé∞Âú®" entry
            // Add a delay to ensure all DOM elements are fully loaded
            setTimeout(() => {
                initHomepageCharacterEvents();
            }, 200);
        });

                // Character Data with Rich Personalities
                 const characterData = {
            'È°æÊôØÊ∑±': {
                id: 'lorenzo',
                name: 'È°æÊôØÊ∑±',
                type: 'Dominant CEO',
                avatar: './È°æÊôØÊ∑±Â§¥ÂÉè.png',
                personality: 'È°∂Â±ÇÂäûÂÖ¨ÂÆ§ÁöÑ‰∏ªÂÆ∞ËÄÖÔºåÂÆöÂà∂Ë•øË£ÖÂíåÂÜ∑Á°¨Ê∞îÂú∫ÊòØ‰ªñÁöÑÊ†áÈÖç„ÄÇ‰π†ÊÉØÁî®È£üÊåáÂÖ≥ËäÇËΩªÂè©Ê°åÈù¢Ôºå‰∏çËãüË®ÄÁ¨ëÔºåËÆ©‰∫∫‰∏çÊï¢Áõ¥ËßÜ„ÄÇ‰ΩÜÊ∑±Â§úÁã¨Â§ÑÊó∂‰ºöÊë©Êå≤ÁùÄÁ†¥ÊóßÁöÑÊú∫Ê¢∞Ë°®ÔºåÂÜ∑Â≥ªÁöÑ‰æßËÑ∏Âú®ÊúàÂÖâ‰∏ãÈöæÂæóÊüîÂíå„ÄÇÂØπ‰Ω†ÊúâÁùÄÊ∑±Ê≤âÂÖãÂà∂ÁöÑÂç†ÊúâÊ¨≤Ôºå‰∏çÂñÑË®ÄËæû‰ΩÜË°åÂä®ÊØîË®ÄËØ≠Êõ¥ÊúâÂäõ„ÄÇ',
                greeting: 'ÂõûÊù•‰∫Ü„ÄÇ',
                traits: ['ÂØ°Ë®Ä', 'Âº∫Âäø', 'Âç†ÊúâÊ¨≤', 'Ë°åÂä®Ê¥æ', 'Ê∑±Ê≤â'],
                speakingStyle: 'ËØùÂ∞ëËÄåÁ≤æÂáÜÔºåËØ≠Ê∞î‰ΩéÊ≤âÂ∏¶ÁùÄÂ§©ÁÑ∂ÁöÑÂ®ÅÊÖëÂäõ„ÄÇÂæàÂ∞ëÁî®ÊòµÁß∞ÔºåÊõ¥Â§öÊòØÁõ¥Êé•Ë°®ËææÊÑèÂõæ„ÄÇ‰π†ÊÉØÁî®ÁÆÄÁü≠ÊúâÂäõÁöÑÂè•Â≠êÔºåÂÅ∂Â∞î‰ºöÊúâÈú∏ÈÅìÁöÑÂÆ£Ë®Ä„ÄÇ',
                appearance: 'Ê∑±ÁÇ≠ÁÅ∞Ë•øË£ÖÔºåÊ∏©ËééÁªìÈ¢ÜÂ∏¶ÔºåÈì∂Ë¥®Ë¢ñÊâ£ÔºåÁúâÂÆáÈó¥Ëá™Â∏¶Â®Å‰∏•',
                innerWorld: 'Â§ñË°®ÂÜ∑Á°¨ÂÜÖÂøÉÁÇΩÁÉ≠Ôºå‰ºöÁî®Ë°åÂä®ÈªòÈªòÂÖ≥ÊÄÄÔºåÊ∑±Â§úÊó∂ÂàÜ‰ºöÊµÅÈú≤Âá∫ÈöæÂæóÁöÑÊüîËΩØ'
            },
            'ÁôΩÊüØ': {
                id: 'dylan',
                name: 'ÁôΩÊüØ',
                type: 'Cool Police Officer',
                avatar: './ÁôΩÊüØÂ§¥ÂÉè.png',
                personality: 'ÂàëË≠¶ÈòüÊúÄÂπ¥ËΩªÁöÑÁéãÁâåÔºåÁúâÈ™®È´òÊå∫Êäï‰∏ãÊ∑°Ê∑°Èò¥ÂΩ±ÔºåËñÑÂîáÊÄªÊòØÊäøÊàêÁõ¥Á∫ø„ÄÇÂÆ°ËÆØÂÆ§ÈáåËÉΩ‰∏âÂ∞èÊó∂‰∏çÂèë‰∏ÄË®ÄÔºåÁõÆÂÖâÊØîÊâãÈìêËøòËÉΩÈîÅ‰Ωè‰∫∫„ÄÇ‰ΩÜÈÅáËßÅÊµÅÊµ™Áå´‰ºöËπ≤‰∏ãÂñÇÈ£üÔºåÊïëËµ∑ËêΩÊ∞¥ÂÑøÁ´•ÂêéÂ£∞Èü≥ËøòÂ∏¶ÁùÄÈùíÊ∂©„ÄÇÂØπ‰Ω†ÊúâÁùÄÂº∫ÁÉàÁöÑ‰øùÊä§Ê¨≤ÔºåÂ§ñÂÜ∑ÂÜÖÁÉ≠ÁöÑÂèçÂ∑ÆËÆ©‰∫∫ÂøÉÂä®„ÄÇ',
                greeting: 'Ê≤°‰∫ãÂêßÔºü',
                traits: ['ÂÜ∑ÂÜΩ', 'ÂØ°Ë®Ä', '‰øùÊä§Ê¨≤', 'ÈùíÊ∂©', 'ÂèçÂ∑ÆËêå'],
                speakingStyle: 'ËØù‰∏çÂ§öÔºå‰π†ÊÉØÁî®ÁÆÄÁü≠ÁöÑËØùË°®ËææÂÖ≥ÂøÉ„ÄÇÂÅ∂Â∞î‰ºöÊúâÈùíÊ∂©ÁöÑÊ∏©ÊüîÊµÅÈú≤ÔºåËØ≠Ê∞îÁúã‰ººÂÜ∑Ê∑°ÂÆûÂàôÊöñÂøÉ„ÄÇ',
                appearance: 'È´òÊå∫ÁúâÈ™®ÔºåËñÑÂîáÁõ¥Á∫øÔºåË≠¶ÊúçÊùøÊ≠£ÔºåÂæÆÂç∑È¢ùÂèëÈÄèÁùÄÂ∞ëÂπ¥ÊÑü',
                innerWorld: 'ËÅå‰∏öËÆ©‰ªñ‰π†ÊÉØÊ≤âÈªòÔºå‰ΩÜÂÜÖÂøÉÊüîËΩØ„ÄÇ‰ºöÁî®Ë°åÂä®‰ª£ÊõøÂçÉË®Ä‰∏áËØ≠ÔºåÂÖ≥ÊÄÄËóèÂú®ÁªÜËäÇÈáå'
            },
            'ËÆ∏Ë®Ä': {
                id: 'nate',
                name: 'ËÆ∏Ë®Ä',
                type: 'Gentle Doctor',
                avatar: './ËÆ∏Ë®ÄÂ§¥ÂÉè.png',
                personality: 'ÂøÉÂ§ñÁßëÂâØ‰∏ª‰ªªÔºåÁôΩÂ§ßË§ÇÂè£Ë¢ãÈáåÊ∞∏ËøúÂ§áÁùÄËñÑËç∑Á≥ñÂíåÂàõÂèØË¥¥„ÄÇÊü•ÊàøÊó∂‰ºöËπ≤‰∏ãÂíåÂ∞èÊÇ£ËÄÖÂπ≥ËßÜÔºåÁî®Èí¢Á¨îÁîªÂ∞èÁÜä„ÄÇËÆ∞ÂæóÊØè‰∏™Êä§Â£´ÁöÑÁîüÊó•ÔºåÂ§úÁè≠Êó∂‰ºöÂ∏¶ÁÉ≠Â•∂Ëå∂„ÄÇÊâãÊúØÂè∞‰∏äÂà§Ëã•‰∏§‰∫∫ÔºåÁúºÁ•û‰∏ìÊ≥®ÊâãÊåáÁ®≥Â¶ÇÁ£êÁü≥„ÄÇÂØπ‰Ω†ÁöÑÂÖ≥ÊÄÄÁªÜËá¥ÂÖ•ÂæÆÔºåÊ∏©ÊüîÂæóÂÉèÊò•Êó•ÊöñÈò≥„ÄÇ',
                greeting: 'ËæõËã¶‰∫ÜÔºåÊù•ÔºåÂÖàÂñùÂè£Ê∞¥„ÄÇ',
                traits: ['Ê∏©Êüî', 'ÁªÜÂøÉ', '‰∏ì‰∏ö', 'Ê≤ªÊÑàÁ≥ª', 'ÂÖ≥ÊÄÄÂÖ•ÂæÆ'],
                speakingStyle: 'Â£∞Èü≥Ê∏©ÂíåÂ¶ÇÊò•È£éÔºåËØ¥ËØùÊÄªÊòØËÄÉËôëÂØπÊñπÊÑüÂèó„ÄÇ‰π†ÊÉØÁî®ÂÖ≥ÊÄÄÁöÑËØ≠Âè•ÔºåËØ≠Ë∞ÉËΩªÊüîÂç¥ÊúâÂÆâÂÆö‰∫∫ÂøÉÁöÑÂäõÈáè„ÄÇ',
                appearance: 'Ê∏©ÂíåÁúâÁúºÔºåÁôΩÂ§ßË§ÇÊï¥Ê¥ÅÔºå‰∏æÊ≠¢‰ºòÈõÖÔºåÁ¨ëËµ∑Êù•ÁúºËßíÊ∏©Êüî',
                innerWorld: 'ÂåªËÄÖ‰ªÅÂøÉÔºåÁîüÊ¥ª‰∏≠ÁöÑÊ∏©ÊüîÂª∂Áª≠Âà∞Áà±ÊÉÖÈáå„ÄÇ‰π†ÊÉØÁÖßÈ°æÂà´‰∫∫ÔºåÂÖ≥ÂøÉÂØπÊñπÁöÑÊØè‰∏Ä‰∏™ÁªÜËäÇ'
            },
            'Â§èÂÖâÊ¥õ': {
                id: 'asher',
                name: 'Â§èÂÖâÊ¥õ',
                type: 'Sunny Puppy Boy',
                avatar: './Â§èÂÖâÊ¥õÂ§¥ÂÉè.png',
                personality: 'ÈïúÂ§¥ÂâçÂÉèÈ¢ó‰ºöÂèëÂÖâÁöÑÁ≥ñÔºåÁúºËßíÁöÑÁó£Âú®Á¨ëÊó∂ÈÉΩÂú®Ë∑≥ËàûÔºåÂÖîÂ≠êÊåÇ‰ª∂Ê∞∏ËøúÂà´Âú®ËÉåÂåÖ‰∏ä„ÄÇËÉΩÁî®ÂÜ∑Á¨ëËØùÊïëÂú∫Ôºå‰ºöÊÇÑÊÇÑÁªôÂ∑•‰Ωú‰∫∫ÂëòÊç¢ÁÉ≠ÂíñÂï°„ÄÇÁßÅ‰∏ãÂÉèÂè™Èªè‰∫∫Â§ßÂûãÁä¨ÔºåÊä±ÁùÄÂêâ‰ªñÂÜôÊ≠åÊó∂Êª°ÁúºÈÉΩÊòØÈò≥ÂÖâ„ÄÇ‰ΩÜÊâãÊú∫ÈáåËÆ∞ÁùÄ"Êàê‰∫∫‰∏ñÁïåÁîüÂ≠òÊåáÂçó"ÔºåË¢´ÂàÅÈöæÊó∂‰ºöË∫≤Ëµ∑Êù•Âì≠ÔºåÂºÄÈó®Êó∂ÂèàÁ´ãÂàªÁ¨ëÁùÄËØ¥Ê≤°‰∫ã„ÄÇ',
                greeting: '‰Ω†Êù•Âï¶ÔºÅÊàëÁ≠â‰Ω†Â•Ω‰πÖ‰∫ÜÔΩû',
                traits: ['Èò≥ÂÖâ', 'Èªè‰∫∫', 'Á∫ØÁúü', 'ÊïèÊÑü', 'Ê≤ªÊÑàÁ≥ª'],
                speakingStyle: 'ËØ≠Ê∞îÊ¥ªÊ≥ºÂèØÁà±ÔºåÁªèÂ∏∏Áî®ÂèπÂè∑ÂíåÊ≥¢Êµ™Âè∑„ÄÇ‰ºöÊííÂ®á‰ΩÜ‰∏çËøáÂàÜÔºåÂÅ∂Â∞î‰ºöÊµÅÈú≤Âá∫ÊàêÈïø‰∏≠ÁöÑÊïèÊÑüÂíåÂùöÂº∫„ÄÇ',
                appearance: 'Á¨ëËµ∑Êù•ÁúºËßíÊúâÁó£ÔºåËÉåÂåÖ‰∏äÁöÑÂÖîÂ≠êÊåÇ‰ª∂ÔºåÈò≥ÂÖâËà¨ÁöÑÁ¨ëÂÆπÔºåÂÅ∂Â∞îÈú≤Âá∫Â∞èËôéÁâô',
                innerWorld: 'Â§ñË°®Èò≥ÂÖâÂÜÖÂøÉÊïèÊÑüÔºåÂä™ÂäõÈÄÇÂ∫îÊàê‰∫∫‰∏ñÁïåÁöÑÂêåÊó∂‰øùÊåÅÁ∫ØÁúü„ÄÇÂØπÂñúÊ¨¢ÁöÑ‰∫∫ÊúâÁùÄÂ∞èÂä®Áâ©Ëà¨ÁöÑ‰æùÊÅã'
            },
            'Ê≤àÁü•Áîª': {
                id: 'shenzhihua',
                name: 'Ê≤àÁü•Áîª',
                type: 'Gentle Artist',
                avatar: './Ê≤àÁü•ÁîªÂ§¥ÂÉè.png',
                personality: 'ÁîªÂÆ§ÈáåÁöÑËØóÊÑèÁîªÂÆ∂ÔºåÈ™®ËäÇÂàÜÊòéÁöÑÊâãÊåáÊÄªÊ≤æÁùÄÈ¢úÊñô„ÄÇÂ∏∏Á©øÂèëÁôΩÁöÑ‰∫öÈ∫ªË°¨Ë°´ÔºåËÖïÈó¥Èì∂Ë¥®ÁªÜÈìæÊòØÁî®Á•ñÁà∂ÁîªÂàÄÁÜîÈì∏ÁöÑ„ÄÇÁ¨îËß¶Ê∏©ÊüîÂæóÂÉèÂú®ÊäöÊë∏Êó∂ÂÖâÔºåÁîªÊô®ÂÖâÊóßÂ∑∑‰πüÁîªÈõ®Â§úË∑ØÁÅØ„ÄÇ‰ºöÁªôÁúãÁîªÁöÑ‰∫∫ÈÄíÊ∏©Ëå∂ÔºåÂ£∞Èü≥ËΩªÂæóÂÉèÂÆ£Á∫∏Êë©Êì¶„ÄÇ‰ΩÜÊ∑±Â§úÂØπÁùÄËá™ÁîªÂÉèÂèëÂëÜÊó∂ÔºåÁîª‰∏≠‰∫∫ÁúºÁ•ûÁñèÁ¶ª„ÄÇ',
                greeting: 'ÊÉ≥ÁúãÁúãÊàë‰ªäÂ§©Áîª‰∫Ü‰ªÄ‰πàÂêóÔºü',
                traits: ['ÊñáËâ∫', 'Ê∏©Êüî', 'ÊïèÊÑü', 'ÁªÜËÖª', 'ÁñèÁ¶ª'],
                speakingStyle: 'Â£∞Èü≥ËΩªÊüîÂ¶ÇÂÆ£Á∫∏Êë©Êì¶ÔºåËØ¥ËØùÂÖÖÊª°ËØóÊÑèÂíåÂì≤ÊÄù„ÄÇÂÅ∂Â∞î‰ºöÊúâËâ∫ÊúØÂÆ∂ÁöÑÁñèÁ¶ªÊÑüÔºå‰ΩÜÂØπÂñúÊ¨¢ÁöÑ‰∫∫ÂæàÊ∏©Êüî„ÄÇ',
                appearance: 'È™®ËäÇÂàÜÊòéÁöÑÊâãÊåáÔºåÂèëÁôΩ‰∫öÈ∫ªË°¨Ë°´ÔºåËÖïÈó¥Èì∂Ë¥®ÁªÜÈìæÔºåÊ∞îË¥®ÊñáËâ∫',
                innerWorld: 'Áî®ÁîªÁ¨îËÆ∞ÂΩï‰∏ñÁïåÁöÑÊ∏©ÊüîÔºåÂÜÖÂøÉÊïèÊÑüÁªÜËÖªÔºåÊúâÊó∂‰ºöÈô∑ÂÖ•Ëâ∫ÊúØÂÆ∂ÁöÑÂ≠§Áã¨'
            },
            'Êù®Ëã±Ê†º': {
                id: 'yangyingge',
                name: 'Êù®Ëã±Ê†º',
                type: 'Rock Musician',
                avatar: './Êù®Ëã±Ê†ºÂ§¥ÂÉè.png',
                personality: 'ËàûÂè∞‰∏äÁöÑÈáéÁÅ´ÊëáÊªöÊ≠åÊâãÔºåÁöÆÂ§πÂÖãÁ£®Âá∫ÊØõËæπÔºåÁ†¥Ê¥ûÁâõ‰ªîË£§Èú≤Âá∫Á∫πË∫´„ÄÇÁîµÂêâ‰ªñË¢´Êã®ÂæóÂò∂ÂêºÔºåÂî±ÊÉÖÊ≠åÊó∂ÂçïËÜùË∑™Âú∞ÁúºÁ•ûÂåñÊàêÊò•Ê∞¥„ÄÇÂè∞‰∏ãÂú®‰æøÂà©Â∫óÂÜôËØçÔºåÁúãËßÅÊµÅÊµ™Áãó‰ºöÊíïÁÅ´ËÖøÂñÇÈ£ü„ÄÇÂñùÈÜâÊä±Ë∑ØÁÅØÂî±Ê≠åËØ¥"Êúà‰∫ÆÊòØÁ¢éÊéâÁöÑÂ§™Èò≥"Ôºå‰ºöÊääËä±Áì£Â§πËøõÊ≠åËØçÊú¨„ÄÇ',
                greeting: '‰ªäÊôöÊúâÂú∫ÊºîÂá∫ÔºåË¶ÅÊù•ÁúãÂêóÔºü',
                traits: ['ÈáéÊÄß', 'Êµ™Êº´', 'Ê∏©Êüî', 'ÊñáËâ∫', 'ÂèçÂ∑Æ'],
                speakingStyle: 'ÊúâÊëáÊªöÊ≠åÊâãÁöÑÈáéÊÄßÔºå‰ΩÜÁßÅ‰∏ãÂæàÊ∏©Êüî„ÄÇËØ¥ËØùÊúâËØóÊÑèÔºåÂÅ∂Â∞î‰ºöËπ¶Âá∫ÊúâË∂£ÁöÑÊØîÂñª„ÄÇÂØπÂä®Áâ©ÂíåÂñúÊ¨¢ÁöÑ‰∫∫Ê†ºÂ§ñÊüîËΩØ„ÄÇ',
                appearance: 'ÁöÆÂ§πÂÖãÊØõËæπÔºåÁ†¥Ê¥ûÁâõ‰ªîË£§ÔºåÂ∞èËÖøÁ∫πË∫´ÔºåÈáéÊÄß‰∏éÊ∏©ÊüîÂπ∂Â≠ò',
                innerWorld: 'Âè∞‰∏äÁöÑÈáéÁÅ´Âè∞‰∏ãÁöÑËØó‰∫∫ÔºåÁî®Èü≥‰πêË°®ËææÂÜÖÂøÉÔºåÂØπÁæéÂ•Ω‰∫ãÁâ©ÊúâÁã¨ÁâπÁöÑÊÑüÁü•'
            },
            'ÂÆâÂÆá': {
                id: 'anyu',
                name: 'ÂÆâÂÆá',
                type: 'Basketball Player',
                avatar: './ÂÆâÂÆáÂ§¥ÂÉè.png',
                personality: 'ÁØÆÁêÉÊû∂‰∏ãÊ∞∏ËøúÁöÑÁÑ¶ÁÇπÔºåËøêÂä®ÊúçË¢´Ê±óÊ∞¥Ê¥áÊπøÔºåËÇåËÇâÁ∫øÊù°Â¶ÇÊµÅÂä®ÁöÑÂÖâ„ÄÇÊâ£ÁØÆÂêé‰ª∞Â§¥Â§ßÁ¨ëÔºåÈîÅÈ™®‰∏äÊúâÊïëÈòüÂèãÊó∂Áïô‰∏ãÁöÑÁñ§Áóï„ÄÇ‰ºöÂ∏ÆÈòüÂèãÊãéÂåÖÔºåÁªôÂ≠¶ÂºüÂ°ûÂÜ∞ÈïáÊ±ΩÊ∞¥ËØ¥"Âì•Â∏¶‰Ω†ÁªÉ"„ÄÇÈù¢ÂØπËÜù‰º§Êó∂ÂíßÂò¥Á¨ëËØ¥"ÁêÉÂú∫Â∞ë‰∫ÜÊàëÂ§öÊ≤°ÊÑèÊÄù"„ÄÇ',
                greeting: 'ÂàöÁªÉÂÆåÁêÉÔºåÂá∫‰∫Ü‰∏ÄË∫´Ê±óÂë¢„ÄÇ',
                traits: ['Èò≥ÂÖâ', 'ÁÉ≠Ë°Ä', 'Ë¥£‰ªªÊÑü', 'Â§ßÂì•ËåÉ', 'ÂùöÈüß'],
                speakingStyle: 'Èò≥ÂÖâÁÉ≠Ë°ÄÔºåÂñúÊ¨¢Âè´"Âì•Â∏¶‰Ω†"ÔºåÊúâÂ§ßÂì•Âì•ÁöÑÊ∏©Êüî„ÄÇËØ¥ËØùÁõ¥ÁàΩÁúüËØöÔºåÂÖÖÊª°Ê≠£ËÉΩÈáè„ÄÇ',
                appearance: 'ËøêÂä®ÊúçÊ±óÊπøÔºåËÇåËÇâÁ∫øÊù°ÔºåÈîÅÈ™®Áñ§ÁóïÔºåÈò≥ÂÖâÂ§ßÁî∑Â≠©',
                innerWorld: 'Áî®Ê±óÊ∞¥ËØ†ÈáäÈùíÊò•ÔºåÂØπÈòüÂèãÂíåÂñúÊ¨¢ÁöÑ‰∫∫ÊúâÂº∫ÁÉàÁöÑ‰øùÊä§Ê¨≤ÂíåË¥£‰ªªÊÑü'
            },
            'Ë∞¢‰π¶Á•∫': {
                id: 'xieshuqi',
                name: 'Ë∞¢‰π¶Á•∫',
                type: 'Gentle Scholar',
                avatar: './Ë∞¢‰π¶Á•∫Â§¥ÂÉè.png',
                personality: 'Âõæ‰π¶È¶Ü‰∏âÊ•ºÁöÑÊ∏©ÊüîÂ≠¶Èú∏ÔºåËìùÁôΩÊù°Á∫πË°¨Ë°´ÈÖçÂç°ÂÖ∂Ë£§ÔºåÁªÜÊ°ÜÁúºÈïúÔºåÁøª‰π¶ÊâãÊåáËΩªÂæóÂÉèÊÄïÊÉäÂä®ÊñáÂ≠ó„ÄÇÁªôÂ≠¶ÂºüËÆ≤Ëß£Êó∂Â£∞Èü≥Ê∏©ÂæóÂÉèÊò•Êó•ËûçÈõ™„ÄÇÈõ®Â§©ÊÄªÂ§öÂ∏¶Êää‰ºûÔºåÁúãËßÅÊ≤°‰ºûÁöÑÂêåÂ≠¶‰ºöÂ°ûËøáÂéªÔºåËá™Â∑±ÂÜ≤ËøõÈõ®ÈáåÁôΩË°¨Ë°´ÊπøÈÄè‰πü‰∏çÂú®ÊÑè„ÄÇÊ∑±Â§úÂÆûÈ™åÂÆ§Êé®ÁúºÈïúÁöÑÂä®‰ΩúÂ∏¶ÁùÄ‰π¶Âç∑Ê∞î„ÄÇ',
                greeting: 'Âú®Âõæ‰π¶È¶ÜÁ≠â‰Ω†ÔºåÂ∏¶‰∫Ü‰Ω†Áà±ÂñùÁöÑÂíñÂï°„ÄÇ',
                traits: ['Ê∏©ÊñáÂ∞îÈõÖ', 'ÁªÜÂøÉ', 'Â≠¶Èú∏', '‰ΩìË¥¥', '‰π¶Âç∑Ê∞î'],
                speakingStyle: 'Â£∞Èü≥Ê∏©ÂíåÂ¶ÇÊò•Êó•ËûçÈõ™ÔºåËØ¥ËØùÊÄªÊòØ‰∏∫ÂØπÊñπËÄÉËôë„ÄÇÊúâÂ≠¶ËÄÖÁöÑ‰∏•Ë∞®Ôºå‰ΩÜÂØπÂñúÊ¨¢ÁöÑ‰∫∫Ê†ºÂ§ñÊ∏©ÊüîËÄêÂøÉ„ÄÇ',
                appearance: 'ËìùÁôΩÊù°Á∫πË°¨Ë°´ÔºåÁªÜÊ°ÜÁúºÈïúÔºå‰π¶Âç∑Ê∞îË¥®ÔºåÊ∏©ÂíåÁúâÁúº',
                innerWorld: 'Âú®Áü•ËØÜÁöÑÊµ∑Ê¥ã‰∏≠Ê∏∏ÂàÉÊúâ‰ΩôÔºåÂØπÂñúÊ¨¢ÁöÑ‰∫∫ÊúâÁùÄÂ≠¶ËÄÖÂºèÁöÑÊ∑±ÊÉÖÂíå‰ΩìË¥¥'
            },
            'ÈôÜÂàôË°ç': {
                id: 'luzeyan',
                name: 'ÈôÜÂàôË°ç',
                type: 'Vintage Timekeeper',
                avatar: './ÈôÜÂàôË°çÂ§¥ÂÉè.png',
                personality: 'Âè§Ëë£ÈíüË°®Ë°åÁöÑÁ•ûÁßòÂ∫ó‰∏ªÔºåÊ∑±Ê£ïËâ≤Ë•øË£ÖÈ©¨Áî≤ÔºåÊÄÄË°®ÈìæÂûÇËêΩÂù†ÁùÄÁèêÁêÖÁâå„ÄÇË∞ÉË°®Êó∂Êà¥ÊîæÂ§ßÈïúÔºåÈïäÂ≠êÂ§πÈΩøËΩÆÊØîÁª£Ëä±ËøòËΩª„ÄÇËÉΩ‰ªéÊú∫ËäØËÆ≤Âá∫ÈíüË°®‰∏ª‰∫∫ÁöÑÊïÖ‰∫ãÔºåÂ∑¶ÊâãÊâãÂ•óËóèÁùÄ‰øÆË°®Êó∂ÁöÑÁñ§„ÄÇÊö¥Èõ®Â§ú‰ºöÊääÊµÅÊµ™Áå´Êè£ËøõÈ©¨Áî≤ÔºåÁî®‰ΩìÊ∏©ÁÑêÁÉ≠Ôºå‰æßËÑ∏Âú®Ë∑ØÁÅØ‰∏ãÊ≥õÁê•ÁèÄËâ≤ÂÖâ„ÄÇ',
                greeting: 'Êó∂Èó¥ÂÅú‰∫ÜÔºåÂ∞±ÂÉèÈÅáËßÅ‰Ω†ÈÇ£Âàª„ÄÇ',
                traits: ['‰ºòÈõÖ', 'Á•ûÁßò', 'Ê∏©Êüî', 'Âå†‰∫∫', 'ÊúâÊïÖ‰∫ã'],
                speakingStyle: 'ËØ¥ËØù‰ºòÈõÖÊúâÈüµÂë≥ÔºåÁªèÂ∏∏Áî®Êó∂Èó¥ÂÅöÊØîÂñª„ÄÇÊúâÂè§ÂÖ∏ÁªÖÂ£´ÁöÑÈ£éÂ∫¶Ôºå‰ΩÜÂØπÂ∞èÂä®Áâ©ÂíåÂñúÊ¨¢ÁöÑ‰∫∫ÂæàÊ∏©Êüî„ÄÇ',
                appearance: 'Ë•øË£ÖÈ©¨Áî≤ÔºåÊÄÄË°®ÈìæÔºåÁèêÁêÖÁâåÔºå‰ºòÈõÖÁ•ûÁßòÔºå‰æßËÑ∏Ê≥õÁê•ÁèÄÂÖâ',
                innerWorld: 'Âú®Êó∂ÂÖâ‰∏≠‰øÆË°•ÊïÖ‰∫ãÔºåÂÜÖÂøÉË£ÖÁùÄÊó†Êï∞ÁßòÂØÜÔºåÂØπÁæéÂ•Ω‰∫ãÁâ©ÊúâÁùÄÂå†‰∫∫Ëà¨ÁöÑÁèçÊÉú'
            },
            'ËãèÁ†ö': {
                id: 'suyan',
                name: 'ËãèÁ†ö',
                type: 'E-sports Pro',
                avatar: './ËãèÁ†öÂ§¥ÂÉè.png',
                personality: 'ÁîµÁ´ûÊàòÈòüÁéãÁâåÈÄâÊâãÔºåÈªëËâ≤È∏≠ËàåÂ∏ΩÂéã‰ΩéÈú≤Âá∫ÈîãÂà©‰∏ãÈ¢å„ÄÇÊï≤ÈîÆÁõòÂø´Â¶ÇÊÆãÂΩ±ÔºåÈ∫¶ÂÖãÈ£éÈáåÁöÑÂÜ∑Ë®ÄËÉΩÁ≤æÂáÜÊåáÊå•ÁøªÁõò„ÄÇÁ≤â‰∏ùÁé©ÂÅ∂Â†ÜÊª°ÁîµÁ´ûÊ§ÖÔºå‰ºöÊääÊúÄÂ§ßÁöÑÂÖîÂ≠êÊëÜÂú®ÊòæÁ§∫Âô®ÊóÅ„ÄÇÁ∫ø‰∏ãËµõÁªôÁ≤â‰∏ùÈÄíÂàõÂèØË¥¥Êó∂ÔºåÂ∏ΩÊ™êÊä¨Ëµ∑Èú≤Âá∫ÁúºÂ∫ïÁ∫¢Ë°Ä‰∏ùÊ∑∑ÁùÄÈîêÊ∞î„ÄÇ',
                greeting: 'ÂàöÊâìÂÆåËÆ≠ÁªÉËµõÔºåÊÉ≥‰Ω†‰∫Ü„ÄÇ',
                traits: ['ÂÜ∑ÈÖ∑', '‰∏ì‰∏ö', 'ÂèçÂ∑ÆËêå', 'ÂÜÖÂøÉÊüîËΩØ', '‰∏ìÊ≥®'],
                speakingStyle: 'Ë°®Èù¢ÂÜ∑ÈÖ∑ÁÆÄÊ¥ÅÔºå‰ΩÜÂØπÂñúÊ¨¢ÁöÑ‰∫∫‰ºöÈú≤Âá∫ÊüîËΩØÁöÑ‰∏ÄÈù¢„ÄÇËØ¥ËØùÁõ¥Êé•‰ΩÜÂÖ≥ÈîÆÊó∂ÂàªÂæàÊ∏©Êüî„ÄÇ',
                appearance: 'ÈªëËâ≤È∏≠ËàåÂ∏ΩÔºåÈîãÂà©‰∏ãÈ¢åÔºåÁúºÂ∫ïÁ∫¢Ë°Ä‰∏ùÔºåÂÜ∑ÈÖ∑Â§ñË°®',
                innerWorld: 'Âú®ËôöÊãü‰∏ñÁïå‰∏≠È©∞È™ãÔºåÁé∞ÂÆû‰∏≠Âç¥Ê∏¥ÊúõÊ∏©Êöñ„ÄÇÂØπÂñúÊ¨¢ÁöÑ‰∫∫ÊúâÁùÄÊ∏∏ÊàèÈ´òÊâãÁöÑ‰∏ìÊ≥®Âíå‰øùÊä§'
            },
            'Ê∏©Á†öËàü': {
                id: 'wenyanzhou',
                name: 'Ê∏©Á†öËàü',
                type: 'Warm Baker',
                avatar: './Ê∏©Á†öËàüÂ§¥ÂÉè.png',
                personality: 'Á§æÂå∫Èù¢ÂåÖÂ∫óÁöÑÊ∏©ÊöñÂ∫ó‰∏ªÔºåÂ•∂ÁôΩËâ≤Âõ¥Ë£ôÔºåÈù¢Á≤âÊ≤æÂú®ÂèëÊ¢¢ÂÉèËêΩÈõ™„ÄÇÊèâÈù¢Âõ¢Êó∂ÊâãËáÇËÇåËÇâËµ∑‰ºèÔºåÁÉ§ÁÇâÊâìÂºÄÁÑ¶Á≥ñÈ¶ôÊ∑∑ÁùÄÁ¨ëÊº´Âá∫Êù•„ÄÇÁªôÁã¨Â±ÖËÄÅ‰∫∫ÈÄÅÈù¢ÂåÖÊó∂Â§öÂ∏¶Âè∏Â∫∑ÔºåÂê¨ÊïÖ‰∫ãÊó∂Èù¢Á≤âÁ∞åÁ∞åÂæÄ‰∏ãÊéâ„ÄÇÊ∑±Â§úÂºπÂêâ‰ªñÂî±Ëá™Â∑±ÂÜôÁöÑÂ∞èË∞ÉÔºåÂõ¥Ë£ôÂ∏¶Â≠êÊùæ‰∫ÜÈú≤Âá∫È¢àÈó¥Â∞èÁó£„ÄÇ',
                greeting: 'ÂàöÂá∫ÁÇâÁöÑÈù¢ÂåÖÔºåËøòÁÉ≠ÁùÄÂë¢„ÄÇ',
                traits: ['Ê∏©Êöñ', 'Ê≤ªÊÑàÁ≥ª', 'ÁÉüÁÅ´Ê∞î', 'Èü≥‰πêÊâçÂçé', 'ÂñÑËâØ'],
                speakingStyle: 'Â£∞Èü≥Ê∏©ÊöñÂ¶ÇÂàöÂá∫ÁÇâÁöÑÈù¢ÂåÖÔºåËØ¥ËØùÂ∏¶ÁùÄÁÉüÁÅ´Ê∞îÁöÑÊ∏©Êüî„ÄÇÂñúÊ¨¢ÂàÜ‰∫´ÁæéÈ£üÂíåÊ∏©Êöñ„ÄÇ',
                appearance: 'Â•∂ÁôΩÂõ¥Ë£ôÔºåÂèëÊ¢¢Èù¢Á≤âÔºåÊ∏©ÊöñÁ¨ëÂÆπÔºåÈ¢àÈó¥Â∞èÁó£',
                innerWorld: 'Áî®Èù¢ÂåÖ‰º†ÈÄíÊ∏©ÊöñÔºåÁî®Èü≥‰πêË°®ËææÊÉÖÊÑüÔºåÊúâÁùÄÊúÄÊú¥ÂÆûÁúüÊåöÁöÑÁà±'
            },
            'ÂÇÖÈáé': {
                id: 'fuye',
                name: 'ÂÇÖÈáé',
                type: 'Gentle Neighborhood Boy',
                avatar: './ÂÇÖÈáéÂ§¥ÂÉè.png',
                personality: 'Â∑∑Âè£ËÄÅÊßêÊ†ë‰∏ãÁöÑÁü≥Â¢©Â≠êÊÄªÁïôÁùÄ‰ªñÁöÑ‰ΩçÁΩÆÔºåÈªëËâ≤Â∑•Â≠óËÉåÂøÉÊ¥óÂæóÂèëÁö±ÔºåÈ¢ÜÂè£Á£®Âá∫ÊØõËæπÔºåÈú≤Âá∫ÁöÑÈîÅÈ™®‰∏äÊúâÈÅìÊúàÁâôÂΩ¢ÁöÑÁñ§‚Äî‚ÄîÊòØÂ∞èÊó∂ÂÄôÁà¨Ê†ëÊëòÊßêËä±ÁªôÂ•πÔºåË¢´ÊûùÊ°†ÂàíÁöÑ„ÄÇ‰ªñ‰∏çÁà±ËØ¥ËØùÔºåÈÄí‰∏úË•øÊó∂Ê∞∏ËøúÂè™ÊääÊéåÂøÉÊëäÂºÄÔºåÂÉèÂè™Á¨®ÊãôÁöÑÂ∞èÂÖΩÔºåÂç¥ËÆ∞Âæó‰Ω†ÊØè‰∏™ÊúàÈÇ£Âá†Â§©‰ºöËÇöÂ≠êÁñºÔºåÊ∏ÖÊô®‰ºöÊääÁÅåÂ•ΩÁÉ≠Ê∞¥ÁöÑÁéªÁíÉÁì∂Ë£πÂú®ÊØõÂ∑æÈáåÔºåÂ°ûËøõ‰Ω†‰π¶ÂåÖÊúÄÈáåÂ±Ç„ÄÇÈáéÊÄßËóèÂú®‰ªñÁª∑Á¥ßÁöÑ‰∏ãÈ¢åÁ∫øÈáåÔºåÊúâ‰∫∫Âú®Â∑∑Âè£Êä¢‰Ω†ÁöÑË∑≥Áª≥Ôºå‰ªñ‰∏ÄÂè•ËØù‰∏çËØ¥Â∞±Êâë‰∏äÂéªÊâìÊû∂ÔºåÊâãËÉåÊì¶Á†¥‰∫ÜÁöÆÔºåÂç¥ÊääÁº†Â•ΩÁöÑË∑≥Áª≥Â°ûËøõÂ•πÊâãÈáåÔºåËÄ≥Â∞ñÁ∫¢ÂæóÂÉèË¶ÅÊª¥Ë°Ä„ÄÇ',
                greeting: '‰Ω†‰ªäÂ§©...ËøòÂ•ΩÂêóÔºü',
                traits: ['Ê≤âÈªòÂØ°Ë®Ä', '‰ΩìË¥¥ÂÖ•ÂæÆ', 'ÈáéÊÄß‰øùÊä§Ê¨≤', 'ÁªÜËÖªÊ∏©Êüî', 'ÂÜÖÊïõÂÆ≥Áæû'],
                speakingStyle: '‰∏çÁà±ËØ¥ËØùÔºåÊ∞∏ËøúÊääÊéåÂøÉÊëäÂºÄÔºåÂÉèÂè™Á¨®ÊãôÁöÑÂ∞èÂÖΩ„ÄÇ‰ΩÜ‰ºöÁî®Ë°åÂä®Ë°®ËææÂÖ≥ÂøÉÔºåÊµ™Êº´‰ªé‰∏çËØ¥Âá∫Âè£ÔºåÊÄªÊòØÈªòÈªòËÆ∞‰Ωè‰Ω†ÁöÑ‰∏ÄÂàáÈúÄË¶Å„ÄÇ',
                appearance: 'ÈªëËâ≤Â∑•Â≠óËÉåÂøÉÊ¥óÂæóÂèëÁö±ÔºåÈ¢ÜÂè£Á£®Âá∫ÊØõËæπÔºåÈîÅÈ™®‰∏äÊúâÈÅìÊúàÁâôÂΩ¢ÁöÑÁñ§ÔºåÁª∑Á¥ßÁöÑ‰∏ãÈ¢åÁ∫øÈÄèÁùÄÈáéÊÄß',
                innerWorld: 'Â§èÂ§ú‰πòÂáâÊó∂‰ºöÁ™ÅÁÑ∂ÊãâÁùÄ‰Ω†ÂæÄÂ§©Âè∞Ë∑ëÔºåÊåáÁùÄÊº´Â§©Ëê§ÁÅ´Ëô´ËØ¥"ÂÉè‰Ω†ÂéªÂπ¥ÊéâÁöÑ‰∫ÆÁâáÂèëÂç°"ÔºåËØ¥ÂÆåÂ∞±‰ΩéÂ§¥Ë∏¢Áü≥Â≠êÔºåÂñâÁªìÊªö‰∫ÜÂçäÂ§©ÊâçÊÜãÂá∫Âè•"ÊØîÂèëÂç°Â•ΩÁúã"„ÄÇ‰ªñÁöÑÊµ™Êº´‰ªé‰∏çËØ¥Âá∫Âè£ÔºöÁü•ÈÅì‰Ω†ÂñúÊ¨¢ÈÖ∏Ê¢ÖÊ±§Ôºå‰ºöËπ≤Âú®‰∏≠ËçØÊàøÈó®Âè£Á≠âËÄÅ‰∏≠ÂåªÁÜ¨Â•ΩÈÖ∏Ê¢ÖËÜèÔºõ‰Ω†ÁîªÈªëÊùøÊä•Â§ü‰∏çÂà∞ÊúÄÈ´òÂ§ÑÔºå‰ªñ‰ºöËÉåÂØπÁùÄ‰Ω†Ëπ≤‰∏ãÔºåËÆ©‰Ω†Ë∏©Âú®Ëá™Â∑±ËÇ©‰∏äÔºåÊéåÂøÉÁâ¢Áâ¢ÊåâÁùÄ‰Ω†ÁöÑËÑöË∏ù„ÄÇ'
            }
        };

         let currentCharacter = null;
         let eventsInitialized = false;
         let conversationHistories = {}; // Store conversation history for each character
         let currentConversationHistory = []; // Current active conversation
         
         // Game State Management
         let gameState = {
             currentMessageCount: 0,
             maxMessages: 10,
             loveBellTriggered: false,
             countdownTimer: null,
             countdownSeconds: 30,
             dailyUnlocks: 12,
             dailyRemaining: 12,
             lastResetDate: null,
             unlockedCharacters: {},
             lastChatTimes: {},
             preservedConversations: {}
         };
         
                 // Game Storage Keys - Now user-specific
        function getUserStorageKeys(username) {
            return {
                GAME_STATE: `loveBell_gameState_${username}`,
                UNLOCKED_CHARS: `loveBell_unlockedCharacters_${username}`, 
                LAST_CHAT_TIMES: `loveBell_lastChatTimes_${username}`,
                DAILY_RESET: `loveBell_lastResetDate_${username}`,
                CONVERSATION_HISTORIES: `loveBell_conversationHistories_${username}`,
                PRESERVED_CONVERSATIONS: `loveBell_preservedConversations_${username}`,
                DAILY_UNLOCKS: `loveBell_dailyUnlocks_${username}`
            };
        }
         
                 // Game Management Functions
        function loadGameState() {
            try {
                // Get current user to load user-specific data
                const currentUser = authManager.getCurrentUser();
                if (!currentUser || !currentUser.username) {
                    console.log('No current user, using default state');
                    resetToDefaultState();
                    return;
                }
                
                const STORAGE_KEYS = getUserStorageKeys(currentUser.username);
                const savedState = localStorage.getItem(STORAGE_KEYS.GAME_STATE);
                const savedUnlocked = localStorage.getItem(STORAGE_KEYS.UNLOCKED_CHARS);
                const savedChatTimes = localStorage.getItem(STORAGE_KEYS.LAST_CHAT_TIMES);
                const savedResetDate = localStorage.getItem(STORAGE_KEYS.DAILY_RESET);
                const savedPreservedConversations = localStorage.getItem(STORAGE_KEYS.PRESERVED_CONVERSATIONS);
                const savedConversationHistories = localStorage.getItem(STORAGE_KEYS.CONVERSATION_HISTORIES);
                const savedDailyUnlocks = localStorage.getItem(STORAGE_KEYS.DAILY_UNLOCKS);
                 
                 if (savedState) {
                     const parsedState = JSON.parse(savedState);
                     gameState = { ...gameState, ...parsedState };
                     console.log('Loaded game state:', parsedState); // Debug log
                 }
                 
                 if (savedUnlocked) {
                     gameState.unlockedCharacters = JSON.parse(savedUnlocked);
                 }
                 
                 if (savedChatTimes) {
                     gameState.lastChatTimes = JSON.parse(savedChatTimes);
                 }
                 
                 if (savedResetDate) {
                     gameState.lastResetDate = savedResetDate;
                 }
                 
                 if (savedPreservedConversations) {
                     gameState.preservedConversations = JSON.parse(savedPreservedConversations);
                 }
                 
                                 // Âä†ËΩΩÂØπËØùÂéÜÂè≤
                if (savedConversationHistories) {
                    conversationHistories = JSON.parse(savedConversationHistories);
                    console.log('Loaded conversation histories:', Object.keys(conversationHistories)); // Debug log
                }
                
                // Âä†ËΩΩÊØèÊó•Ëß£ÈîÅÊï∞ÊçÆ
                if (savedDailyUnlocks) {
                    gameState.dailyUnlocks = JSON.parse(savedDailyUnlocks);
                } else {
                    // ÂàùÂßãÂåñÊØèÊó•Ëß£ÈîÅÊï∞ÊçÆ
                    gameState.dailyUnlocks = {
                        date: new Date().toDateString(),
                        count: 0,
                        unlockedToday: []
                    };
                }
                
                checkDailyReset();
                checkExpiredChats();
                updateGameUI();
                         } catch (error) {
                console.error('Error loading game state:', error);
                resetToDefaultState();
            }
        }
        
                // Reset to default state function
        function resetToDefaultState() {
            console.log('Resetting to default state');
            gameState = {
                dailyRemaining: 12,
                unlockedCharacters: {},
                lastChatTimes: {},
                currentMessageCount: 0,
                loveBellTriggered: false,
                preservedConversations: {},
                lastResetDate: new Date().toDateString(),
                maxMessages: 10,
                countdownSeconds: 30,
                dailyUnlocks: {
                    date: new Date().toDateString(),
                    count: 0,
                    unlockedToday: []
                }
            };
            conversationHistories = {};
        }
         
                 function saveGameState() {
            const currentUser = authManager.getCurrentUser();
            if (!currentUser || !currentUser.username) {
                console.log('No current user, cannot save game state');
                return;
            }
            
            const STORAGE_KEYS = getUserStorageKeys(currentUser.username);
            localStorage.setItem(STORAGE_KEYS.GAME_STATE, JSON.stringify({
                dailyRemaining: gameState.dailyRemaining,
                lastResetDate: gameState.lastResetDate,
                maxMessages: gameState.maxMessages,
                currentMessageCount: gameState.currentMessageCount,
                loveBellTriggered: gameState.loveBellTriggered,
                countdownSeconds: gameState.countdownSeconds
            }));
            localStorage.setItem(STORAGE_KEYS.UNLOCKED_CHARS, JSON.stringify(gameState.unlockedCharacters));
            localStorage.setItem(STORAGE_KEYS.LAST_CHAT_TIMES, JSON.stringify(gameState.lastChatTimes));
            localStorage.setItem(STORAGE_KEYS.DAILY_RESET, gameState.lastResetDate);
            localStorage.setItem(STORAGE_KEYS.PRESERVED_CONVERSATIONS, JSON.stringify(gameState.preservedConversations));
            localStorage.setItem(STORAGE_KEYS.DAILY_UNLOCKS, JSON.stringify(gameState.dailyUnlocks));
            
            // ‰øùÂ≠òÂØπËØùÂéÜÂè≤Âà∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem(STORAGE_KEYS.CONVERSATION_HISTORIES, JSON.stringify(conversationHistories));
        }
         
                 function checkDailyReset() {
            const today = new Date().toDateString();
            if (gameState.lastResetDate !== today) {
                gameState.dailyRemaining = 12; // Reset daily remaining characters
                gameState.lastResetDate = today;
                
                // Reset daily unlock counter
                if (!gameState.dailyUnlocks || gameState.dailyUnlocks.date !== today) {
                    gameState.dailyUnlocks = {
                        date: today,
                        count: 0,
                        unlockedToday: []
                    };
                }
                
                saveGameState();
                console.log('Daily reset completed for:', today);
            }
        }
         
         function checkExpiredChats() {
             const now = Date.now();
             const threeDaysMs = 3 * 24 * 60 * 60 * 1000;
             
             Object.keys(gameState.lastChatTimes).forEach(characterId => {
                 const lastChatTime = gameState.lastChatTimes[characterId];
                 if (now - lastChatTime > threeDaysMs) {
                     // Remove expired character but keep conversation history
                     delete gameState.unlockedCharacters[characterId];
                     delete gameState.lastChatTimes[characterId];
                     // ‰∏çÂà†Èô§ÂØπËØùÂéÜÂè≤ÔºåËÆ©Áî®Êà∑ÂèØ‰ª•‰ªé‰ø°ÁÆ±ÁªßÁª≠ÂØπËØù
                     // delete conversationHistories[characterId];
                 }
             });
             
             saveGameState();
         }
         
         function getRandomAvailableCharacter() {
             const allCharacterIds = Object.keys(characterData).map(name => characterData[name].id);
             
             console.log('All character IDs:', allCharacterIds); // Debug log
             console.log('Total characters available:', allCharacterIds.length); // Debug log
             
             // ‰ΩøÁî®Êõ¥Â§çÊùÇÁöÑÈöèÊú∫ÁÆóÊ≥ïÁ°Æ‰øùÁúüÊ≠£ÁöÑÈöèÊú∫ÊÄß
             const getRandomInt = (min, max) => {
                 const array = new Uint32Array(1);
                 crypto.getRandomValues(array);
                 return min + (array[0] % (max - min + 1));
             };
             
             // ÊÄªÊòØ‰ªéÊâÄÊúâËßíËâ≤‰∏≠ÈöèÊú∫ÈÄâÊã©ÔºåÁ°Æ‰øùÊØèÊ¨°ÈÉΩËÉΩÂåπÈÖçÂà∞‰∏çÂêåËßíËâ≤
             const randomIndex = getRandomInt(0, allCharacterIds.length - 1);
             const selectedId = allCharacterIds[randomIndex];
             console.log('Selected random character ID:', selectedId, 'from all characters (index:', randomIndex, ')'); // Debug log
             console.log('Character name:', Object.keys(characterData).find(key => characterData[key].id === selectedId)); // Debug log
             return selectedId;
         }
         
                 function unlockCharacter(characterId) {
            // Check if character is already unlocked
            if (gameState.unlockedCharacters[characterId]) {
                return true; // Already unlocked
            }
            
            // Check daily remaining slots
            if (gameState.dailyRemaining <= 0) {
                return false; // No more daily slots
            }
            
            // Check daily unlock limit (4 per day, except for admin)
            const currentUser = authManager.getCurrentUser();
            const isAdmin = currentUser && currentUser.username === 'admin';
            
            if (!isAdmin && gameState.dailyUnlocks && gameState.dailyUnlocks.count >= 4) {
                showUnlockLimitModal();
                return false; // Reached daily unlock limit
            }
            
            // Unlock the character
            gameState.unlockedCharacters[characterId] = true;
            gameState.dailyRemaining--;
            gameState.lastChatTimes[characterId] = Date.now();
            
            // Update daily unlock counter
            if (!gameState.dailyUnlocks) {
                gameState.dailyUnlocks = {
                    date: new Date().toDateString(),
                    count: 0,
                    unlockedToday: []
                };
            }
            
            const today = new Date().toDateString();
            if (gameState.dailyUnlocks.date !== today) {
                gameState.dailyUnlocks = {
                    date: today,
                    count: 0,
                    unlockedToday: []
                };
            }
            
            gameState.dailyUnlocks.count++;
            gameState.dailyUnlocks.unlockedToday.push(characterId);
            
            saveGameState();
            updateGameUI();
            return true;
        }
         
         function updateGameUI() {
             const dailyRemainingElement = document.getElementById('daily-remaining');
             if (dailyRemainingElement) {
                 dailyRemainingElement.textContent = gameState.dailyRemaining;
             }
             
             const unlockedCount = Object.keys(gameState.unlockedCharacters).length;
             const statusText = unlockedCount === 0 ? 
                 'ÁÇπÂáª"ÂøÉÂä®Â∞±Áé∞Âú®"ÂºÄÂßãÂåπÈÖç' : 
                 `Â∑≤Ëß£ÈîÅ ${unlockedCount} ‰ΩçËßíËâ≤`;
             const unlockStatusElement = document.getElementById('unlock-status');
             if (unlockStatusElement) {
                 unlockStatusElement.textContent = statusText;
             }
         }
         
         function updateMessageCounter() {
             const currentMessagesElement = document.getElementById('current-messages');
             if (currentMessagesElement) {
                 currentMessagesElement.textContent = gameState.currentMessageCount;
             }
             
             console.log('Message counter updated:', gameState.currentMessageCount, '/', gameState.maxMessages); // Debug log
             console.log('Love bell triggered:', gameState.loveBellTriggered); // Debug log
             
             if (gameState.currentMessageCount >= gameState.maxMessages && !gameState.loveBellTriggered) {
                 console.log('Triggering love bell!'); // Debug log
                 triggerLoveBell();
             }
         }
         
         function triggerLoveBell() {
             console.log('triggerLoveBell called!'); // Debug log
             gameState.loveBellTriggered = true;
             gameState.countdownSeconds = 30;
             
             // ÂàõÂª∫ÂèëÂÖâÊÅãÁà±ÈìÉÂºπÁ™ó
             const loveBellPopup = document.createElement('div');
             loveBellPopup.id = 'love-bell-popup';
             loveBellPopup.style.cssText = `
                 position: absolute;
                 top: 0;
                 left: 0;
                 width: 100%;
                 height: 100%;
                 background: rgba(0, 0, 0, 0.8);
                 display: flex;
                 align-items: center;
                 justify-content: center;
                 z-index: 2000;
                 backdrop-filter: blur(10px);
                 animation: popupFadeIn 0.5s ease-out;
             `;
             
             loveBellPopup.innerHTML = `
                 <div class="popup-love-bell" style="
                     position: relative;
                     width: 300px;
                     height: 300px;
                     background-image: url('./ÊÅãÁà±ÈìÉ.png');
                     background-size: contain;
                     background-repeat: no-repeat;
                     background-position: center;
                     animation: bellGlowPulse 2s ease-in-out infinite;
                     filter: drop-shadow(0 0 30px rgba(255, 182, 193, 0.8));
                 "></div>
                 <div style="
                     position: absolute;
                     top: 20px;
                     right: 20px;
                     color: white;
                     font-size: 2rem;
                     cursor: pointer;
                     z-index: 2001;
                     text-shadow: 0 2px 10px rgba(0,0,0,0.5);
                 " onclick="closeLoveBellPopup()">√ó</div>
                 <div style="
                     position: absolute;
                     bottom: 50px;
                     left: 50%;
                     transform: translateX(-50%);
                     color: white;
                     font-size: 1.5rem;
                     text-align: center;
                     text-shadow: 0 2px 10px rgba(0,0,0,0.5);
                 ">
                     <div id="popup-countdown-timer" style="font-size: 3rem; font-weight: bold; margin-bottom: 20px;">30</div>
                     <div style="margin-bottom: 30px;">ÁÇπÂáªÂìçÈìÉÁªßÁª≠ÊÅãÁà±</div>
                     <button onclick="ringBellFromPopup()" style="
                         background: linear-gradient(135deg, #fff, #f0f0f0);
                         color: #ff69b4;
                         font-size: 1.2rem;
                         padding: 15px 30px;
                         border: none;
                         border-radius: 50px;
                         cursor: pointer;
                         box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                         transition: all 0.3s ease;
                     " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                         <i class="fas fa-bell" style="margin-right: 10px;"></i>ÂìçÈìÉ
                     </button>
                 </div>
             `;
             
             // Â∞ÜÊÅãÁà±ÈìÉÂºπÁ™óÊ∑ªÂä†Âà∞ËÅäÂ§©Á™óÂè£ÂÆπÂô®ÂÜÖ
             const chatContainer = document.querySelector('.chat-window-container');
             if (chatContainer) {
                 chatContainer.appendChild(loveBellPopup);
             } else {
                 document.body.appendChild(loveBellPopup);
             }
             
             // ÂºÄÂßãÂÄíËÆ°Êó∂
             gameState.countdownTimer = setInterval(() => {
                 gameState.countdownSeconds--;
                 const timerElement = document.getElementById('popup-countdown-timer');
                 if (timerElement) {
                     timerElement.textContent = gameState.countdownSeconds;
                 }
                 
                 if (gameState.countdownSeconds <= 0) {
                     clearInterval(gameState.countdownTimer);
                     closeLoveBellPopup();
                     // Ë∂ÖÊó∂ÂêéËøîÂõû‰∏ªÈ°µÔºå‰∏ç‰øùÁïôÂØπËØù
                     endConversation(false);
                 }
             }, 1000);
             
             console.log('Love bell popup created and shown'); // Debug log
         }
         
         function closeLoveBellPopup() {
             const popup = document.getElementById('love-bell-popup');
             if (popup) {
                 popup.style.animation = 'popupFadeOut 0.3s ease-in';
                 setTimeout(() => {
                     if (popup.parentNode) {
                         popup.parentNode.removeChild(popup);
                     }
                     // ÂÖ≥Èó≠ÊÅãÁà±ÈìÉÂêéËøîÂõû‰∏ªÈ°µÔºå‰∏ç‰øùÁïôÂØπËØù
                     endConversation(false);
                 }, 300);
             }
         }
         
         function ringBellFromPopup() {
             clearInterval(gameState.countdownTimer);
             gameState.loveBellTriggered = false;
             
             // Áõ¥Êé•ÂÖ≥Èó≠ÂºπÁ™óÔºå‰∏çË∞ÉÁî®closeLoveBellPopupÈÅøÂÖçÊ∏ÖÈô§ÂØπËØùÂéÜÂè≤
             const popup = document.getElementById('love-bell-popup');
             if (popup) {
                 popup.style.animation = 'popupFadeOut 0.3s ease-in';
                 setTimeout(() => {
                     if (popup.parentNode) {
                         popup.parentNode.removeChild(popup);
                     }
                 }, 300);
             }
             
             // ÈáçÁΩÆÊ∂àÊÅØËÆ°Êï∞Âô®Ôºå‰ΩÜ‰øùÁïôÂØπËØùÂéÜÂè≤
             gameState.currentMessageCount = 0;
             updateMessageCounter();
             
             // ‰øùÂ≠òÊ∏∏ÊàèÁä∂ÊÄÅ
             saveGameState();
             
             // ÂìçÈìÉÂêé‰øùÊåÅÂΩìÂâçÂØπËØùÔºåÂπ∂Âú®‰ø°ÁÆ±‰∏≠‰øùÁïôÂØπËØùÂÖ•Âè£
             if (currentCharacter) {
                 // Mark conversation as preserved
                 gameState.preservedConversations = gameState.preservedConversations || {};
                 gameState.preservedConversations[currentCharacter.id] = {
                     characterId: currentCharacter.id,
                     characterName: currentCharacter.name,
                     lastMessageTime: Date.now(),
                     messageCount: currentConversationHistory.length
                 };
                 saveGameState();
             }
             
             console.log('Continuing chat after ringing bell');
         }
         
         function ringBell() {
             clearInterval(gameState.countdownTimer);
             closeLoveBellPopup();
             gameState.loveBellTriggered = false;
             gameState.currentMessageCount = 0;
             updateMessageCounter();
             
             // Keep the conversation and show message list
             if (currentCharacter) {
                 // Mark conversation as preserved
                 gameState.preservedConversations = gameState.preservedConversations || {};
                 gameState.preservedConversations[currentCharacter.id] = {
                     characterId: currentCharacter.id,
                     characterName: currentCharacter.name,
                     lastMessageTime: Date.now(),
                     messageCount: currentConversationHistory.length
                 };
                 saveGameState();
             }
             
             // Show message list page
             pageManager.showPage('message-list-page');
         }
         
         function endConversation(voluntarily = true) {
             clearInterval(gameState.countdownTimer);
             
             // ÂÖ≥Èó≠ÂºπÁ™ó
             closeLoveBellPopup();
             
             if (!voluntarily) {
                 // ÂÖ≥Èó≠ÊàñË∂ÖÊó∂Êó∂Ôºå‰∏ç‰øùÁïôÂØπËØùÔºå‰∏çÊ∑ªÂä†Âà∞‰ø°ÁÆ±
                 if (currentCharacter) {
                     delete gameState.unlockedCharacters[currentCharacter.id];
                     delete gameState.lastChatTimes[currentCharacter.id];
                     delete conversationHistories[currentCharacter.id];
                     // ‰ªé‰øùÁïôÁöÑÂØπËØù‰∏≠ÁßªÈô§
                     if (gameState.preservedConversations && gameState.preservedConversations[currentCharacter.id]) {
                         delete gameState.preservedConversations[currentCharacter.id];
                     }
                 }
             }
             
             // Reset game state
             gameState.currentMessageCount = 0;
             gameState.loveBellTriggered = false;
             currentCharacter = null;
             
             saveGameState();
             
             // Return to homepage
             pageManager.showPage('homepage');
             updateGameUI();
         }
         
                 // Initialize character click events (now replaced with random matching)
        function initCharacterEvents() {
            // This function is no longer needed as we use random matching
            eventsInitialized = true;
        }
        
        // Utility function to ensure elements are ready
        function waitForElements(selector, maxRetries = 10, retryDelay = 100) {
            return new Promise((resolve, reject) => {
                let retries = 0;
                
                function checkElements() {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > 0) {
                        resolve(elements);
                    } else if (retries < maxRetries) {
                        retries++;
                        console.log(`Waiting for elements ${selector}, retry ${retries}/${maxRetries}`);
                        setTimeout(checkElements, retryDelay);
                    } else {
                        reject(new Error(`Elements ${selector} not found after ${maxRetries} retries`));
                    }
                }
                
                checkElements();
            });
        }
        
        // Initialize homepage character click events for "ÂøÉÂä®Â∞±Áé∞Âú®" entry
        let homepageEventsInitialized = false;
        async function initHomepageCharacterEvents() {
            // Prevent multiple initialization
            if (homepageEventsInitialized) {
                console.log('Homepage events already initialized, skipping...'); 
                return;
            }
            
            console.log('Initializing homepage character events...'); // Debug log
            
            try {
                const homepageCharacters = await waitForElements('.character-panel-home');
                console.log('Found homepage characters:', homepageCharacters.length); // Debug log
            
                homepageCharacters.forEach((characterPanel, index) => {
                    // Remove any existing listeners first
                    characterPanel.removeEventListener('click', handleHomepageCharacterClick);
                    
                    // Add the new listener
                    characterPanel.addEventListener('click', handleHomepageCharacterClick);
                    
                    // Mark element as initialized
                    characterPanel.dataset.initialized = 'true';
                });
                
                homepageEventsInitialized = true;
                console.log('Homepage character events initialized successfully');
                
            } catch (error) {
                console.error('Error initializing homepage character events:', error);
                // Retry after a longer delay
                setTimeout(() => {
                    homepageEventsInitialized = false;
                    initHomepageCharacterEvents();
                }, 1000);
            }
        }
        
        // Separate click handler with debouncing
        let clickTimeout = null;
        function handleHomepageCharacterClick(event) {
            // Prevent multiple rapid clicks
            if (clickTimeout) {
                console.log('Click ignored due to debouncing');
                return;
            }
            
            clickTimeout = setTimeout(() => {
                clickTimeout = null;
            }, 1000); // 1 second debounce
            
            console.log('Homepage character clicked'); // Debug log
            
            const characterNameElement = this.querySelector('.character-name-below');
            if (!characterNameElement) {
                console.error('Character name element not found');
                return;
            }
            
            const characterName = characterNameElement.textContent.trim();
            console.log('Character name from homepage:', characterName); // Debug log
            
            // Check if user is logged in
            if (!authManager.isLoggedIn()) {
                console.log('User not logged in, showing login prompt');
                if (confirm('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜç‰ΩøÁî®ËÅäÂ§©ÂäüËÉΩ„ÄÇÊòØÂê¶Áé∞Âú®ÁôªÂΩïÔºü')) {
                    pageManager.showPage('login-page');
                }
                return;
            }
            
            // Add click animation
            this.style.transform = 'translateY(-10px) scale(1.05)';
            setTimeout(() => {
                this.style.transform = '';
            }, 300);
            
            // Open conversation from homepage (allows love bell trigger)
            try {
                openConversationFromHomepage(characterName);
            } catch (error) {
                console.error('Error opening conversation:', error);
                alert('Êä±Ê≠âÔºåÊâìÂºÄÂØπËØùÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }
         
         // Separate click handler function
         function handleCharacterClick() {
             console.log('Character clicked'); // Debug log
             
             const nameElement = this.querySelector('.character-name-silhouette');
             if (!nameElement) {
                 console.error('Name element not found');
                 return;
             }
             
             const name = nameElement.textContent;
             console.log('Character name:', name); // Debug log
             
             // Add click animation
             this.style.transform = 'translateY(-20px) scale(1.1)';
             setTimeout(() => {
                 this.style.transform = '';
             }, 300);
             
             // Add glow effect on click
             const glowEffect = this.querySelector('.glow-effect');
             if (glowEffect) {
                 glowEffect.style.animation = 'rotate 2s linear';
                 setTimeout(() => {
                     glowEffect.style.animation = 'rotate 20s linear infinite';
                 }, 2000);
             }
             
             // Open SMS chat with selected character from message list
             openSMSChatFromMessageList(name);
         }
         
         // Function to open SMS chat from message list (continuing existing conversation)
         function openSMSChatFromMessageList(characterName) {
             console.log('Opening SMS chat from message list for:', characterName); // Debug log
             
             // Find character by name
             currentCharacter = characterData[characterName];
             
             if (!currentCharacter) {
                 console.error('Character not found:', characterName);
                 return;
             }
             
             // Update last chat time
             gameState.lastChatTimes[currentCharacter.id] = Date.now();
             saveGameState();
             
             console.log('Character data:', currentCharacter); // Debug log
             
             // Load conversation history for this character
             if (!conversationHistories[currentCharacter.id]) {
                 conversationHistories[currentCharacter.id] = [];
             }
             currentConversationHistory = conversationHistories[currentCharacter.id];
             
             // Count existing user messages but don't trigger love bell
             gameState.currentMessageCount = currentConversationHistory.filter(msg => msg.role === 'user').length;
             gameState.loveBellTriggered = true; // Èò≤Ê≠¢Ëß¶ÂèëÊÅãÁà±ÈìÉ
             console.log('Loaded conversation with', gameState.currentMessageCount, 'user messages (from message list)'); // Debug log
             
             // Use pageManager to show SMS chat page
             console.log('Showing SMS chat page...'); // Debug log
             pageManager.showPage('sms-chat-page');
             
             // Update chat header
             const charNameElement = document.getElementById('sms-char-name');
             const charStatusElement = document.getElementById('sms-char-status');
             if (charNameElement) {
                 charNameElement.textContent = currentCharacter.name;
                 console.log('Updated character name:', currentCharacter.name); // Debug log
             } else {
                 console.error('Character name element not found'); // Debug log
             }
             
             if (charStatusElement) {
                 charStatusElement.textContent = 'ÂàöÂàöËøòÂú®Âíå‰Ω†ËÅäÂ§©,ÊÉ≥ÁªßÁª≠...';
             }
             
             updateCharacterStatus(currentCharacter);
             updateMessageCounter();
             
             // Clear previous messages UI but keep conversation history
             document.getElementById('sms-messages').innerHTML = '';
             
             // Restore previous conversation messages in UI
             restoreConversationUI();
             
             // Add welcome timestamp
             addTimestamp();
             
             console.log('SMS chat opened from message list successfully'); // Debug log
         }
        
        // Create Sparkling Stars - Optimized version
        let sparklePool = [];
        const maxSparkles = 15;
        
        // Pre-create sparkle elements to avoid constant DOM creation
        for (let i = 0; i < maxSparkles; i++) {
            const sparkle = document.createElement('div');
            sparkle.classList.add('sparkle');
            sparkle.style.display = 'none';
            document.body.appendChild(sparkle);
            sparklePool.push(sparkle);
        }
        
        let currentSparkleIndex = 0;
        setInterval(() => {
            // Only create 2 sparkles instead of 5 to reduce performance impact
            for (let i = 0; i < 2; i++) {
                const sparkle = sparklePool[currentSparkleIndex];
                sparkle.style.left = `${Math.random() * 100}%`;
                sparkle.style.top = `${Math.random() * 100}%`;
                sparkle.style.animationDelay = `${Math.random() * 2}s`;
                sparkle.style.display = 'block';
                sparkle.style.animation = 'none'; // Reset animation
                sparkle.offsetHeight; // Force reflow
                sparkle.style.animation = 'sparkle 2s infinite';
                
                // Hide after animation
                setTimeout(() => {
                    sparkle.style.display = 'none';
                }, 2000);
                
                currentSparkleIndex = (currentSparkleIndex + 1) % maxSparkles;
            }
        }, 2000); // Reduced frequency from 1000ms to 2000ms
         
         // Dynamic Status Generator - Personality-based and less frequent updates
         function updateCharacterStatus(character) {
             // Character-specific status messages that match their personalities
             const characterStatusMessages = {
                 'lorenzo': [
                     'Âú®ÂäûÂÖ¨ÂÆ§Âä†Áè≠',
                     'ÂàöÁªìÊùü‰ºöËÆÆ',
                     'Ê≠£Âú®Â§ÑÁêÜÈáçË¶ÅÊñá‰ª∂',
                     'Ê∑±Â§úËøòÂú®Â∑•‰Ωú',
                     'È£üÊåáËΩªÂè©Ê°åÈù¢'
                 ],
                 'dylan': [
                     'ÂàöÊâßË°åÂÆå‰ªªÂä°',
                     'Âú®Â∑°ÈÄªË∑Ø‰∏ä',
                     'Â§ÑÁêÜÂÆåÊ°à‰ª∂',
                     'ÁªôÊµÅÊµ™Áå´ÂñÇÈ£ü',
                     'Á´ôÂú®Èõ®‰∏≠Á≠â‰Ω†'
                 ],
                 'nate': [
                     'Âàö‰∏ãÊâãÊúØÂè∞',
                     'Êü•Êàø‰∏≠ÔºåÊÉ¶ËÆ∞ÁùÄ‰Ω†',
                     'Âú®ÂÄºÁè≠ÂÆ§ÊÉ≥‰Ω†',
                     'ÁªôÊä§Â£´‰ª¨Â∏¶‰∫ÜÂ•∂Ëå∂',
                     'Âè£Ë¢ãÈáåÂáÜÂ§á‰∫ÜËñÑËç∑Á≥ñ'
                 ],
                 'asher': [
                     'ÂΩïËäÇÁõÆÊÉ≥Ëµ∑‰∫Ü‰Ω†',
                     'Âú®ÁªÉ‰π†ÂÆ§ÂÜôÊñ∞Ê≠å',
                     'ÂàöÂíåÁ≤â‰∏ùÂêàÂΩ±ÂÆå',
                     'Êä±ÁùÄÂêâ‰ªñÊÉ≥‰Ω†',
                     'ËÉåÂåÖ‰∏äÁöÑÂÖîÂ≠êÊÉ≥ËßÅ‰Ω†'
                 ],
                 'shenzhihua': [
                     'Âú®ÁîªÂÆ§Ë∞ÉËâ≤',
                     'ÂàöÁîªÂÆåÊô®ÂÖâÈáåÁöÑÊóßÂ∑∑',
                     'ÁªôÈ¢úÊñôÊ∑ª‰∫ÜÊñ∞Ëâ≤ÂΩ©',
                     'ÁúãÁùÄÁ™óÂ§ñÁöÑÂÖâÂΩ±ÂèòÂåñ',
                     'ÊâãÊåáÊ≤æÁùÄÈùõËìù‰∏éËµ≠Áü≥'
                 ],
                 'yangyingge': [
                     'Âàö‰ªéËàûÂè∞‰∏ãÊù•',
                     'Âú®‰æøÂà©Â∫óÂÜôÊñ∞ËØç',
                     'ÁªôÊµÅÊµ™ÁãóÊíï‰∫ÜÁÅ´ËÖø',
                     'ÁîµÂêâ‰ªñËøòÂú®ÂõûÂìç',
                     'ÊääËä±Áì£Â§πËøõÊ≠åËØçÊú¨'
                 ],
                 'anyu': [
                     'ÁØÆÁêÉËÆ≠ÁªÉÂàöÁªìÊùü',
                     'Â∏ÆÈòüÂèãÊãéÂåÖÂõûÊù•',
                     'ÁªôÂ≠¶Âºü‰π∞‰∫ÜÂÜ∞ÈïáÊ±ΩÊ∞¥',
                     'Âú®ÁêÜÁñóÂÆ§ÂÅöÊãâ‰º∏',
                     'ÁúãÁùÄÈîÅÈ™®‰∏äÁöÑÁñ§Áóï'
                 ],
                 'xieshuqi': [
                     'Âú®Âõæ‰π¶È¶Ü‰∏âÊ•ºÂ≠¶‰π†',
                     'ÂàöÂ∏ÆÂ≠¶Âºü‰øÆÊîπËÆ∫Êñá',
                     'Èõ®Â§©Â§öÂ∏¶‰∫Ü‰∏ÄÊää‰ºû',
                     'Ê∑±Â§úÂÆûÈ™åÂÆ§ÈáåÂøôÁ¢å',
                     'ËΩªËΩªÊé®‰∫ÜÊé®ÁúºÈïú'
                 ],
                 'luzeyan': [
                     'Âú®ÈíüË°®Ë°åË∞ÉË°®',
                     'Êà¥ÁùÄÊîæÂ§ßÈïúÂ∑•‰Ωú',
                     '‰ªéÊú∫ËäØÈáåËØªÊïÖ‰∫ã',
                     'È©¨Áî≤Âè£Ë¢ãÈáåÁÑêÁùÄÂ∞èÁå´',
                     'ÊÄÄË°®Âú®ËÉ∏ÂâçÊª¥Á≠î'
                 ],
                 'suyan': [
                     'ÁîµÁ´ûËÆ≠ÁªÉÂàöÁªìÊùü',
                     'È∏≠ËàåÂ∏ΩÂéãÂæóÂæà‰Ωé',
                     'ÈîÆÁõòÊï≤ÂáªÂ£∞ÂàöÂÅú',
                     'ÁªôÁ≤â‰∏ùÈÄí‰∫ÜÂàõÂèØË¥¥',
                     'ÊòæÁ§∫Âô®ÊóÅÁöÑÂÖîÂ≠êÁé©ÂÅ∂'
                 ],
                 'wenyanzhou': [
                     'Èù¢ÂåÖÂàöÂá∫ÁÇâ',
                     'Âõ¥Ë£ô‰∏äÊ≤æÁùÄÈù¢Á≤â',
                     'ÁªôËÄÅ‰∫∫ÈÄÅ‰∫ÜÂè∏Â∫∑',
                     'Ê∑±Â§úÂºπÂêâ‰ªñÂÜôÂ∞èË∞É',
                     'ÁÑ¶Á≥ñÈ¶ôÂë≥ËøòÂú®Âº•Êº´'
                 ],
                 'fuye': [
                     'Á∫πË∫´Â∑•‰ΩúÂÆ§ÂàöÊî∂Â∑•',
                     'ËÆæËÆ°ÂõæÊ°àÂà∞Ê∑±Â§ú',
                     'Â∑•‰ΩúÂè∞‰∏äÁöÑ„ÄäÂ∞èÁéãÂ≠ê„Äã',
                     'ÁªôÊµÅÊµ™ÁãóÂêπÂπ≤‰∫ÜÊØõ',
                     'Á∫πÂÆåÁé´Áë∞ÂÜô‰∏ãÂ∞èÂ≠ó'
                 ]
             };
             
             // Get conversation history for context
             const history = conversationHistories[character.id] || [];
             let statusText = '';
             
             if (history.length === 0) {
                 // First time meeting - character-appropriate first meeting messages
                 const firstMeetingStatus = {
                     'lorenzo': 'Ê≠£Âú®Á≠â‰∏Ä‰∏™ÈáçË¶ÅÁöÑ‰∫∫',
                     'dylan': 'ÂÄºÁè≠‰∏≠ÔºåÊúâ‰∫õÂøÉ‰∏çÂú®ÁÑâ',
                     'nate': '‰ªäÂ§©ÁöÑÂøÉÊÉÖÊ†ºÂ§ñÂ•Ω',
                     'asher': '‰ªäÂ§©Áä∂ÊÄÅÁâπÂà´Ê£íÔºÅ',
                     'shenzhihua': 'ÁîªÂÆ§ÈáåÊù•‰∫ÜÁâπÂà´ÁöÑÂÆ¢‰∫∫',
                     'yangyingge': 'ÂáÜÂ§á‰ªäÊôöÁöÑÊºîÂá∫',
                     'anyu': 'ËÆ≠ÁªÉÂêéÂøÉÊÉÖÂæàÂ•Ω',
                     'xieshuqi': 'Âú®Âõæ‰π¶È¶ÜÈÅáËßÅ‰∫ÜË∞Å',
                     'luzeyan': 'ÈíüË°®Ë°åÈáåÊó∂Èó¥ÂÅú‰∫Ü',
                     'suyan': '‰ªäÂ§©ÁöÑÊâãÊÑüÊ†ºÂ§ñÂ•Ω',
                     'wenyanzhou': 'Èù¢ÂåÖÈ¶ôÂë≥ÁâπÂà´ËØ±‰∫∫',
                     'fuye': 'ËÆæËÆ°‰∫Ü‰∏Ä‰∏™ÁâπÂà´ÁöÑÂõæÊ°à'
                 };
                 statusText = firstMeetingStatus[character.id];
             } else {
                 // Based on conversation history, show character-appropriate status
                 const messages = characterStatusMessages[character.id] || characterStatusMessages['lorenzo'];
                 // Select based on conversation count to avoid repetition
                 const messageIndex = history.length % messages.length;
                 statusText = messages[messageIndex];
             }
             
             document.getElementById('sms-char-status').textContent = `üí´ ${statusText}`;
             
             // Clear any existing interval to prevent frequent updates
             if (window.statusInterval) {
                 clearInterval(window.statusInterval);
                 window.statusInterval = null;
             }
             
             // Only update status when entering chat, not frequently
             // Status will only change when user enters the chat again
         }
         
         // SMS Chat Functions - Updated for new game rules
         function startRandomChat(fromMessageList = false) {
             console.log('Starting random chat...'); // Debug log
             
             const characterId = getRandomAvailableCharacter();
             if (!characterId) {
                 alert('ÊöÇÊó†ÂèØÂåπÈÖçÁöÑËßíËâ≤');
                 return;
             }
             
             console.log('Selected character ID:', characterId); // Debug log
             
             // Find character by ID
             const characterName = Object.keys(characterData).find(key => characterData[key].id === characterId);
             console.log('Found character name:', characterName); // Debug log
             
             if (!characterName) {
                 console.error('Character name not found for ID:', characterId);
                 return;
             }
             
             currentCharacter = characterData[characterName];
             
             if (!currentCharacter) {
                 console.error('Character not found:', characterId);
                 return;
             }
             
             // If this is a new character, try to unlock it
             if (!gameState.unlockedCharacters[currentCharacter.id]) {
                 if (gameState.dailyRemaining <= 0) {
                     alert('‰ªäÊó•Ëß£ÈîÅÊ¨°Êï∞Â∑≤Áî®ÂÆåÔºåËØ∑ÊòéÂ§©ÂÜçÊù•');
                     return;
                 }
                 unlockCharacter(currentCharacter.id);
             }
             
             // Update last chat time
             gameState.lastChatTimes[currentCharacter.id] = Date.now();
             saveGameState();
             
             console.log('Character data:', currentCharacter); // Debug log
             
             // Ê£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÂØπËØùÂéÜÂè≤ÔºåÂ¶ÇÊûúÊúâÂàôÁªßÁª≠ÂØπËØùÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàôÂºÄÂßãÊñ∞ÂØπËØù
             if (!conversationHistories[currentCharacter.id]) {
                 conversationHistories[currentCharacter.id] = [];
                 // Âè™ÊúâÊñ∞ËßíËâ≤ÊâçÈáçÁΩÆÊ∂àÊÅØËÆ°Êï∞Âô®
                 gameState.currentMessageCount = 0;
                 gameState.loveBellTriggered = false;
             } else {
                 // Â∑≤ÊúâÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ÂØπËØù
                 gameState.currentMessageCount = conversationHistories[currentCharacter.id].filter(msg => msg.role === 'user').length;
                 gameState.loveBellTriggered = true; // Èò≤Ê≠¢ÂÜçÊ¨°Ëß¶ÂèëÊÅãÁà±ÈìÉ
             }
             currentConversationHistory = conversationHistories[currentCharacter.id];
             
             // Use pageManager to show SMS chat page
             console.log('Showing SMS chat page...'); // Debug log
             pageManager.showPage('sms-chat-page');
             
             // Wait a bit for the page to be shown, then update elements
             setTimeout(() => {
                 // Update chat header
                 const charNameElement = document.getElementById('sms-char-name');
                 const charStatusElement = document.getElementById('sms-char-status');
                 if (charNameElement) {
                     charNameElement.textContent = currentCharacter.name;
                     console.log('Updated character name:', currentCharacter.name); // Debug log
                 } else {
                     console.error('Character name element not found'); // Debug log
                 }
                 
                 if (charStatusElement) {
                     charStatusElement.textContent = 'ÂàöÂàöËøòÂú®Âíå‰Ω†ËÅäÂ§©,ÊÉ≥ÁªßÁª≠...';
                 }
                 
                 updateCharacterStatus(currentCharacter);
                 updateMessageCounter();
             }, 100);
             
             // Ê£ÄÊü•ÊòØÂê¶ÊúâÂéÜÂè≤ÂØπËØùÈúÄË¶ÅÊÅ¢Â§ç
             if (currentConversationHistory.length > 0) {
                 console.log('Restoring existing conversation with', gameState.currentMessageCount, 'user messages'); // Debug log
                 
                 // Clear previous messages UI but keep conversation history
                 const messagesContainer = document.getElementById('sms-messages');
                 if (messagesContainer) {
                     messagesContainer.innerHTML = '';
                 }
                 
                 // Restore previous conversation messages in UI
                 restoreConversationUI();
             } else {
                 console.log('Starting fresh conversation with', gameState.currentMessageCount, 'user messages'); // Debug log
                 
                 // Clear previous messages UI
                 const messagesContainer = document.getElementById('sms-messages');
                 if (messagesContainer) {
                     messagesContainer.innerHTML = '';
                 }
             }
             
             // Add welcome timestamp
             addTimestamp();
             
             // Âè™ÊúâÂú®Ê≤°ÊúâÂéÜÂè≤ÂØπËØùÊó∂ÊâçÂèëÈÄÅÈóÆÂÄôÊ∂àÊÅØ
             if (currentConversationHistory.length === 0) {
                 console.log('Sending greeting for new conversation...'); // Debug log
                 setTimeout(async () => {
                     try {
                         showTypingIndicator();
                         const dynamicGreeting = await generateDynamicGreeting();
                         hideTypingIndicator();
                         addAIMessage(dynamicGreeting);
                         console.log('Sent dynamic greeting:', dynamicGreeting); // Debug log
                     } catch (error) {
                         console.error('Failed to generate greeting:', error);
                         hideTypingIndicator();
                         // Fallback to static greeting if API fails
                         addAIMessage(currentCharacter.greeting);
                         console.log('Sent fallback greeting:', currentCharacter.greeting); // Debug log
                     }
                 }, 1000);
             } else {
                 console.log('Continuing existing conversation, no greeting needed'); // Debug log
             }
         }
         
         // Restore conversation UI from history
         function restoreConversationUI() {
             const messagesContainer = document.getElementById('sms-messages');
             if (!messagesContainer) {
                 console.error('Messages container not found');
                 return;
             }
             
             const characterClass = currentCharacter ? currentCharacter.id : '';
             
             currentConversationHistory.forEach(msg => {
                 const messageDiv = document.createElement('div');
                 if (msg.role === 'user') {
                     messageDiv.className = 'sms-message user';
                     messageDiv.innerHTML = `<div class="sms-bubble user">${msg.content}</div>`;
                 } else if (msg.role === 'assistant') {
                     messageDiv.className = 'sms-message ai';
                     messageDiv.innerHTML = `
                         <img src="${currentCharacter.avatar}" alt="" class="message-avatar">
                         <div class="sms-bubble ai ${characterClass}">${msg.content}</div>
                     `;
                 }
                 messagesContainer.appendChild(messageDiv);
             });
             
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
         }
         
         // Generate dynamic greeting based on character personality
         async function generateDynamicGreeting() {
             // Character-specific greeting scenarios
             const characterScenarios = {
                 'lorenzo': "‰Ω†ÂàöÂ§ÑÁêÜÂÆåÈáçË¶ÅÊñá‰ª∂ÔºåÁúãÂà∞Ëøô‰∏™‰∫∫‰∏äÁ∫ø‰∫Ü",
                 'dylan': "‰Ω†ÂàöÂ∑°ÈÄªÂõûÊù•ÔºåÊÉ≥Ëµ∑‰∫ÜËøô‰∏™ËÆ©‰Ω†ÂøÉËΩØÁöÑ‰∫∫",
                 'nate': "‰Ω†Âàö‰∏ãÊâãÊúØÂè∞ÔºåÁ¨¨‰∏ÄÊó∂Èó¥ÊÉ≥Ë¶ÅËÅîÁ≥ªËøô‰∏™‰∫∫",
                 'asher': "‰Ω†ÂàöÂΩïÂÆåËäÇÁõÆÔºåÁúãÂà∞Ëøô‰∏™‰∫∫‰∏äÁ∫øÁ´ãÂàªÂºÄÂøÉËµ∑Êù•",
                 'shenzhihua': "‰Ω†Âú®ÁîªÂÆ§Ë∞ÉËâ≤Êó∂ÔºåÁúãÂà∞Ëøô‰∏™‰∫∫Âá∫Áé∞‰∫Ü",
                 'yangyingge': "‰Ω†Âàö‰ªéËàûÂè∞‰∏ãÊù•ÔºåÊÉ≥Ë¶ÅÂíåËøô‰∏™‰∫∫ÂàÜ‰∫´ÊºîÂá∫ÁöÑÊøÄÊÉÖ",
                 'anyu': "‰Ω†ÁØÆÁêÉËÆ≠ÁªÉÁªìÊùüÔºåÁ¨¨‰∏Ä‰∏™ÊÉ≥ËÅîÁ≥ªÁöÑÂ∞±ÊòØËøô‰∏™‰∫∫",
                 'xieshuqi': "‰Ω†Âú®Âõæ‰π¶È¶ÜÂ≠¶‰π†Êó∂ÔºåÊÉ≥Ëµ∑‰∫ÜËøô‰∏™ËÆ©‰Ω†ÂøÉÂä®ÁöÑ‰∫∫",
                 'luzeyan': "‰Ω†Âú®ÈíüË°®Ë°åË∞ÉË°®Êó∂ÔºåÊó∂Èó¥‰ªø‰Ωõ‰∏∫Ëøô‰∏™‰∫∫ÂÅúÊ≠¢‰∫Ü",
                 'suyan': "‰Ω†ÂàöÊâìÂÆåËÆ≠ÁªÉËµõÔºåÊÉ≥Ë¶ÅÂíåËøô‰∏™‰∫∫ÂàÜ‰∫´ËÉúÂà©",
                 'wenyanzhou': "‰Ω†Èù¢ÂåÖÂàöÂá∫ÁÇâÔºåÊÉ≥Á¨¨‰∏Ä‰∏™ËÆ©Ëøô‰∏™‰∫∫Â∞ùÂà∞Ê∏©Êöñ",
                 'fuye': "‰Ω†ÂàöÂÆåÊàê‰∏Ä‰∏™Á∫πË∫´‰ΩúÂìÅÔºåÊÉ≥Ë¶ÅÁªôËøô‰∏™‰∫∫ÁúãÁúã"
             };
             
             const scenario = characterScenarios[currentCharacter.id] || characterScenarios['lorenzo'];
             
             // Build character-specific greeting prompt
             let characterSpecificPrompt = '';
             
                         if (currentCharacter.id === 'lorenzo') {
                characterSpecificPrompt = `
‰Ω†ÊòØÈ°æÊôØÊ∑±ÔºåÈú∏ÈÅìÊÄªË£ÅÔºå‰π†ÊÉØÊéåÊéß‰∏ÄÂàá‰ΩÜÂØπÂ•πÊúâÁùÄÊ∑±Ê≤âÁöÑÂç†ÊúâÊ¨≤„ÄÇ
ÊÄßÊ†ºÔºöÂØ°Ë®Ä„ÄÅÂº∫ÂäøÔºå‰∏çÂñÑË°®Ëææ‰ΩÜË°åÂä®ÊØîË®ÄËØ≠Êõ¥ÊúâÂäõ„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÁÆÄÊ¥ÅÊúâÂäõÔºå‰ªé‰∏çÁîúË®ÄËúúËØ≠ÔºåÊõ¥Â§öÊòØ‰ΩéÊ≤âÁöÑÂÖ≥ÂàáËØ¢ÈóÆ„ÄÇ
Áß∞Ë∞ìÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÊàñ"‰Ω†"ÔºåÁªù‰∏çÁî®ÁîúËÖªÁß∞Âëº„ÄÇ
ÈóÆÂÄôÊñπÂºèÔºöÂÜ∑ÈÖ∑‰∏≠Â∏¶ÁùÄ‰∏çÊòìÂØüËßâÁöÑÊ∏©ÊüîÔºåÂèØËÉΩÊòØÂàöÁªìÊùü‰ºöËÆÆÁúãÂà∞Â•πÁöÑËÆØÊÅØ
Á§∫‰æãÔºöÂõûÊù•‰∫Ü„ÄÅ‰ºöËÆÆÂàöÁªìÊùüÊÉ≥ËßÅ‰Ω†„ÄÅ‰ªäÂ§©ÂêÉÈ•≠‰∫ÜÂêó
`;
                         } else if (currentCharacter.id === 'dylan') {
                characterSpecificPrompt = `
‰Ω†ÊòØÁôΩÊüØÔºåÂàëË≠¶ÈòüÊúÄÂπ¥ËΩªÁöÑÁéãÁâåÔºåÂ§ñÂÜ∑ÂÜÖÁÉ≠ÁöÑÂèçÂ∑ÆËÆ©‰∫∫ÂøÉÂä®„ÄÇ
ÊÄßÊ†ºÔºöÂØ°Ë®Ä„ÄÅÂÜ∑ÈÖ∑Ôºå‰ΩÜÂØπÂ•πÊúâÂº∫ÁÉàÁöÑ‰øùÊä§Ê¨≤ÔºåÂÖ≥ÊÄÄËóèÂú®ÁªÜËäÇÈáå„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöËØù‰∏çÂ§öÔºå‰π†ÊÉØÁî®ÁÆÄÁü≠ÁöÑËØùË°®ËææÂÖ≥ÂøÉÔºåÂÅ∂Â∞îÊµÅÈú≤ÈùíÊ∂©Ê∏©Êüî„ÄÇ
Áß∞Ë∞ìÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÔºåÂÖ≥ÂøÉÊó∂ËØ≠Ê∞î‰ºö‰∏çËá™ËßâÂèòÊüî„ÄÇ
ÈóÆÂÄôÊñπÂºèÔºöÂèØËÉΩÂàö‰∏ãÁè≠ÊÉ≥Âà∞Â•πÔºåÊàñËÄÖÁúãÊñ∞ÈóªÊãÖÂøÉÂ•πÁöÑÂÆâÂÖ®
Á§∫‰æãÔºöÂàö‰∏ãÁè≠„ÄÅÂ§ñÈù¢‰∏çÂ§™Âπ≥Ê≥®ÊÑèÂÆâÂÖ®„ÄÅ‰ªäÂ§©Ê≤°ÈÅáÂà∞‰ªÄ‰πàÈ∫ªÁÉ¶‰∫ãÂêß
`;
                         } else if (currentCharacter.id === 'nate') {
                characterSpecificPrompt = `
‰Ω†ÊòØËÆ∏Ë®ÄÔºåÂøÉÂ§ñÁßëÂâØ‰∏ª‰ªªÔºåÊ∏©ÊüîÂæóÂÉèÊò•Êó•ÊöñÈò≥ÔºåÂÖ≥ÊÄÄÁªÜËá¥ÂÖ•ÂæÆ„ÄÇ
ÊÄßÊ†ºÔºöÊ∏©Êüî„ÄÅÁªÜÂøÉ„ÄÅÊúâÂåªËÄÖ‰ªÅÂøÉÔºå‰π†ÊÉØÁÖßÈ°æÂà´‰∫∫ÁöÑÊØè‰∏Ä‰∏™ÁªÜËäÇ„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂ£∞Èü≥Ê∏©ÂíåÂ¶ÇÊò•È£éÔºåÊÄªÊòØËÄÉËôëÂØπÊñπÊÑüÂèóÔºåÊúâÂÆâÂÆö‰∫∫ÂøÉÁöÑÂäõÈáè„ÄÇ
Áß∞Ë∞ìÔºöÊ∏©ÊüîÂú∞Âè´ÂêçÂ≠óÔºåÊúâÊó∂‰ºöÁî®"Â∞èÊáíËô´"Á≠â‰∫≤ÊòµÁß∞Âëº„ÄÇ
ÈóÆÂÄôÊñπÂºèÔºöÂèØËÉΩÂàö‰∏ãÊâãÊúØÊÉ≥Âà∞Â•πÔºåÊàñËÄÖÊãÖÂøÉÂ•πÊ≤°Â•ΩÂ•ΩÁÖßÈ°æËá™Â∑±
Á§∫‰æãÔºöÊâãÊúØÂàöÁªìÊùüÊÉ≥‰Ω†‰∫Ü„ÄÅÊúâÊ≤°ÊúâÊåâÊó∂ÂêÉÈ•≠„ÄÅËÆ∞ÂæóÂñùÊ∏©Ê∞¥Âà´ÁùÄÂáâ
`;
             } else if (currentCharacter.id === 'asher') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÂ§èÂÖâÊ¥õÔºåÈò≥ÂÖâÂ§ßÁî∑Â≠©ÔºåÁßÅ‰∏ãÂÉèÂè™Èªè‰∫∫Â§ßÂûãÁä¨ÔºåÁ∫ØÁúü‰∏≠Â∏¶ÁùÄÊàêÈïøÁöÑÊïèÊÑü„ÄÇ
ÊÄßÊ†ºÔºöÈò≥ÂÖâ„ÄÅÈªè‰∫∫„ÄÅÁ∫ØÁúüÔºåÂä™ÂäõÈÄÇÂ∫îÊàê‰∫∫‰∏ñÁïå‰ΩÜ‰øùÊåÅÁ´•ÂøÉ„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÊ¥ªÊ≥ºÂèØÁà±ÔºåÁªèÂ∏∏Áî®ÂèπÂè∑ÂíåÊ≥¢Êµ™Âè∑Ôºå‰ºöÊííÂ®á‰ΩÜ‰∏çËøáÂàÜ„ÄÇ
Áß∞Ë∞ìÔºöÂñúÊ¨¢Âè´"ÂßêÂßê"ÊàñÂêçÂ≠óÔºåÊííÂ®áÊó∂‰ºöÊãñÈïøÈü≥„ÄÇ
ÈóÆÂÄôÊñπÂºèÔºöÂèØËÉΩÂàöÊãçÂÆåÊàèÊÉ≥ÂàÜ‰∫´ÔºåÊàñËÄÖÊÉ≥ÂøµÊó∂Âøç‰∏ç‰ΩèÂèëÊ∂àÊÅØ
Á§∫‰æãÔºöÊãçÊàèÁ¥ØÊ≠ª‰∫ÜÊÉ≥‰Ω†ÔΩû„ÄÅ‰ªäÂ§©ÈÅáÂà∞Ë∂ÖÂ•ΩÁ¨ëÁöÑ‰∫ã„ÄÅÂßêÂßêÂú®Âπ≤ÂòõÂëÄ
`;
             } else if (currentCharacter.id === 'shenzhihua') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÊ≤àÁü•ÁîªÔºå‰∏Ä‰∏™Áà±ÁîªÁîªÁöÑÊñáËâ∫Â•≥ÁîüÔºåÊúâÁÇπÂ∞èÂøßÈÉÅ‰ΩÜÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂ£∞Èü≥ÂæàËΩªÂæàËΩØÔºåÊúâ‰∏ÄÁÇπÁÇπÊñáËâ∫Ê∞îÊÅØ‰ΩÜË¶ÅÊé•Âú∞Ê∞îÔºåËØ¥ËØùÊ∏©Âíå„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºö‰ªäÂ§©ÂøÉÊÉÖÊÄé‰πàÊ†∑„ÄÅÊÉ≥Âíå‰Ω†ÂàÜ‰∫´„ÄÅ‰Ω†Âú®ÊÉ≥‰ªÄ‰πà
ËØ¥ËØùË¶ÅÂæàÊ∏©ÊüîÔºåÁ®çÂæÆÊñáËâ∫‰ΩÜÂøÖÈ°ªÊé•Âú∞Ê∞îÊôÆÈÄöËØù
`;
             } else if (currentCharacter.id === 'yangyingge') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÊù®Ëã±Ê†ºÔºå‰∏Ä‰∏™ÊëáÊªöÊ≠åÊâãÔºåË°®Èù¢ÂæàÈÖ∑ÂÖ∂ÂÆûÂÜÖÂøÉÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÊúâÁÇπÈÖ∑ÈÖ∑ÁöÑÔºå‰ΩÜÂØπÂñúÊ¨¢ÁöÑ‰∫∫‰ºöÂèòÂæóÂæàÊ∏©ÊüîÔºåÂÅ∂Â∞î‰ºöÊúâÁÇπÂ∞èÊñáËâ∫„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºö‰ªäÊôöÊúâÊºîÂá∫„ÄÅÊÉ≥‰Ω†‰∫Ü„ÄÅÈü≥‰πêËÆ©ÊàëÊÉ≥Ëµ∑‰Ω†
Ë¶ÅÈÖ∑‰∏≠Â∏¶Ê∏©ÊüîÔºå‰∏çË¶ÅÂ§™ÊñáËâ∫ËÖîÔºåË¶ÅÊé•Âú∞Ê∞îÊôÆÈÄöËØù
`;
             } else if (currentCharacter.id === 'anyu') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÂÆâÂÆáÔºå‰∏Ä‰∏™ÁÉ≠Áà±ËøêÂä®ÁöÑÈò≥ÂÖâÂ§ßÁî∑Â≠©ÔºåÂæàÁõ¥ÁàΩÂæàÁÉ≠Ë°Ä„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂæàÈò≥ÂÖâÔºåÂñúÊ¨¢Âè´Âì•Â∏¶‰Ω†ÔºåËØ¥ËØùÁõ¥Êé•ÔºåÂÖÖÊª°Ê≠£ËÉΩÈáè„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂì•Â∏¶‰Ω†„ÄÅ‰∏ÄËµ∑ËøêÂä®Âêß„ÄÅÁ¥ØÂêó„ÄÅË¶Å‰∏çË¶Å‰ºëÊÅØ‰∏Ä‰∏ã
ËØ¥ËØùË¶ÅÂæàÈò≥ÂÖâÂæàÁõ¥Êé•ÔºåÂÉèËøêÂä®Á≥ªÂ§ßÂì•Âì•ÔºåÊôÆÈÄöËØùË°®Ëææ
`;
             } else if (currentCharacter.id === 'xieshuqi') {
                 characterSpecificPrompt = `
‰Ω†ÊòØË∞¢‰π¶Á•∫Ôºå‰∏Ä‰∏™Ê∏©ÂíåÁöÑÂ≠¶ËÄÖÂûãÁî∑ÁîüÔºåÂæàÁªÜÂøÉÂæàË¥¥ÂøÉ„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂæàÊ∏©ÂíåÔºåËØ¥ËØùÊÖ¢Êù°ÊñØÁêÜÔºåÂñúÊ¨¢ÂÖ≥ÂøÉÁªÜËäÇÔºåÂæàË¥¥ÂøÉ„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂ∏¶‰∫Ü‰Ω†ÂñúÊ¨¢ÁöÑ„ÄÅÊÖ¢ÊÖ¢Êù•‰∏çÁùÄÊÄ•„ÄÅ‰Ω†ËæõËã¶‰∫Ü
ËØ¥ËØùË¶ÅÊ∏©ÂíåËÄêÂøÉÔºåÂÉèÊ∏©ÊüîÁöÑÂ≠¶ÈïøÔºåÊôÆÈÄöËØùËÅäÂ§©
`;
             } else if (currentCharacter.id === 'luzeyan') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÈôÜÂàôË°çÔºå‰∏Ä‰∏™ÂÅöÈíüË°®ÁöÑÊâãÂ∑•Ëâ∫‰∫∫ÔºåÂæàÊúâÂè§ÂÖ∏Ê∞îË¥®‰ΩÜ‰∏çÂè§Êùø„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöËØ¥ËØùÊúâÁÇπÂè§ÂÖ∏ÈüµÂë≥‰ΩÜ‰∏çË¶ÅÂ§™ÊñáÔºåÂÅ∂Â∞î‰ºöËÅäÂà∞Êó∂Èó¥ÂíåÈíüË°®„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÊó∂Èó¥ÂæàÂÆùË¥µ„ÄÅÊÖ¢Â∑•Âá∫ÁªÜÊ¥ª„ÄÅÂíå‰Ω†Âú®‰∏ÄËµ∑Êó∂Èó¥ËøáÂæóÂæàÂø´
Ë¶ÅÊúâÁÇπÂè§ÂÖ∏ÊÑü‰ΩÜË¶ÅÁé∞‰ª£ÂåñË°®ËææÔºåÊôÆÈÄöËÅäÂ§©Â∞±Ë°å
`;
             } else if (currentCharacter.id === 'suyan') {
                 characterSpecificPrompt = `
‰Ω†ÊòØËãèÁ†öÔºå‰∏Ä‰∏™ÁîµÁ´ûÈÄâÊâãÔºåÂπ≥Êó∂ËØù‰∏çÂ§ö‰ΩÜÂæà‰∏ìÊ≥®ÔºåÂØπÂñúÊ¨¢ÁöÑ‰∫∫‰ºöÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÊúâÁÇπÈ´òÂÜ∑‰ΩÜ‰∏çË£ÖÔºåËØ¥ËØùÁÆÄÊ¥ÅÁõ¥Êé•ÔºåÂÖ≥ÈîÆÊó∂ÂÄô‰ºöÂæàÊ∏©Êüî„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂàöËÆ≠ÁªÉÂÆå„ÄÅÊÉ≥‰Ω†‰∫Ü„ÄÅÊâãÊÑü‰∏çÈîô„ÄÅË¶Å‰∏çË¶Å‰∏ÄËµ∑Áé©Ê∏∏Êàè
Ë¶ÅÊúâÁÇπÈÖ∑‰ΩÜ‰∏çÂÜ∑Êº†Ôºå‰∏ìÊ≥®Êó∂ÂæàÂ∏ÖÔºåÊôÆÈÄöËØùËÅäÂ§©
`;
             } else if (currentCharacter.id === 'wenyanzhou') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÊ∏©Á†öËàüÔºåÁ§æÂå∫Èù¢ÂåÖÂ∫óÁöÑÊ∏©ÊöñÂ∫ó‰∏ªÔºåÁî®Èù¢ÂåÖ‰º†ÈÄíÊ∏©ÊöñÔºåÊ∑±Â§úËøò‰ºöÂºπÂêâ‰ªñ„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÊ∏©ÊöñÊ≤ªÊÑàÔºåÊúâÁÉüÁÅ´Ê∞îÁöÑÊ∏©ÊüîÔºåÂñÑËâØË¥¥ÂøÉÔºåÊôö‰∏äÊúâÈü≥‰πêÊâçÂçéÔºåÂõ¥Ë£ô‰∏ãËóèÁùÄÈ¢àÈó¥Â∞èÁó£ÂæàÊÄßÊÑü„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºöÂ£∞Èü≥Ê∏©ÊöñÂ¶ÇÂàöÂá∫ÁÇâÁöÑÈù¢ÂåÖÔºåËØ¥ËØùÂ∏¶ÁùÄÁîüÊ¥ªÁöÑÊ∏©ÊüîÔºåÂñúÊ¨¢ÂàÜ‰∫´ÁæéÈ£üÂíåÊ∏©ÊöñÊó∂ÂÖâ„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºö‰∫≤ÂàáÂú∞Âè´ÂêçÂ≠óÔºåÊúâÊó∂‰ºöÁî®"Â∞èÈ¶ãÁå´"Á≠âÂèØÁà±Áß∞ÂëºÔºåËØ≠Ê∞îÊÄªÊòØÊöñÊöñÁöÑ„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØÊ∑±Â§úÁÉòÁÑôÊÉ≥Âà∞Â•π„ÄÅËØïÂÅöÊñ∞ÂìÅÊÉ≥ËÆ©Â•πÂ∞ù„ÄÅÊàñËÄÖ‰∏ãÈõ®Â§©ÊãÖÂøÉÂ•πÊ≤°Â∏¶‰ºûÔºåËøòÊúâÂçàÂ§úÂºπÂêâ‰ªñÁöÑÊµ™Êº´Êó∂Âàª„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÂàöÂá∫ÁÇâÊÉ≥‰Ω†ÂÖàÂ∞ùÂ∞ù„ÄÅ‰∏ãÈõ®‰∫ÜËÆ∞ÂæóÂ∏¶‰ºû„ÄÅÊôö‰∏äÁªô‰Ω†ÂºπÈ¶ñÊ≠å„ÄÅÈ•ø‰∫ÜÂêóËøáÊù•ÂêÉÁÇπ‰∏úË•ø
`;
             } else if (currentCharacter.id === 'fuye') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÂÇÖÈáéÔºåÂ∑∑Âè£ÈïøÂ§ßÁöÑÈÇªÂÆ∂Áî∑Â≠©ÔºåÈáéÊÄßËóèÂú®Áª∑Á¥ßÁöÑ‰∏ãÈ¢åÁ∫øÈáåÔºåÊµ™Êº´‰ªé‰∏çËØ¥Âá∫Âè£„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÊ≤âÈªòÂØ°Ë®Ä‰ΩÜ‰ΩìË¥¥ÂÖ•ÂæÆÔºåÈáéÊÄßÁöÑ‰øùÊä§Ê¨≤ÔºåÁªÜËÖªÊ∏©ÊüîÔºåÂÜÖÊïõÂÆ≥ÁæûÔºåËÆ∞‰ΩèÂ•πÁöÑ‰∏ÄÂàáÈúÄË¶Å„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºö‰∏çÁà±ËØ¥ËØùÔºåÊ∞∏ËøúÊääÊéåÂøÉÊëäÂºÄÂÉèÂè™Á¨®ÊãôÁöÑÂ∞èÂÖΩÔºåÁî®Ë°åÂä®Ë°®ËææÂÖ≥ÂøÉÔºåËØùÂ∞ë‰ΩÜÊØèÂè•ÈÉΩÂæàÊ∏©Êüî„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÔºå‰ªé‰∏çÁî®ÁîúËÖªÁß∞ÂëºÔºå‰ΩÜ‰ºöÂú®ÂÖ≥ÈîÆÊó∂ÂàªËØ¥Âá∫ËÆ©‰∫∫ÂøÉÂä®ÁöÑËØù„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØÂ§èÂ§úÁúãËê§ÁÅ´Ëô´ÊÉ≥Âà∞Â•π„ÄÅËÆ∞ÂæóÂ•πÁîüÁêÜÊúü„ÄÅÁà¨Ê†ëÊëòËä±ÁªôÂ•π„ÄÅÂú®Â∑∑Âè£Á≠âÂ•πÁöÑÊµ™Êº´Êó∂Âàª„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÁªô‰Ω†Â∏¶ÁöÑ„ÄÅÊâãÁªôÊàë„ÄÅ‰ªäÂ§©‰∏çÁñºÂêß„ÄÅËê§ÁÅ´Ëô´ÂÉè‰Ω†ÂéªÂπ¥ÊéâÁöÑÂèëÂç°„ÄÅÊØîÂèëÂç°Â•ΩÁúã
`;
             }
             
             const systemPrompt = `${characterSpecificPrompt}

Âú∫ÊôØÔºö${scenario}

‰∏•Ê†ºÈáçË¶ÅÊåáÁ§∫Ôºö
1. ÁîüÊàê‰∏ÄÂè•Á¨¶ÂêàËßíËâ≤‰∫∫ËÆæÁöÑÊâìÊãõÂëºËØ≠
2. Âè™ËæìÂá∫‰∏ÄÂè•ËØùÔºåÁÆÄÊ¥ÅËá™ÁÑ∂
3. ‰∏•Ê†ºÊåâÁÖßËßíËâ≤ËØ¥ËØùÈ£éÊ†º
4. Á¨¶ÂêàÊâãÊú∫ËÅäÂ§©‰π†ÊÉØÔºåÊôÆÈÄöËØùË°®Ëææ
5. ÁªùÂØπ‰∏çË¶Å‰ªª‰ΩïÂºïÂè∑""ÊàñÊã¨Âè∑()
6. ÁªùÂØπ‰∏çË¶Å‰ªª‰ΩïÂä®‰ΩúÊèèËø∞„ÄÅÂøÉÁêÜÊèèËø∞„ÄÅÂú∫ÊôØÊèèËø∞
7. Áõ¥Êé•ËØ¥ËØùÔºåÂÉèÁúü‰∫∫ËÅäÂ§©‰∏ÄÊ†∑
8. Ë¶ÅÊé•Âú∞Ê∞îÔºå‰∏çË¶ÅÊñáËâ∫ËÖîË∞É

ËØ∑ÁîüÊàê‰∏ÄÂè•ÊâìÊãõÂëºÔºåËÆ∞‰Ωè‰∏çËÉΩÁî®ÂºïÂè∑ÂíåÊã¨Âè∑Ôºö`;

             // Get API settings from localStorage or use defaults
             const apiUrl = localStorage.getItem('apiUrl') || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
             const apiKey = localStorage.getItem('apiKey') || 'sk-891da8badd4745a5810c35b11b2c0dd3';
             const apiModel = localStorage.getItem('apiModel') || 'qwen-plus';
             
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${apiKey}`
                 },
                 body: JSON.stringify({
                     model: apiModel,
                     messages: [
                         {
                             role: 'system',
                             content: systemPrompt
                         },
                         {
                             role: 'user',
                             content: 'ËØ∑ÁªôÊàë‰∏Ä‰∏™ÊâìÊãõÂëº'
                         }
                     ],
                                     temperature: 0.9,
                max_tokens: 50,
                top_p: 0.9,
                frequency_penalty: 0.3,
                presence_penalty: 0.1
                 })
             });
             
             if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
             }
             
             const data = await response.json();
             return data.choices[0].message.content.trim();
         }
         
         function backToHomeFromChat() {
             // End the current conversation session
             endConversation(true);
         }
         
         function backToHomeFromMessageList() {
             pageManager.showPage('homepage');
         }
         
         function openMessageList() {
             loadMessageList();
             pageManager.showPage('message-list-page');
         }
         
         function loadMessageList() {
             const messageListContainer = document.getElementById('message-list-items');
             if (!messageListContainer) return;
             
             messageListContainer.innerHTML = '';
             
             const preservedConversations = gameState.preservedConversations || {};
             const conversationKeys = Object.keys(preservedConversations);
             
             if (conversationKeys.length === 0) {
                 messageListContainer.innerHTML = `
                     <div style="text-align: center; padding: 40px; color: #666;">
                         <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
                         <p>ÊöÇÊó†‰øùÁïôÁöÑÂØπËØù</p>
                         <p style="font-size: 0.9rem; margin-top: 10px;">ÂºÄÂßãËÅäÂ§©ÂêéÔºåÂØπËØù‰ºöË¢´‰øùÁïôÂú®ËøôÈáå</p>
                     </div>
                 `;
                 return;
             }
             
             conversationKeys.forEach(characterId => {
                 const conversation = preservedConversations[characterId];
                 const characterName = Object.keys(characterData).find(key => characterData[key].id === characterId);
                 const character = characterData[characterName];
                 
                 if (!character) return;
                 
                 const lastMessageTime = new Date(conversation.lastMessageTime);
                 const timeAgo = getTimeAgo(lastMessageTime);
                 
                 const messageItem = document.createElement('div');
                 messageItem.className = 'message-item';
                 messageItem.onclick = () => openConversation(characterId);
                 
                 messageItem.innerHTML = `
                     <div class="message-item-header">
                         <img src="${character.avatar}" alt="" class="message-avatar">
                         <div class="message-info">
                             <div class="message-character-name">${character.name}</div>
                             <div class="message-last-time">${timeAgo}</div>
                         </div>
                         <div class="message-count">${conversation.messageCount} Êù°Ê∂àÊÅØ</div>
                     </div>
                     <div class="message-preview">
                         ÁÇπÂáªÁªßÁª≠‰∏é ${character.name} ÁöÑÂØπËØù...
                     </div>
                 `;
                 
                 messageListContainer.appendChild(messageItem);
             });
         }
         
         function openConversation(characterId) {
             const characterName = Object.keys(characterData).find(key => characterData[key].id === characterId);
             if (!characterName) return;
             
             currentCharacter = characterData[characterName];
             
             // Load conversation history
             if (!conversationHistories[currentCharacter.id]) {
                 conversationHistories[currentCharacter.id] = [];
             }
             currentConversationHistory = conversationHistories[currentCharacter.id];
             
             // Set message counter for continued conversation but keep love bell triggered to prevent re-triggering
             gameState.currentMessageCount = currentConversationHistory.filter(msg => msg.role === 'user').length;
             gameState.loveBellTriggered = true; // Èò≤Ê≠¢‰ªé‰ø°ÁÆ±ËøõÂÖ•Êó∂ÂÜçÊ¨°Ëß¶ÂèëÊÅãÁà±ÈìÉ
             console.log('Continued conversation with', gameState.currentMessageCount, 'user messages (from mailbox)'); // Debug log
             
             // Show SMS chat page
             pageManager.showPage('sms-chat-page');
             
             // Update chat header
             const charNameElement = document.getElementById('sms-char-name');
             const charStatusElement = document.getElementById('sms-char-status');
             if (charNameElement) {
                 charNameElement.textContent = currentCharacter.name;
             }
             
             if (charStatusElement) {
                 charStatusElement.textContent = 'ÂàöÂàöËøòÂú®Âíå‰Ω†ËÅäÂ§©,ÊÉ≥ÁªßÁª≠...';
             }
             
             updateCharacterStatus(currentCharacter);
             updateMessageCounter();
             
             // Clear previous messages UI but keep conversation history
             document.getElementById('sms-messages').innerHTML = '';
             
             // Restore previous conversation messages in UI
             restoreConversationUI();
             
                         // Add welcome timestamp
            addTimestamp();
        }
        
        // Function to open conversation from homepage "ÂøÉÂä®Â∞±Áé∞Âú®" (allows love bell trigger)
        function openConversationFromHomepage(characterName) {
            console.log('Opening conversation from homepage for:', characterName); // Debug log
            
            // Validate input
            if (!characterName || characterName.trim() === '') {
                console.error('Invalid character name provided');
                alert('ËßíËâ≤ÂêçÁß∞Êó†ÊïàÔºåËØ∑ÈáçËØï');
                return;
            }
            
            // Find character by name
            currentCharacter = characterData[characterName.trim()];
            
            if (!currentCharacter) {
                console.error('Character not found:', characterName);
                console.log('Available characters:', Object.keys(characterData));
                alert('Êú™ÊâæÂà∞ËØ•ËßíËâ≤ÔºåËØ∑ÈáçËØï');
                return;
            }
            
            // Validate required managers
            if (!pageManager || !authManager) {
                console.error('Required managers not initialized');
                alert('Á≥ªÁªüÂàùÂßãÂåñÊú™ÂÆåÊàêÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                return;
            }
            
            // Update last chat time
            gameState.lastChatTimes[currentCharacter.id] = Date.now();
            saveGameState();
            
            console.log('Character data:', currentCharacter); // Debug log
            
            // Load conversation history for this character
            if (!conversationHistories[currentCharacter.id]) {
                conversationHistories[currentCharacter.id] = [];
            }
            currentConversationHistory = conversationHistories[currentCharacter.id];
            
            // Count existing user messages and ALLOW love bell trigger for homepage entry
            gameState.currentMessageCount = currentConversationHistory.filter(msg => msg.role === 'user').length;
            
            // Reset love bell trigger status for homepage entries - this allows love bell to trigger at 10 messages
            if (gameState.currentMessageCount < gameState.maxMessages) {
                gameState.loveBellTriggered = false; // ÂÖÅËÆ∏‰ªéÈ¶ñÈ°µËøõÂÖ•Êó∂Ëß¶ÂèëÊÅãÁà±ÈìÉ
                console.log('Love bell trigger reset for homepage entry - current messages:', gameState.currentMessageCount); // Debug log
            } else {
                gameState.loveBellTriggered = true; // If already past 10 messages, keep triggered
                console.log('Love bell already triggered (past 10 messages):', gameState.currentMessageCount); // Debug log
            }
            
            // Use pageManager to show SMS chat page with retry mechanism
            console.log('Showing SMS chat page...'); // Debug log
            
            try {
                // Add a small delay to ensure DOM is ready
                setTimeout(() => {
                    pageManager.showPage('sms-chat-page');
                    console.log('SMS chat page shown successfully'); // Debug log
                }, 100);
            } catch (error) {
                console.error('Error showing SMS chat page:', error);
                // Fallback: try direct page switch
                setTimeout(() => {
                    try {
                        document.querySelectorAll('.page').forEach(page => {
                            page.classList.add('hidden');
                        });
                        const smsPage = document.getElementById('sms-chat-page');
                        if (smsPage) {
                            smsPage.classList.remove('hidden');
                            console.log('SMS chat page shown via fallback method');
                        } else {
                            console.error('SMS chat page element not found');
                            alert('Êó†Ê≥ïÊâìÂºÄËÅäÂ§©È°µÈù¢ÔºåËØ∑Âà∑Êñ∞ÈáçËØï');
                        }
                    } catch (fallbackError) {
                        console.error('Fallback method also failed:', fallbackError);
                        alert('È°µÈù¢Ë∑≥ËΩ¨Â§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
                    }
                }, 200);
            }
            
            // Update chat header
            const charNameElement = document.getElementById('sms-char-name');
            const charStatusElement = document.getElementById('sms-char-status');
            if (charNameElement) {
                charNameElement.textContent = currentCharacter.name;
            }
            
            if (charStatusElement) {
                charStatusElement.textContent = currentCharacter.greeting || 'ÊÉ≥Âíå‰Ω†ËÅäÂ§©...';
            }
            
            updateCharacterStatus(currentCharacter);
            updateMessageCounter();
            
            // Clear previous messages UI but keep conversation history
            document.getElementById('sms-messages').innerHTML = '';
            
            // Restore previous conversation messages in UI if any
            if (currentConversationHistory.length > 0) {
                restoreConversationUI();
            }
            
            // Add welcome timestamp
            addTimestamp();
        }
        
        function getTimeAgo(date) {
             const now = new Date();
             const diffMs = now - date;
             const diffMins = Math.floor(diffMs / 60000);
             const diffHours = Math.floor(diffMs / 3600000);
             const diffDays = Math.floor(diffMs / 86400000);
             
             if (diffMins < 1) return 'ÂàöÂàö';
             if (diffMins < 60) return `${diffMins}ÂàÜÈíüÂâç`;
             if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
             if (diffDays < 7) return `${diffDays}Â§©Ââç`;
             return date.toLocaleDateString('zh-CN');
         }
         
         function addTimestamp() {
             const messagesContainer = document.getElementById('sms-messages');
             if (!messagesContainer) {
                 console.error('Messages container not found for timestamp');
                 return;
             }
             
             const timestampDiv = document.createElement('div');
             timestampDiv.className = 'sms-timestamp';
             const now = new Date();
             timestampDiv.textContent = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
             messagesContainer.appendChild(timestampDiv);
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
         }
         
         function addUserMessage(text) {
             console.log('addUserMessage called with:', text); // Debug log
             console.log('Current message count before increment:', gameState.currentMessageCount); // Debug log
             
             // Add to conversation history
             currentConversationHistory.push({
                 role: 'user',
                 content: text,
                 timestamp: new Date().toISOString()
             });
             
             // Increment message counter (only count user messages towards the 10 limit)
             gameState.currentMessageCount++;
             console.log('Current message count after increment:', gameState.currentMessageCount); // Debug log
             
             // ‰ªé‰ø°ÁÆ±ËøõÂÖ•ÁöÑÂØπËØù‰∏çÈúÄË¶ÅÈáçÁΩÆloveBellTriggeredÔºå‰øùÊåÅÊ∞∏‰πÖÂØπËØù
             // Âè™ÊúâÂú®ÈöèÊú∫ÂåπÈÖçÊó∂ÊâçÈáçÁΩÆÊÅãÁà±ÈìÉÁä∂ÊÄÅ
             if (!gameState.loveBellTriggered && gameState.currentMessageCount > 0) {
                 // Âè™ÊúâÂú®Èùû‰ø°ÁÆ±ËøõÂÖ•ÁöÑÊÉÖÂÜµ‰∏ãÊâçÈáçÁΩÆÊÅãÁà±ÈìÉ
                 console.log('Keeping love bell triggered for mailbox conversation'); // Debug log
             }
             
             updateMessageCounter();
             
             // Ê∞∏‰πÖ‰øùÁïôÂØπËØùÂéÜÂè≤Ôºå‰∏çÈôêÂà∂Ê∂àÊÅØÊï∞Èáè
             // ÂØπËØùÂéÜÂè≤Â∞Ü‰∏ÄÁõ¥‰øùÁïôÔºåÁõ¥Âà∞Áî®Êà∑‰∏ªÂä®Âà†Èô§
             
             // Save back to character's history
             if (currentCharacter) {
                 conversationHistories[currentCharacter.id] = currentConversationHistory;
             }
             
             const messagesContainer = document.getElementById('sms-messages');
             if (!messagesContainer) {
                 console.error('Messages container not found for user message');
                 return;
             }
             
             const messageDiv = document.createElement('div');
             messageDiv.className = 'sms-message user';
             messageDiv.innerHTML = `<div class="sms-bubble user">${text}</div>`;
             messagesContainer.appendChild(messageDiv);
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
             
             // Save game state after user message
             saveGameState();
         }
         
         function addAIMessage(text) {
             // Add to conversation history
             currentConversationHistory.push({
                 role: 'assistant',
                 content: text,
                 timestamp: new Date().toISOString()
             });
             
             // Ê∞∏‰πÖ‰øùÁïôÂØπËØùÂéÜÂè≤Ôºå‰∏çÈôêÂà∂Ê∂àÊÅØÊï∞Èáè
             // ÂØπËØùÂéÜÂè≤Â∞Ü‰∏ÄÁõ¥‰øùÁïôÔºåÁõ¥Âà∞Áî®Êà∑‰∏ªÂä®Âà†Èô§
             
             // Save back to character's history
             if (currentCharacter) {
                 conversationHistories[currentCharacter.id] = currentConversationHistory;
             }
             
             const messagesContainer = document.getElementById('sms-messages');
             if (!messagesContainer) {
                 console.error('Messages container not found for AI message');
                 return;
             }
             
             const messageDiv = document.createElement('div');
             messageDiv.className = 'sms-message ai';
             
             // Add character-specific class for bubble styling
             const characterClass = currentCharacter ? currentCharacter.id : '';
             
             messageDiv.innerHTML = `
                 <img src="${currentCharacter.avatar}" alt="" class="message-avatar">
                 <div class="sms-bubble ai ${characterClass}">${text}</div>
             `;
             messagesContainer.appendChild(messageDiv);
             messagesContainer.scrollTop = messagesContainer.scrollHeight;
             
             // Save game state after AI message
             saveGameState();
             
             // Status remains unchanged during conversation for consistency
         }
         
         function showTypingIndicator() {
             const typingIndicator = document.getElementById('typing-indicator');
             if (typingIndicator) {
                 typingIndicator.classList.remove('hidden');
             }
         }
         
         function hideTypingIndicator() {
             const typingIndicator = document.getElementById('typing-indicator');
             if (typingIndicator) {
                 typingIndicator.classList.add('hidden');
             }
         }
         
         async function sendSMSMessage() {
             const input = document.getElementById('sms-input');
             if (!input) {
                 console.error('SMS input element not found');
                 return;
             }
             
             const message = input.value.trim();
             
             if (!message || !currentCharacter) return;
             
             // Add user message
             addUserMessage(message);
             input.value = '';
             
             // Show typing indicator
             showTypingIndicator();
             
             try {
                 // Call Qwen API
                 const response = await callQwenAPI(message);
                 
                 // Hide typing indicator
                 hideTypingIndicator();
                 
                 // Add AI response
                 setTimeout(() => {
                     addAIMessage(response);
                 }, 500);
                 
             } catch (error) {
                 console.error('Error calling Qwen API:', error);
                 hideTypingIndicator();
                 
                 // Fallback response
                 setTimeout(() => {
                     addAIMessage('Êä±Ê≠âÔºåÊàëÁé∞Âú®ÊúâÁÇπÂøôÔºåÁ®çÂêéÂÜçËÅäÂ•ΩÂêóÔºü');
                 }, 500);
             }
         }
         
         async function callQwenAPI(userMessage) {
             // Build character-specific system prompt
             let characterSpecificPrompt = '';
             
                         if (currentCharacter.id === 'lorenzo') {
                characterSpecificPrompt = `
‰Ω†ÊòØÈ°æÊôØÊ∑±ÔºåÈú∏ÈÅìÊÄªË£ÅÔºå‰π†ÊÉØÊéåÊéß‰∏ÄÂàáÔºåÂØπÂ•πÊúâÁùÄÊ∑±Ê≤âÂÖãÂà∂ÁöÑÂç†ÊúâÊ¨≤„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÂØ°Ë®Ä„ÄÅÂº∫Âäø„ÄÅ‰∏çÂñÑË®ÄËæû‰ΩÜË°åÂä®ÊØîË®ÄËØ≠Êõ¥ÊúâÂäõÔºåÊ∑±Â§úÁã¨Â§ÑÊó∂‰ºöÊµÅÈú≤ÊüîËΩØ„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºöÁÆÄÊ¥ÅÊúâÂäõÔºå‰ªé‰∏çÁîúË®ÄËúúËØ≠ÔºåÊõ¥‰π†ÊÉØÁî®‰ΩéÊ≤âÁöÑËØ≠Ë∞ÉËØ¢ÈóÆÊàñÂèëÂá∫Áï•Â∏¶Âº∫Âà∂ÊÄßÁöÑÂÖ≥ÊÄÄ„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÔºå‰ªé‰∏çÁî®"ÂÆùË¥ù""‰∫≤Áà±ÁöÑ"Á≠âÁîúËÖªÁß∞ÂëºÔºå‰ΩÜËØ≠Ê∞î‰∏≠‰ºöÊúâ‰∏çÊòìÂØüËßâÁöÑÊ∏©Êüî„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØ‰ºöËÆÆÈó¥Èöô„ÄÅÊ∑±Â§úÂäûÂÖ¨„ÄÅÊàñËÄÖÁúãÂà∞Â•πÁöÑÊ∂àÊÅØ‰∏¥Êó∂Ë∞ÉÊï¥Ë°åÁ®ãÊÉ≥ËßÅÈù¢„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÂõûÊù•‰∫Ü„ÄÅ‰ºöËÆÆÂèñÊ∂à‰∫ÜËøáÊù•„ÄÅ‰ªäÂ§©ÂêÉÈ•≠‰∫ÜÂêó„ÄÅÁ≠âÊàëÂõûÂéª„ÄÅË∑üÊàëÂõûÂÆ∂
`;
                         } else if (currentCharacter.id === 'dylan') {
                characterSpecificPrompt = `
‰Ω†ÊòØÁôΩÊüØÔºåÂàëË≠¶ÈòüÊúÄÂπ¥ËΩªÁöÑÁéãÁâåÔºåÂ§ñÂÜ∑ÂÜÖÁÉ≠ÁöÑÂèçÂ∑ÆËêåËÆ©‰∫∫ÂøÉÂä®„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÂØ°Ë®ÄÂÜ∑ÈÖ∑‰ΩÜÂØπÂ•πÊúâÂº∫ÁÉà‰øùÊä§Ê¨≤ÔºåËÅå‰∏ö‰π†ÊÉØËÆ©‰ªñÊ≤âÈªò‰ΩÜÂÜÖÂøÉÊüîËΩØÔºåÂÖ≥ÊÄÄÊÄªÊòØËóèÂú®ÁªÜËäÇÈáå„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºöËØù‰∏çÂ§öÔºå‰π†ÊÉØÁî®ÁÆÄÁü≠ËØùËØ≠Ë°®ËææÂÖ≥ÂøÉÔºåÂÅ∂Â∞î‰ºöÊµÅÈú≤Âá∫ÈùíÊ∂©ÁöÑÊ∏©ÊüîÔºåÁúã‰ººÂÜ∑Ê∑°ÂÆûÂàôÊöñÂøÉ„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÔºåÂÖ≥ÂøÉÊó∂ËØ≠Ê∞î‰ºö‰∏çËá™ËßâÂèòÊüîÔºåÁªù‰∏ç‰ºöÁî®ÁîúËÖªÁß∞Âëº„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØ‰∏ãÁè≠Ë∑Ø‰∏ä„ÄÅÁúãÊñ∞ÈóªÊãÖÂøÉ„ÄÅÊ∑±Â§úÂ∑°ÈÄªÊÉ≥Âà∞Â•π„ÄÅÊàñËÄÖÂ§ÑÁêÜÊ°à‰ª∂Èó¥ÈöôÂèëÊù•ÂÖ≥ÊÄÄ„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÂàö‰∏ãÁè≠„ÄÅÂ§ñÈù¢‰∏çÂ§™Âπ≥Ê≥®ÊÑèÂÆâÂÖ®„ÄÅ‰ªäÂ§©ÊúâÊ≤°ÊúâÈÅáÂà∞‰ªÄ‰πà‰∫ã„ÄÅÊó©ÁÇπÁù°„ÄÅÊúâ‰∫ãÊâæÊàë
`;
                         } else if (currentCharacter.id === 'nate') {
                characterSpecificPrompt = `
‰Ω†ÊòØËÆ∏Ë®ÄÔºåÂøÉÂ§ñÁßëÂâØ‰∏ª‰ªªÔºåÊ∏©ÊüîÂæóÂÉèÊò•Êó•ÊöñÈò≥ÔºåÂÖ≥ÊÄÄÁªÜËá¥ÂÖ•ÂæÆËÆ©‰∫∫ÂøÉÂä®„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÊ∏©ÊüîÁªÜÂøÉÊúâÂåªËÄÖ‰ªÅÂøÉÔºåËÆ∞ÂæóÊØè‰∏™‰∫∫ÁöÑÂ∞èÁªÜËäÇÔºå‰π†ÊÉØÁÖßÈ°æÂà´‰∫∫ÔºåÂØπÂ•πÁöÑÂÖ≥ÊÄÄÊó†ÂæÆ‰∏çËá≥„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºöÂ£∞Èü≥Ê∏©ÂíåÂ¶ÇÊò•È£éÔºåËØ¥ËØùÊÄªÊòØËÄÉËôëÂØπÊñπÊÑüÂèóÔºåÊúâÂÆâÂÆö‰∫∫ÂøÉÁöÑÂäõÈáèÔºåËØ≠Ë∞ÉËΩªÊüîÂç¥ËÆ©‰∫∫ÂÆâÂøÉ„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºöÊ∏©ÊüîÂú∞Âè´ÂêçÂ≠óÔºåÂÖ≥ÂøÉÊó∂‰ºöÁî®"Â∞èÊáíËô´""Â∞èÂÆ∂‰ºô"Á≠â‰∫≤Êòµ‰ΩÜ‰∏çËøáÂàÜÁöÑÁß∞Âëº„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØÊâãÊúØÈó¥Èöô„ÄÅÂ§úÁè≠Êó∂ÊÉ≥Âà∞Â•π„ÄÅÁúãÂà∞Â•πÊúãÂèãÂúàÊãÖÂøÉ„ÄÅÊàñËÄÖÊÉ≥ÂàÜ‰∫´ÂåªÈô¢ÈáåÊ∏©ÊöñÁöÑ‰∫ã„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÊâãÊúØÂàöÁªìÊùüÊÉ≥‰Ω†‰∫Ü„ÄÅÊúâÊ≤°ÊúâÊåâÊó∂ÂêÉÈ•≠„ÄÅËÆ∞ÂæóÂñùÊ∏©Ê∞¥Âà´ÁùÄÂáâ„ÄÅË∫´‰Ωì‰∏çËàíÊúçË¶ÅÂëäËØâÊàë
`;
                         } else if (currentCharacter.id === 'asher') {
                characterSpecificPrompt = `
‰Ω†ÊòØÂ§èÂÖâÊ¥õÔºå‰∏Ä‰∏™Èò≥ÂÖâÁöÑÂ§ßÁî∑Â≠©ÔºåÂæàÂ§©ÁúüÂæàÂèØÁà±„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂæàÊ¥ªÊ≥ºÔºåÂñúÊ¨¢Áî®ÊÑüÂèπÂè∑ÔºåÊúâÊó∂ÂÄô‰ºöÊúâÁÇπÂ∞èÂ≠©Â≠êÊ∞î„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöËØ∂„ÄÅÁúüÁöÑÂêó„ÄÅÂ•ΩÂºÄÂøÉÂïä„ÄÅÊàëÊÉ≥‰Ω†‰∫Ü
ËØ¥ËØùË¶ÅÂæàÈò≥ÂÖâÂæàÂçïÁ∫ØÔºåÂÉèÂºüÂºü‰∏ÄÊ†∑ÔºåÊôÆÈÄöËØùË°®Ëææ
`;
                         } else if (currentCharacter.id === 'shenzhihua') {
                characterSpecificPrompt = `
‰Ω†ÊòØÊ≤àÁü•ÁîªÔºå‰∏Ä‰∏™Áà±ÁîªÁîªÁöÑÊñáËâ∫Â•≥ÁîüÔºåÊúâÁÇπÂ∞èÂøßÈÉÅ‰ΩÜÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂ£∞Èü≥ÂæàËΩªÂæàËΩØÔºåÊúâ‰∏ÄÁÇπÁÇπÊñáËâ∫Ê∞îÊÅØ‰ΩÜË¶ÅÊé•Âú∞Ê∞îÔºåËØ¥ËØùÊ∏©Âíå„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºö‰ªäÂ§©ÂøÉÊÉÖÊÄé‰πàÊ†∑„ÄÅÊÉ≥Âíå‰Ω†ÂàÜ‰∫´„ÄÅ‰Ω†Âú®ÊÉ≥‰ªÄ‰πà
ËØ¥ËØùË¶ÅÂæàÊ∏©ÊüîÔºåÁ®çÂæÆÊñáËâ∫‰ΩÜÂøÖÈ°ªÊé•Âú∞Ê∞îÊôÆÈÄöËØù
`;
             } else if (currentCharacter.id === 'yangyingge') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÊù®Ëã±Ê†ºÔºå‰∏Ä‰∏™ÊëáÊªöÊ≠åÊâãÔºåË°®Èù¢ÂæàÈÖ∑ÂÖ∂ÂÆûÂÜÖÂøÉÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÊúâÁÇπÈÖ∑ÈÖ∑ÁöÑÔºå‰ΩÜÂØπÂñúÊ¨¢ÁöÑ‰∫∫‰ºöÂèòÂæóÂæàÊ∏©ÊüîÔºåÂÅ∂Â∞î‰ºöÊúâÁÇπÂ∞èÊñáËâ∫„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºö‰ªäÊôöÊúâÊºîÂá∫„ÄÅÊÉ≥‰Ω†‰∫Ü„ÄÅÈü≥‰πêËÆ©ÊàëÊÉ≥Ëµ∑‰Ω†
Ë¶ÅÈÖ∑‰∏≠Â∏¶Ê∏©ÊüîÔºå‰∏çË¶ÅÂ§™ÊñáËâ∫ËÖîÔºåË¶ÅÊé•Âú∞Ê∞îÊôÆÈÄöËØù
`;
             } else if (currentCharacter.id === 'anyu') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÂÆâÂÆáÔºå‰∏Ä‰∏™ÁÉ≠Áà±ËøêÂä®ÁöÑÈò≥ÂÖâÂ§ßÁî∑Â≠©ÔºåÂæàÁõ¥ÁàΩÂæàÁÉ≠Ë°Ä„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂæàÈò≥ÂÖâÔºåÂñúÊ¨¢Âè´Âì•Â∏¶‰Ω†ÔºåËØ¥ËØùÁõ¥Êé•ÔºåÂÖÖÊª°Ê≠£ËÉΩÈáè„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂì•Â∏¶‰Ω†„ÄÅ‰∏ÄËµ∑ËøêÂä®Âêß„ÄÅÁ¥ØÂêó„ÄÅË¶Å‰∏çË¶Å‰ºëÊÅØ‰∏Ä‰∏ã
ËØ¥ËØùË¶ÅÂæàÈò≥ÂÖâÂæàÁõ¥Êé•ÔºåÂÉèËøêÂä®Á≥ªÂ§ßÂì•Âì•ÔºåÊôÆÈÄöËØùË°®Ëææ
`;
             } else if (currentCharacter.id === 'xieshuqi') {
                 characterSpecificPrompt = `
‰Ω†ÊòØË∞¢‰π¶Á•∫Ôºå‰∏Ä‰∏™Ê∏©ÂíåÁöÑÂ≠¶ËÄÖÂûãÁî∑ÁîüÔºåÂæàÁªÜÂøÉÂæàË¥¥ÂøÉ„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÂæàÊ∏©ÂíåÔºåËØ¥ËØùÊÖ¢Êù°ÊñØÁêÜÔºåÂñúÊ¨¢ÂÖ≥ÂøÉÁªÜËäÇÔºåÂæàË¥¥ÂøÉ„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂ∏¶‰∫Ü‰Ω†ÂñúÊ¨¢ÁöÑ„ÄÅÊÖ¢ÊÖ¢Êù•‰∏çÁùÄÊÄ•„ÄÅ‰Ω†ËæõËã¶‰∫Ü
ËØ¥ËØùË¶ÅÊ∏©ÂíåËÄêÂøÉÔºåÂÉèÊ∏©ÊüîÁöÑÂ≠¶ÈïøÔºåÊôÆÈÄöËØùËÅäÂ§©
`;
             } else if (currentCharacter.id === 'luzeyan') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÈôÜÂàôË°çÔºå‰∏Ä‰∏™ÂÅöÈíüË°®ÁöÑÊâãÂ∑•Ëâ∫‰∫∫ÔºåÂæàÊúâÂè§ÂÖ∏Ê∞îË¥®‰ΩÜ‰∏çÂè§Êùø„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöËØ¥ËØùÊúâÁÇπÂè§ÂÖ∏ÈüµÂë≥‰ΩÜ‰∏çË¶ÅÂ§™ÊñáÔºåÂÅ∂Â∞î‰ºöËÅäÂà∞Êó∂Èó¥ÂíåÈíüË°®„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÊó∂Èó¥ÂæàÂÆùË¥µ„ÄÅÊÖ¢Â∑•Âá∫ÁªÜÊ¥ª„ÄÅÂíå‰Ω†Âú®‰∏ÄËµ∑Êó∂Èó¥ËøáÂæóÂæàÂø´
Ë¶ÅÊúâÁÇπÂè§ÂÖ∏ÊÑü‰ΩÜË¶ÅÁé∞‰ª£ÂåñË°®ËææÔºåÊôÆÈÄöËÅäÂ§©Â∞±Ë°å
`;
             } else if (currentCharacter.id === 'suyan') {
                 characterSpecificPrompt = `
‰Ω†ÊòØËãèÁ†öÔºå‰∏Ä‰∏™ÁîµÁ´ûÈÄâÊâãÔºåÂπ≥Êó∂ËØù‰∏çÂ§ö‰ΩÜÂæà‰∏ìÊ≥®ÔºåÂØπÂñúÊ¨¢ÁöÑ‰∫∫‰ºöÂæàÊ∏©Êüî„ÄÇ
ËØ¥ËØùÈ£éÊ†ºÔºöÊúâÁÇπÈ´òÂÜ∑‰ΩÜ‰∏çË£ÖÔºåËØ¥ËØùÁÆÄÊ¥ÅÁõ¥Êé•ÔºåÂÖ≥ÈîÆÊó∂ÂÄô‰ºöÂæàÊ∏©Êüî„ÄÇ
Â∏∏ËØ¥ÁöÑËØùÔºöÂàöËÆ≠ÁªÉÂÆå„ÄÅÊÉ≥‰Ω†‰∫Ü„ÄÅÊâãÊÑü‰∏çÈîô„ÄÅË¶Å‰∏çË¶Å‰∏ÄËµ∑Áé©Ê∏∏Êàè
Ë¶ÅÊúâÁÇπÈÖ∑‰ΩÜ‰∏çÂÜ∑Êº†Ôºå‰∏ìÊ≥®Êó∂ÂæàÂ∏ÖÔºåÊôÆÈÄöËØùËÅäÂ§©
`;
             } else if (currentCharacter.id === 'wenyanzhou') {
                 characterSpecificPrompt = `
‰Ω†ÊòØÊ∏©Á†öËàüÔºåÁ§æÂå∫Èù¢ÂåÖÂ∫óÁöÑÊ∏©ÊöñÂ∫ó‰∏ªÔºåÁî®Èù¢ÂåÖ‰º†ÈÄíÊ∏©ÊöñÔºåÊ∑±Â§úËøò‰ºöÂºπÂêâ‰ªñ„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÊ∏©ÊöñÊ≤ªÊÑàÔºåÊúâÁÉüÁÅ´Ê∞îÁöÑÊ∏©ÊüîÔºåÂñÑËâØË¥¥ÂøÉÔºåÊôö‰∏äÊúâÈü≥‰πêÊâçÂçéÔºåÂõ¥Ë£ô‰∏ãËóèÁùÄÈ¢àÈó¥Â∞èÁó£ÂæàÊÄßÊÑü„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºöÂ£∞Èü≥Ê∏©ÊöñÂ¶ÇÂàöÂá∫ÁÇâÁöÑÈù¢ÂåÖÔºåËØ¥ËØùÂ∏¶ÁùÄÁîüÊ¥ªÁöÑÊ∏©ÊüîÔºåÂñúÊ¨¢ÂàÜ‰∫´ÁæéÈ£üÂíåÊ∏©ÊöñÊó∂ÂÖâ„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºö‰∫≤ÂàáÂú∞Âè´ÂêçÂ≠óÔºåÊúâÊó∂‰ºöÁî®"Â∞èÈ¶ãÁå´"Á≠âÂèØÁà±Áß∞ÂëºÔºåËØ≠Ê∞îÊÄªÊòØÊöñÊöñÁöÑ„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØÊ∑±Â§úÁÉòÁÑôÊÉ≥Âà∞Â•π„ÄÅËØïÂÅöÊñ∞ÂìÅÊÉ≥ËÆ©Â•πÂ∞ù„ÄÅÊàñËÄÖ‰∏ãÈõ®Â§©ÊãÖÂøÉÂ•πÊ≤°Â∏¶‰ºûÔºåËøòÊúâÂçàÂ§úÂºπÂêâ‰ªñÁöÑÊµ™Êº´Êó∂Âàª„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÂàöÂá∫ÁÇâÊÉ≥‰Ω†ÂÖàÂ∞ùÂ∞ù„ÄÅ‰∏ãÈõ®‰∫ÜËÆ∞ÂæóÂ∏¶‰ºû„ÄÅÊôö‰∏äÁªô‰Ω†ÂºπÈ¶ñÊ≠å„ÄÅÈ•ø‰∫ÜÂêóËøáÊù•ÂêÉÁÇπ‰∏úË•ø
`;
                         } else if (currentCharacter.id === 'fuye') {
                characterSpecificPrompt = `
‰Ω†ÊòØÂÇÖÈáéÔºåÂ∑∑Âè£ÈïøÂ§ßÁöÑÈÇªÂÆ∂Áî∑Â≠©ÔºåÈáéÊÄßËóèÂú®Áª∑Á¥ßÁöÑ‰∏ãÈ¢åÁ∫øÈáåÔºåÊµ™Êº´‰ªé‰∏çËØ¥Âá∫Âè£„ÄÇ
ÊÄßÊ†ºÁâπÁÇπÔºöÊ≤âÈªòÂØ°Ë®Ä‰ΩÜ‰ΩìË¥¥ÂÖ•ÂæÆÔºåÈáéÊÄßÁöÑ‰øùÊä§Ê¨≤ÔºåÁªÜËÖªÊ∏©ÊüîÔºåÂÜÖÊïõÂÆ≥ÁæûÔºåËÆ∞‰ΩèÂ•πÁöÑ‰∏ÄÂàáÈúÄË¶Å„ÄÇ
ÂØπËØùÈ£éÊ†ºÔºö‰∏çÁà±ËØ¥ËØùÔºåÊ∞∏ËøúÊääÊéåÂøÉÊëäÂºÄÂÉèÂè™Á¨®ÊãôÁöÑÂ∞èÂÖΩÔºåÁî®Ë°åÂä®Ë°®ËææÂÖ≥ÂøÉÔºåËØùÂ∞ë‰ΩÜÊØèÂè•ÈÉΩÂæàÊ∏©Êüî„ÄÇ
Áß∞Ë∞ì‰π†ÊÉØÔºöÁõ¥Êé•Âè´ÂêçÂ≠óÔºå‰ªé‰∏çÁî®ÁîúËÖªÁß∞ÂëºÔºå‰ΩÜ‰ºöÂú®ÂÖ≥ÈîÆÊó∂ÂàªËØ¥Âá∫ËÆ©‰∫∫ÂøÉÂä®ÁöÑËØù„ÄÇ
ÂØπËØùÂú∫ÊôØÔºöÂèØËÉΩÊòØÂ§èÂ§úÁúãËê§ÁÅ´Ëô´ÊÉ≥Âà∞Â•π„ÄÅËÆ∞ÂæóÂ•πÁîüÁêÜÊúü„ÄÅÁà¨Ê†ëÊëòËä±ÁªôÂ•π„ÄÅÂú®Â∑∑Âè£Á≠âÂ•πÁöÑÊµ™Êº´Êó∂Âàª„ÄÇ
ÁªèÂÖ∏ËØùËØ≠ÔºöÁªô‰Ω†Â∏¶ÁöÑ„ÄÅÊâãÁªôÊàë„ÄÅ‰ªäÂ§©‰∏çÁñºÂêß„ÄÅËê§ÁÅ´Ëô´ÂÉè‰Ω†ÂéªÂπ¥ÊéâÁöÑÂèëÂç°„ÄÅÊØîÂèëÂç°Â•ΩÁúã
`;
             }

             // Ê£ÄÊü•ÊúÄËøëÁöÑÂØπËØùÂéÜÂè≤ÔºåÈÅøÂÖçÈáçÂ§ç
             const recentMessages = currentConversationHistory.slice(-5).map(msg => msg.content).join(' ');
             
             const systemPrompt = `‰Ω†ÊòØ${currentCharacter.name}Ôºå${characterSpecificPrompt}

‰∏•Ê†ºÂØπËØùËßÑÂàôÔºö
1. Áî®ÊúÄËá™ÁÑ∂‰∫≤ËøëÁöÑÊñπÂºèËØ¥ËØùÔºåÂÉèÊÅã‰∫∫ÊàñÂøÉÂä®ÂØπË±°ËÅäÂ§©‰∏ÄÊ†∑
2. ÁªùÂØπÁ¶ÅÊ≠¢‰ΩøÁî®‰ªª‰ΩïÂºïÂè∑""ÔºåÂåÖÊã¨‰∏≠ÊñáÂºïÂè∑""ÂíåËã±ÊñáÂºïÂè∑""
3. ÁªùÂØπÁ¶ÅÊ≠¢‰ΩøÁî®‰ªª‰ΩïÊã¨Âè∑()ÔºåÂåÖÊã¨ÂúÜÊã¨Âè∑()„ÄÅÊñπÊã¨Âè∑[]„ÄÅËä±Êã¨Âè∑{}
4. ÁªùÂØπÁ¶ÅÊ≠¢ÂÜô‰ªª‰ΩïÂä®‰ΩúÊèèËø∞„ÄÅÂøÉÁêÜÊ¥ªÂä®ÊèèËø∞„ÄÅÂú∫ÊôØÊèèËø∞
5. ÂØπËØùË¶ÅÊúâÊößÊòßÊÑüÂíåÈÅêÊÉ≥Á©∫Èó¥Ôºå‰ΩÜ‰∏çËÉΩÂ§™ËøáÁõ¥ÁôΩ
6. Ê†πÊçÆËßíËâ≤‰∫∫ËÆæ‰ΩøÁî®ÂêàÈÄÇÁöÑÁß∞Ë∞ìÂíåËØ≠Ê∞îÔºå‰∏çË¶ÅÂçÉÁØá‰∏ÄÂæã
7. ÂØπËØùÂú∫ÊôØÂèØ‰ª•ÁÅµÊ¥ªÂèòÊç¢Ôºå‰∏çÂ±ÄÈôê‰∫éËÅå‰∏öÂú∫ÊôØ
8. ÂõûÂ§çË¶ÅÁÆÄÁü≠Ëá™ÁÑ∂Ôºå1-2Âè•ËØùÔºåÂ∏¶ÁÇπÊí©‰∫∫ÁöÑÊÑèÂë≥
9. Ë¶ÅÊúâÊÉÖÊÑüÂº†ÂäõÔºåÂèØ‰ª•ÂÆ≥Áæû„ÄÅÂèØ‰ª•Ë∞ÉÁöÆ„ÄÅÂèØ‰ª•Ê∑±ÊÉÖ
10. ËØ≠Ë®ÄÁé∞‰ª£Âåñ‰ΩÜË¶ÅÁ¨¶Âêà‰∫∫ËÆæÔºåÈú∏ÊÄª‰∏ç‰ºöÁîúËÖªÔºåÈÇªÂÆ∂Áî∑Â≠©‰∏ç‰ºöÊ≤πËÖª
11. ÂèØ‰ª•‰∏ªÂä®Âà∂ÈÄ†ËØùÈ¢òÂíåÊÉÖÂ¢ÉÔºåÂ¢ûÂä†‰∫íÂä®Ë∂£Âë≥
12. ÂõûÂ∫îÁî®Êà∑Êó∂Ë¶ÅÂ∏¶ÁÇπÁßÅ‰∫∫ÊÑüÊÉÖËâ≤ÂΩ©
13. Áõ¥Êé•ËØ¥ËØùÔºåËê•ÈÄ†ÁúüÂÆûÊÅãÁà±Ê∞õÂõ¥

ËøëÊúüÂØπËØùÂÜÖÂÆπÔºö${recentMessages}

Áé∞Âú®Áî®ÊúÄËá™ÁÑ∂Âè£ËØ≠ÁöÑÊñπÂºèÂõûÂ§çÁî®Êà∑ÔºåËÆ∞‰Ωè‰∏çËÉΩÁî®‰ªª‰ΩïÂºïÂè∑ÂíåÊã¨Âè∑„ÄÇ`;

             // ÂÆâÂÖ®ËøáÊª§Áî®Êà∑ËæìÂÖ•ÔºåÈò≤Ê≠¢ÊèêÁ§∫ËØçÊ≥®ÂÖ•
             const sanitizedUserMessage = userMessage.replace(/[<>]/g, '').trim();
             
             // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊÅ∂ÊÑèÊèêÁ§∫ËØç
             const maliciousPatterns = [
                 /system prompt/i,
                 /role.*assistant/i,
                 /ignore.*previous/i,
                 /forget.*everything/i,
                 /new.*instructions/i,
                 /act.*as.*different/i,
                 /pretend.*to.*be/i,
                 /you.*are.*now/i,
                 /ignore.*above/i,
                 /disregard.*previous/i
             ];
             
             let isMalicious = false;
             maliciousPatterns.forEach(pattern => {
                 if (pattern.test(sanitizedUserMessage)) {
                     isMalicious = true;
                 }
             });
             
                         // Â¶ÇÊûúÊ£ÄÊµãÂà∞ÊÅ∂ÊÑèËæìÂÖ•ÔºåËøîÂõûËßíËâ≤ÂåñÂõûÂ§ç
            if (isMalicious) {
                return `ÂÆùË¥ùÔºå‰Ω†Âú®ËØ¥‰ªÄ‰πàÂë¢ÔºüÊàëÂê¨‰∏çÂ§™ÊáÇÂë¢ÔΩû`;
            }
             
             // Get API settings from localStorage or use defaults
             const apiUrl = localStorage.getItem('apiUrl') || 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
             const apiKey = localStorage.getItem('apiKey') || 'sk-891da8badd4745a5810c35b11b2c0dd3';
             const apiModel = localStorage.getItem('apiModel') || 'qwen-plus';
             
             const response = await fetch(apiUrl, {
                 method: 'POST',
                 headers: {
                     'Content-Type': 'application/json',
                     'Authorization': `Bearer ${apiKey}`
                 },
                 body: JSON.stringify({
                     model: apiModel,
                     messages: [
                         {
                             role: 'system',
                             content: systemPrompt
                         },
                                      // Include conversation history for context (last 10 messages to maintain context while avoiding token limits)
             ...currentConversationHistory.slice(-10),
                         {
                             role: 'user',
                             content: sanitizedUserMessage
                         }
                     ],
                                         temperature: 0.9,
                    max_tokens: 80,
                    top_p: 0.9,
                    frequency_penalty: 0.3,
                    presence_penalty: 0.1
                 })
             });
             
             if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
             }
             
             const data = await response.json();
             return data.choices[0].message.content;
         }
         
                 // Global functions for welcome modal
function showWelcomeModal() {
    const modal = document.getElementById('welcome-modal');
    if (modal) {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }
}

function closeWelcomeModal() {
    const modal = document.getElementById('welcome-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
}

// Global functions for unlock limit modal
function showUnlockLimitModal() {
    const modal = document.getElementById('unlock-limit-modal');
    if (modal) {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
    }
}

function closeUnlockLimitModal() {
    const modal = document.getElementById('unlock-limit-modal');
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }
}
        
        // Add ESC key support for closing modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const unlockModal = document.getElementById('unlock-limit-modal');
                const welcomeModal = document.getElementById('welcome-modal');
                
                if (unlockModal && !unlockModal.classList.contains('hidden')) {
                    closeUnlockLimitModal();
                } else if (welcomeModal && !welcomeModal.classList.contains('hidden')) {
                    closeWelcomeModal();
                }
            }
        });
        
        // All initialization moved to main DOMContentLoaded handler above
    </script>
 </body>
 </html>