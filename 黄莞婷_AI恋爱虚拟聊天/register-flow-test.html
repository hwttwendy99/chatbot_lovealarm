<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œæµç¨‹æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: linear-gradient(135deg, #fff0f7 0%, #f0f0ff 50%, #f0fff7 100%);
        }
        
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
            margin-bottom: 20px;
        }
        
        .test-button {
            background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.3);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .test-button.warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .success {
            border-left-color: #28a745;
            background: #d4edda;
        }
        
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
        }
        
        .iframe-container {
            width: 100%;
            height: 700px;
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .step {
            text-align: center;
            flex: 1;
            padding: 10px;
            margin: 0 5px;
            border-radius: 5px;
            background: #e9ecef;
            color: #6c757d;
        }
        
        .step.active {
            background: #007bff;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª æ³¨å†Œæµç¨‹æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢å°†æµ‹è¯•å®Œæ•´çš„æ³¨å†Œæµç¨‹ï¼šç‚¹å‡»æ³¨å†Œé“¾æ¥ â†’ è¿›å…¥æ³¨å†Œé¡µé¢ â†’ å¡«å†™ä¿¡æ¯ â†’ æäº¤æ³¨å†Œ â†’ å­˜å‚¨ç”¨æˆ·ä¿¡æ¯</p>
        
        <div class="step-indicator">
            <div class="step" id="step1">æ­¥éª¤1: ç‚¹å‡»æ³¨å†Œé“¾æ¥</div>
            <div class="step" id="step2">æ­¥éª¤2: è¿›å…¥æ³¨å†Œé¡µé¢</div>
            <div class="step" id="step3">æ­¥éª¤3: å¡«å†™æ³¨å†Œä¿¡æ¯</div>
            <div class="step" id="step4">æ­¥éª¤4: æäº¤æ³¨å†Œ</div>
            <div class="step" id="step5">æ­¥éª¤5: éªŒè¯å­˜å‚¨</div>
        </div>
        
        <div>
            <button class="test-button" onclick="startRegisterFlowTest()">å¼€å§‹æ³¨å†Œæµç¨‹æµ‹è¯•</button>
            <button class="test-button success" onclick="testRegisterLink()">æµ‹è¯•æ³¨å†Œé“¾æ¥</button>
            <button class="test-button warning" onclick="testRegistrationForm()">æµ‹è¯•æ³¨å†Œè¡¨å•</button>
            <button class="test-button" onclick="verifyUserStorage()">éªŒè¯ç”¨æˆ·å­˜å‚¨</button>
            <button class="test-button" onclick="clearTestData()">æ¸…é™¤æµ‹è¯•æ•°æ®</button>
        </div>
        
        <div id="results"></div>
    </div>
    
    <div class="test-container">
        <h2>ä¸»åº”ç”¨</h2>
        <div class="iframe-container">
            <iframe id="main-app" src="0801chatbot.html"></iframe>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let testResults = [];
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
            
            testResults.push({ message, type, timestamp: new Date() });
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function updateStep(stepNumber, status = 'active') {
            // é‡ç½®æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.className = 'step';
            }
            
            // è®¾ç½®å½“å‰æ­¥éª¤
            const currentStepElement = document.getElementById(`step${stepNumber}`);
            currentStepElement.className = `step ${status}`;
            
            // è®¾ç½®å·²å®Œæˆæ­¥éª¤
            for (let i = 1; i < stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.className = 'step completed';
            }
        }
        
        async function startRegisterFlowTest() {
            addResult('ğŸš€ å¼€å§‹æ³¨å†Œæµç¨‹æµ‹è¯•...', 'info');
            updateStep(1);
            
            try {
                // æ­¥éª¤1: æµ‹è¯•æ³¨å†Œé“¾æ¥
                addResult('æ­¥éª¤1: æµ‹è¯•æ³¨å†Œé“¾æ¥...', 'info');
                await testRegisterLink();
                updateStep(1, 'completed');
                updateStep(2);
                
                // æ­¥éª¤2: éªŒè¯æ³¨å†Œé¡µé¢
                addResult('æ­¥éª¤2: éªŒè¯æ³¨å†Œé¡µé¢...', 'info');
                await verifyRegisterPage();
                updateStep(2, 'completed');
                updateStep(3);
                
                // æ­¥éª¤3: å¡«å†™æ³¨å†Œä¿¡æ¯
                addResult('æ­¥éª¤3: å¡«å†™æ³¨å†Œä¿¡æ¯...', 'info');
                await fillRegistrationForm();
                updateStep(3, 'completed');
                updateStep(4);
                
                // æ­¥éª¤4: æäº¤æ³¨å†Œ
                addResult('æ­¥éª¤4: æäº¤æ³¨å†Œ...', 'info');
                await submitRegistration();
                updateStep(4, 'completed');
                updateStep(5);
                
                // æ­¥éª¤5: éªŒè¯ç”¨æˆ·å­˜å‚¨
                addResult('æ­¥éª¤5: éªŒè¯ç”¨æˆ·å­˜å‚¨...', 'info');
                await verifyUserStorage();
                updateStep(5, 'completed');
                
                addResult('âœ… æ³¨å†Œæµç¨‹æµ‹è¯•å®Œæˆï¼', 'success');
                
            } catch (error) {
                addResult('âŒ æ³¨å†Œæµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        async function testRegisterLink() {
            addResult('æµ‹è¯•æ³¨å†Œé“¾æ¥åŠŸèƒ½...', 'info');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow) {
                    // ç­‰å¾…iframeåŠ è½½
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    // æ£€æŸ¥æ³¨å†Œé“¾æ¥æ˜¯å¦å­˜åœ¨
                    const showRegisterLink = iframeWindow.document.getElementById('show-register');
                    if (showRegisterLink) {
                        addResult('âœ… æ³¨å†Œé“¾æ¥å…ƒç´ å­˜åœ¨', 'success');
                        
                        // æ¨¡æ‹Ÿç‚¹å‡»
                        showRegisterLink.click();
                        addResult('âœ… æ³¨å†Œé“¾æ¥å·²ç‚¹å‡»', 'success');
                        
                        // ç­‰å¾…é¡µé¢åˆ‡æ¢
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        return true;
                    } else {
                        addResult('âŒ æ³¨å†Œé“¾æ¥å…ƒç´ ä¸å­˜åœ¨', 'error');
                        return false;
                    }
                } else {
                    addResult('âŒ æ— æ³•è®¿é—®iframeå†…å®¹', 'error');
                    return false;
                }
            } catch (error) {
                addResult('âŒ æµ‹è¯•æ³¨å†Œé“¾æ¥æ—¶å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }
        
        async function verifyRegisterPage() {
            addResult('éªŒè¯æ³¨å†Œé¡µé¢...', 'info');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow) {
                    // æ£€æŸ¥æ³¨å†Œé¡µé¢æ˜¯å¦æ˜¾ç¤º
                    const registerPage = iframeWindow.document.getElementById('register-page');
                    const isVisible = registerPage && !registerPage.classList.contains('hidden');
                    
                    if (isVisible) {
                        addResult('âœ… æ³¨å†Œé¡µé¢å·²æ˜¾ç¤º', 'success');
                        
                        // æ£€æŸ¥æ³¨å†Œè¡¨å•å…ƒç´ 
                        const formElements = [
                            'reg-username',
                            'reg-email', 
                            'reg-password',
                            'reg-password-confirm',
                            'register-form'
                        ];
                        
                        const missingElements = formElements.filter(id => 
                            !iframeWindow.document.getElementById(id)
                        );
                        
                        if (missingElements.length === 0) {
                            addResult('âœ… æ‰€æœ‰æ³¨å†Œè¡¨å•å…ƒç´ éƒ½å­˜åœ¨', 'success');
                            return true;
                        } else {
                            addResult('âŒ ç¼ºå°‘æ³¨å†Œè¡¨å•å…ƒç´ : ' + missingElements.join(', '), 'error');
                            return false;
                        }
                    } else {
                        addResult('âŒ æ³¨å†Œé¡µé¢æœªæ˜¾ç¤º', 'error');
                        return false;
                    }
                } else {
                    addResult('âŒ æ— æ³•è®¿é—®iframeå†…å®¹', 'error');
                    return false;
                }
            } catch (error) {
                addResult('âŒ éªŒè¯æ³¨å†Œé¡µé¢æ—¶å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }
        
        async function fillRegistrationForm() {
            addResult('å¡«å†™æ³¨å†Œä¿¡æ¯...', 'info');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow) {
                    // ç”Ÿæˆæµ‹è¯•ç”¨æˆ·å
                    const testUsername = 'testuser' + Date.now();
                    const testEmail = testUsername + '@test.com';
                    const testPassword = 'test123';
                    
                    // å¡«å†™è¡¨å•
                    const usernameInput = iframeWindow.document.getElementById('reg-username');
                    const emailInput = iframeWindow.document.getElementById('reg-email');
                    const passwordInput = iframeWindow.document.getElementById('reg-password');
                    const confirmInput = iframeWindow.document.getElementById('reg-password-confirm');
                    
                    if (usernameInput && emailInput && passwordInput && confirmInput) {
                        usernameInput.value = testUsername;
                        emailInput.value = testEmail;
                        passwordInput.value = testPassword;
                        confirmInput.value = testPassword;
                        
                        // è§¦å‘è¾“å…¥äº‹ä»¶
                        [usernameInput, emailInput, passwordInput, confirmInput].forEach(input => {
                            input.dispatchEvent(new Event('input', { bubbles: true }));
                        });
                        
                        addResult(`âœ… æ³¨å†Œä¿¡æ¯å·²å¡«å†™: ${testUsername}`, 'success');
                        
                        // ä¿å­˜æµ‹è¯•æ•°æ®ä¾›åç»­éªŒè¯
                        window.testRegistrationData = {
                            username: testUsername,
                            email: testEmail,
                            password: testPassword
                        };
                        
                        return true;
                    } else {
                        addResult('âŒ æ³¨å†Œè¡¨å•å…ƒç´ ä¸å­˜åœ¨', 'error');
                        return false;
                    }
                } else {
                    addResult('âŒ æ— æ³•è®¿é—®iframeå†…å®¹', 'error');
                    return false;
                }
            } catch (error) {
                addResult('âŒ å¡«å†™æ³¨å†Œä¿¡æ¯æ—¶å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }
        
        async function submitRegistration() {
            addResult('æäº¤æ³¨å†Œè¡¨å•...', 'info');
            
            try {
                const iframe = document.getElementById('main-app');
                const iframeWindow = iframe.contentWindow;
                
                if (iframeWindow) {
                    // æäº¤æ³¨å†Œè¡¨å•
                    const registerForm = iframeWindow.document.getElementById('register-form');
                    if (registerForm) {
                        registerForm.dispatchEvent(new Event('submit', { bubbles: true }));
                        addResult('âœ… æ³¨å†Œè¡¨å•å·²æäº¤', 'success');
                        
                        // ç­‰å¾…æ³¨å†Œå¤„ç†
                        await new Promise(resolve => setTimeout(resolve, 3000));
                        
                        return true;
                    } else {
                        addResult('âŒ æ³¨å†Œè¡¨å•ä¸å­˜åœ¨', 'error');
                        return false;
                    }
                } else {
                    addResult('âŒ æ— æ³•è®¿é—®iframeå†…å®¹', 'error');
                    return false;
                }
            } catch (error) {
                addResult('âŒ æäº¤æ³¨å†Œæ—¶å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }
        
        async function verifyUserStorage() {
            addResult('éªŒè¯ç”¨æˆ·å­˜å‚¨...', 'info');
            
            try {
                const testData = window.testRegistrationData;
                if (!testData) {
                    addResult('âŒ æ²¡æœ‰æµ‹è¯•æ•°æ®', 'error');
                    return false;
                }
                
                // æ£€æŸ¥localStorageä¸­çš„ç”¨æˆ·æ•°æ®
                const users = JSON.parse(localStorage.getItem('chatbot_users') || '{}');
                const user = users[testData.username];
                
                if (user) {
                    addResult('âœ… ç”¨æˆ·æ•°æ®å·²å­˜å‚¨', 'success');
                    addResult(`ç”¨æˆ·å: ${user.username}`, 'info');
                    addResult(`é‚®ç®±: ${user.email}`, 'info');
                    addResult(`è§’è‰²: ${user.role}`, 'info');
                    addResult(`åˆ›å»ºæ—¶é—´: ${user.createdAt}`, 'info');
                    
                    // æ£€æŸ¥å½“å‰ç”¨æˆ·
                    const currentUser = JSON.parse(localStorage.getItem('chatbot_current_user') || 'null');
                    if (currentUser && currentUser.username === testData.username) {
                        addResult('âœ… ç”¨æˆ·å·²è‡ªåŠ¨ç™»å½•', 'success');
                    } else {
                        addResult('âš ï¸ ç”¨æˆ·æœªè‡ªåŠ¨ç™»å½•', 'warning');
                    }
                    
                    return true;
                } else {
                    addResult('âŒ ç”¨æˆ·æ•°æ®æœªå­˜å‚¨', 'error');
                    return false;
                }
            } catch (error) {
                addResult('âŒ éªŒè¯ç”¨æˆ·å­˜å‚¨æ—¶å‡ºé”™: ' + error.message, 'error');
                return false;
            }
        }
        
        function clearTestData() {
            addResult('æ¸…é™¤æµ‹è¯•æ•°æ®...', 'info');
            
            // æ¸…é™¤localStorageä¸­çš„æµ‹è¯•ç”¨æˆ·
            const users = JSON.parse(localStorage.getItem('chatbot_users') || '{}');
            const testUsers = Object.keys(users).filter(username => username.startsWith('testuser'));
            
            testUsers.forEach(username => {
                delete users[username];
                addResult(`å·²åˆ é™¤æµ‹è¯•ç”¨æˆ·: ${username}`, 'info');
            });
            
            localStorage.setItem('chatbot_users', JSON.stringify(users));
            addResult('âœ… æµ‹è¯•æ•°æ®å·²æ¸…é™¤', 'success');
            
            // æ¸…é™¤æµ‹è¯•æ•°æ®å˜é‡
            delete window.testRegistrationData;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            addResult('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•æ³¨å†Œæµç¨‹', 'info');
            updateStep(1);
        };
    </script>
</body>
</html> 